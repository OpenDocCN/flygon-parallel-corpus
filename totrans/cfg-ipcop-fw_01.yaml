- en: Chapter 1. Introduction to Firewalls
  id: totrans-0
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 第1章 防火墙简介
- en: In this chapter, we will introduce some firewalling and networking concepts
    in enough detail to provide a refresher to those who've encountered them already,
    but in as minimal a fashion as possible, since understanding networking concepts
    is not the focus of this book. We feel that some of these concepts are important,
    and that a broader picture of how these technologies are used and where they come
    from serves to better our understanding of the way in which IT works—however,
    for the reader who is challenged for time, we have tried, wherever possible, to
    provide *italicized* summaries of the knowledge that we feel is important to have
    about these concepts.
  id: totrans-1
  prefs: []
  type: TYPE_NORMAL
  zh: 在本章中，我们将介绍一些防火墙和网络概念，以足够的细节为那些已经遇到过它们的人提供一个复习，但尽可能地以最简洁的方式，因为理解网络概念并不是本书的重点。我们认为其中一些概念很重要，了解这些技术的使用方式和来源有助于更好地理解IT的工作方式，但对于时间紧张的读者，我们已经尽可能提供了对这些概念重要性的*斜体*总结。
- en: Don't worry if you don't understand all of the concepts we discuss—equally,
    readers more comfortable with networking concepts should be able to skip ahead.
    IPCop makes explicit understanding of many of these concepts irrelevant, as it
    attempts to make administration simple and automated wherever possible. However,
    if you do feel inclined to learn about these topics in more depth, the introduction
    given here and some of the URLs and links to other resources that we provide should
    hopefully be of use. Understanding networking, routing, and how some common protocols
    work, although not a requirement, will also help you immeasurably if you intend
    to keep working with systems such as IPCop on a regular basis.
  id: totrans-2
  prefs: []
  type: TYPE_NORMAL
  zh: 如果您不理解我们讨论的所有概念，不要担心，同样，对网络概念更熟悉的读者应该能够跳过。IPCop使许多这些概念的明确理解变得无关紧要，因为它试图尽可能简化和自动化管理。然而，如果您确实有兴趣更深入地了解这些主题，这里提供的介绍以及我们提供的一些URL和其他资源的链接应该会有所帮助。了解网络、路由以及一些常见协议的工作原理，虽然不是必需的，但如果您打算经常使用IPCop等系统，这也将对您有所帮助。
- en: An Introduction to (TCP/IP) Networking
  id: totrans-3
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 网络防火墙入门
- en: During the early 1970s, as data networks became more common, the number of different
    ways in which to build them increased exponentially. To a number of people, the
    concept of *internetworking* (IBM *TCP/IP Tutorial and Technical Overview, Martin
    W. Murhammer, Orcun Atakan, Stefan Bretz, Larry R. Pugh, Kazunari Suzuki, David
    H. Wood, October 1998, pp3)*, or *connecting multiple networks to each other*,
    became extremely important as connecting together disparate and contrasting networks
    built around different sets of technology started causing pain.
  id: totrans-4
  prefs: []
  type: TYPE_NORMAL
  zh: 在20世纪70年代初，随着数据网络变得更加普遍，构建它们的方式也呈指数级增长。对于许多人来说，*互联网*（IBM *TCP/IP教程和技术概述，Martin
    W. Murhammer，Orcun Atakan，Stefan Bretz，Larry R. Pugh，Kazunari Suzuki，David H.
    Wood，1998年10月，第3页）或*将多个网络连接在一起*的概念变得极为重要，因为连接不同的、相互对立的网络开始引起痛苦。
- en: A protocol, within the context of IT and Computer Science, is generally speaking
    a common format in which computers interchange data for a certain purpose. In
    networking, a protocol is best compared to a language—the networking situation
    in the 1970s was one in which there were many different languages and very few
    interpreters readily available to translate for people.
  id: totrans-5
  prefs: []
  type: TYPE_NORMAL
  zh: 在IT和计算机科学的背景下，协议通常是指计算机为特定目的交换数据的常见格式。在网络中，协议最好比作一种语言——20世纪70年代的网络情况是存在许多不同的语言，但很少有翻译器可以为人们进行翻译。
- en: The resulting research, and most importantly that carried out and funded by
    the American Department of Defense's *Defense Advanced Research Projects Agency*
    ([http://www.darpa.mil](http://www.darpa.mil)), gave birth not only to a range
    of network *protocols* designed for interoperability (that is to say, in order
    to allow easy, platform-neutral communications between a range of devices), but
    a network, **ARPANet,** set up for this express purpose. The best comparison for
    this within language is the development of the language *Esperanto*—although the
    proliferation of this *international* language has been fairly minimal, computers
    have the advantage of not taking years to learn a particular protocol!
  id: totrans-6
  prefs: []
  type: TYPE_NORMAL
  zh: 美国国防部的*国防高级研究计划局*（[http://www.darpa.mil](http://www.darpa.mil)）进行的研究，尤其是由其资助的研究，不仅产生了一系列旨在实现互操作性的网络*协议*（也就是说，为了实现设备之间的轻松、平台中立的通信），还建立了一个名为**ARPANet**的网络，专门用于这一目的。在语言方面，最好的比较是发展出国际语言*世界语*的发展——尽管这种*国际*语言的传播相当有限，但计算机有一个优势，那就是不需要花费数年时间学习特定的协议！
- en: This ARPANet was first experimented with using TCP/IP in 1976, and in January
    of 1983, its use was mandated for all computers participating in the network.
    By the late 1970s, many organizations besides the military were granted access
    to the ARPANet as well, such as NASA, the **National Science Foundation** (**NSF**),
    and eventually universities and other academic entities.
  id: totrans-7
  prefs: []
  type: TYPE_NORMAL
  zh: ARPANet在1976年首次尝试使用TCP/IP，到1983年1月，其使用被强制要求适用于网络中的所有计算机。到了20世纪70年代末，除了军方之外，许多其他组织也被允许访问ARPANet，如NASA、**国家科学基金会**（**NSF**），最终还有大学和其他学术实体。
- en: After the military broke away from the ARPANet to form its own, separate network
    for military use (**MILNET**), the network became the responsibility of the NSF,
    which came to create its own high-speed backbone, called **NSFNet**, for the facilitation
    of internetworking.
  id: totrans-8
  prefs: []
  type: TYPE_NORMAL
  zh: 军方从ARPANet中分离出来，建立了自己的独立网络用于军事用途（**MILNET**），这个网络成为了NSF的责任，后者创建了自己的高速骨干网，称为**NSFNet**，以促进互联网的发展。
- en: When the Acceptable Usage Policy for NSFNet began to permit non-academic traffic,
    the NSFNet began, in combination with other (commercial and private) networks
    (such as those operated via CIX), to form the entity we now know as the Internet.
    By the NSF's exit from the management of the Internet and the shutdown of the
    NSFNet in April 1995, the Internet was populated by an ever-growing population
    of commercial, academic, and private users.
  id: totrans-9
  prefs: []
  type: TYPE_NORMAL
  zh: 当NSFNet的可接受使用政策开始允许非学术流量时，NSFNet开始与其他（商业和私人）网络（如通过CIX运营的网络）结合，形成了我们现在所知的互联网实体。随着NSF退出对互联网的管理和1995年4月关闭NSFNet，互联网被不断增长的商业、学术和私人用户所填满。
- en: The standards upon which the Internet is based have become the staple of modern
    networking, and nowadays when anyone says 'networking' they tend to be referring
    to something built with (and around) **TCP/IP**, the set of layered protocols
    originally developed for use on ARPANet, along with other standards upon which
    TCP/IP is implemented, such as **802.3** or **Ethernet,** which defines how one
    of the most popular standards over which TCP/IP runs across in network segments
    works.
  id: totrans-10
  prefs: []
  type: TYPE_NORMAL
  zh: 互联网所基于的标准已经成为现代网络的基石，如今当有人提到“网络”时，他们往往指的是建立在（和周围）TCP/IP基础上的东西，这是最初为ARPANet开发的一套分层协议，以及TCP/IP实现的其他标准，如802.3或以太网，它定义了TCP/IP在网络段上运行的最流行的标准之一的工作方式。
- en: These layered protocols, apart from being interesting to us for historical and
    anecdotal reasons, have several important implications for us. The most notable
    implication is that any device built around them is entirely interoperable with
    any other device. The consequence of this, then, is that we can buy networking
    components built by any vendor—our Dell laptop running Microsoft Windows can freely
    communicate, via TCP/IP, over an Ethernet network using a Linksys switch, plugged
    into a Cisco Router, and view a web page hosted on an IBM server running AIX,
    also talking TCP/IP.
  id: totrans-11
  prefs: []
  type: TYPE_NORMAL
  zh: 这些分层协议除了因历史和轶事原因对我们来说很有趣之外，还对我们有一些重要的影响。最显著的影响是，基于它们构建的任何设备都可以与任何其他设备完全互操作。因此，其结果是，我们可以购买任何供应商生产的网络组件——我们的戴尔笔记本电脑运行Microsoft
    Windows可以通过TCP/IP自由通信，在以太网网络上使用Linksys交换机，插入思科路由器，并查看托管在运行AIX的IBM服务器上的网页，也使用TCP/IP进行通信。
- en: More standardized protocols, running on top of TCP/IP, such as HTTP, actually
    carry the information itself, and thanks to the layering of these protocols, we
    can have a vast and disparate set of networks connected that appear transparent
    to devices such as web browsers and web servers, that speak protocols such as
    HTTP. Between our Dell laptop and our IBM server, we may have a dial-up connection,
    a frame relay network segment, a portion of the internet backbone, and a wireless
    network link—none of which concern TCP/IP or HTTP, which sit 'above' these layers
    of the network, and travel freely above them. If only a coach load of children
    on a school tour could use air travel, ferries, cycle paths, and cable cars, all
    without stepping from their vehicle or being aware of the changing transport medium
    beneath them! Layered communication of the type that TCP/IP is capable of in this
    sense is incredibly powerful and really allows our communications infrastructure
    to scale.
  id: totrans-12
  prefs: []
  type: TYPE_NORMAL
  zh: 运行在TCP/IP之上的更多标准化协议，如HTTP，实际上携带着信息本身，由于这些协议的分层，我们可以连接一个庞大而不同的网络集合，对于像Web浏览器和Web服务器这样的设备来说，这些网络看起来是透明的，它们使用HTTP等协议进行通信。在我们的戴尔笔记本电脑和IBM服务器之间，我们可能有一个拨号连接，一个帧中继网络段，互联网骨干的一部分，以及一个无线网络链接——这些都与TCP/IP或HTTP无关，它们位于网络的这些层“之上”，并在这些层之上自由传输。如果一辆载满孩子的校车可以使用飞机、渡轮、自行车道和缆车，而不用下车或意识到他们下面的交通工具在变化！TCP/IP在这种意义上所能实现的分层通信是非常强大的，真正使我们的通信基础设施能够扩展。
- en: The Purpose of Firewalls
  id: totrans-13
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 防火墙的目的
- en: This network and the research underpinning it, originally funded based on the
    utility for military purposes in one country, has far surpassed its original aims,
    and through international research and uptake, spawned a phenomenon that is shaping
    (and will shape) generations to come. Networking is now a core activity not just
    to governments and research organizations, but also to companies small and large,
    and even home users. Further developments such as the inception of wireless technology
    have served to make this technology even more accessible (and relevant) to people
    at home, on the go, and in the imminent future, virtually anywhere on the surface
    of the planet!
  id: totrans-14
  prefs: []
  type: TYPE_NORMAL
  zh: 这个网络及其支撑它的研究最初是基于一国军事目的的效用而获得资助的，远远超出了其最初的目标，并通过国际研究和采用，产生了一个正在塑造（并将塑造）未来几代人的现象。网络现在不仅是政府和研究机构的核心活动，也是各种规模的公司，甚至家庭用户的核心活动。无线技术的进一步发展使得这项技术对家庭用户、在外出时以及在不久的将来几乎在地球表面的任何地方都更加易于接触（和相关）！
- en: Many of these networking protocols were originally designed in an environment
    in which the word '*hacker*' had not yet come to have the (negative) meaning that
    it nowadays has, and implemented upon a network in which there was a culture of
    mutual trust and respect. **IPv4**, the foundation of all communications via the
    Internet (and the majority of private networks) and **SMTP** (the protocol used
    to send electronic mail and relay it from to server to server) are two prime examples
    of this. Neither protocol, in its initial incarnation, was designed with features
    designed to maintain the three qualities that nowadays are synonymous with effective
    communication, **Confidentiality, Integrity**, and **Availability** (called the
    **CIA triad**). The CIA triad is often defined as the aim of information security—
    [http://en.wikipedia.org/wiki/CIA_triad](http://en.wikipedia.org/wiki/CIA_triad).
    *Spam* and *Denial of Service attacks* are just two examples of (malicious) exploitations
    of some of the weaknesses in these two protocols.
  id: totrans-15
  prefs: []
  type: TYPE_NORMAL
  zh: 许多这些网络协议最初是在一个词“*黑客*”还没有具有（负面）含义的环境中设计的，并且是在一个相互信任和尊重的文化网络上实施的。**IPv4**，作为通过互联网进行所有通信的基础（以及大多数私人网络），以及**SMTP**（用于发送电子邮件并将其从一个服务器中继到另一个服务器的协议）是这一点的两个主要例子。这两种协议的初始版本都没有设计用于维护现在与有效通信同义的三个特性**保密性、完整性**和**可用性**（称为**CIA三位一体**）。CIA三位一体通常被定义为信息安全的目标-
    [http://en.wikipedia.org/wiki/CIA_triad](http://en.wikipedia.org/wiki/CIA_triad)。*垃圾邮件*和*拒绝服务攻击*只是这两种协议中一些弱点的（恶意）利用的两个例子。
- en: As networking technologies grew and were adopted by governments and large organizations
    that relied upon them, the need for these three qualities increased, and network
    firewalls became a necessity. In short, the need for *network security* sprung
    into existence. The Internet has come a long way too from its humble beginnings.
    As the barrier for entry has decreased, and knowledge of the technologies underpinning
    it has become more accessible, it has become a decreasingly friendly place.
  id: totrans-16
  prefs: []
  type: TYPE_NORMAL
  zh: 随着网络技术的发展和被政府和依赖于它们的大型组织采用，对这三种特性的需求增加了，网络防火墙成为了必需品。简而言之，*网络安全*的需求应运而生。互联网也已经走过了很长的路。随着准入门槛的降低，以及支撑它的技术知识变得更加易于获取，它变得越来越不友好。
- en: With growing reliance on the Internet for communications, firewalls have, at
    time of writing, become almost universally deployed as a primary line of defense
    against unauthorized network activity, automated attacks, and inside abuse. They
    are deployed everywhere, and the term 'firewall' is used in this context to refer
    to anything from a software stack built into commonly used operating systems (such
    as the *Windows firewall* built into Service Pack 2 of Microsoft's Windows Operating
    System ([http://www.microsoft.com/windowsxp/using/security/internet/sp2_wfintro.mspx](http://www.microsoft.com/windowsxp/using/security/internet/sp2_wfintro.mspx)))
    protecting only the computer it is running on, to devices costing significant
    sums of money deployed in banks, datacenters, and government facilities (such
    as Cisco's PIX line of firewall products ([http://www.cisco.com/en/US/products/hw/vpndevc/ps2030/](http://www.cisco.com/en/US/products/hw/vpndevc/ps2030/))).
    Such high-end devices may govern and restrict network traffic between hundreds
    of thousands of individual computers.
  id: totrans-17
  prefs: []
  type: TYPE_NORMAL
  zh: 随着人们越来越依赖互联网进行通信，防火墙已经几乎成为了防止未经授权的网络活动、自动攻击和内部滥用的主要防线。它们被部署在各个地方，术语“防火墙”在这个语境中用来指代从内置到常用操作系统（如微软的Windows操作系统Service
    Pack 2中内置的*Windows防火墙* ([http://www.microsoft.com/windowsxp/using/security/internet/sp2_wfintro.mspx](http://www.microsoft.com/windowsxp/using/security/internet/sp2_wfintro.mspx)）只保护其运行的计算机，到在银行、数据中心和政府设施中部署的耗资巨大的设备（如思科的PIX系列防火墙产品([http://www.cisco.com/en/US/products/hw/vpndevc/ps2030/](http://www.cisco.com/en/US/products/hw/vpndevc/ps2030/))）。这样的高端设备可能管理和限制数十万台个人计算机之间的网络流量。
- en: Given this increase in the use of the term 'firewall', and with so many qualifiers
    added to the word to distinguish between different types of firewall (such as
    the terms stateful, proxy, application, packet filter, hardware, software, circuit-level,
    and many more), it becomes very difficult to know what someone means when they
    tell you that their network "has a firewall". Our exploration of IPCop, therefore,
    must begin with an exploration of what a firewall actually is, and armed with
    this knowledge, we can then relate IPCop to this knowledge and understand what
    function it is that IPCop can fulfill for us.
  id: totrans-18
  prefs: []
  type: TYPE_NORMAL
  zh: 鉴于“防火墙”一词的使用增加，并且在词中添加了许多限定词以区分不同类型的防火墙（如有状态、代理、应用、数据包过滤、硬件、软件、电路级等术语），当有人告诉你他们的网络“有防火墙”时，很难知道他们的意思。因此，我们对IPCop的探索必须从对防火墙的实际含义的探索开始，掌握了这些知识，我们就可以将IPCop与这些知识联系起来，了解IPCop可以为我们提供什么功能。
- en: In order to improve our network security, we need to first identify the problems
    we need to solve, and determine whether this firewall is the solution to them.
    Implementing a firewall for the sake of satisfying the buzzword requirement is
    a common mistake in security design.
  id: totrans-19
  prefs: []
  type: TYPE_NORMAL
  zh: 为了改善我们的网络安全，我们需要首先确定我们需要解决的问题，并确定这个防火墙是否是解决这些问题的方案。出于满足流行词要求而实施防火墙是安全设计中的一个常见错误。
- en: The term firewall refers, generally, to a collection of technologies and devices
    all designed to do one thing—stop unauthorized network activity. A firewall acts
    as a choke point between more than one network (or network segment), and uses
    a (hopefully) strictly defined set of rules in order to allow, or disallow, certain
    types of traffic to traverse to the other side of the firewall. Most importantly,
    it is a security boundary between two or more networks.
  id: totrans-20
  prefs: []
  type: TYPE_NORMAL
  zh: 防火墙一词通常指的是一系列旨在做一件事的技术和设备-阻止未经授权的网络活动。防火墙充当了一个以上网络（或网络段）之间的瓶颈，并使用（希望）严格定义的一组规则，以允许或禁止某些类型的流量穿过防火墙的另一侧。最重要的是，它是两个或多个网络之间的安全边界。
- en: '![The Purpose of Firewalls](img/1361_01_01.jpg)'
  id: totrans-21
  prefs: []
  type: TYPE_IMG
  zh: 防火墙的目的
- en: In the diagram above, a web server connected to the Internet is protected by
    a firewall, which sits in between it and the Internet, filtering all incoming
    and outgoing traffic. In this scenario, illegitimate traffic from the attacker
    is blocked by the firewall. This could be for any number of reasons, such as the
    service the attacker has attempted to connect is blocked by the firewall from
    the Internet, because the attacker's network address is blacklisted, or because
    the type of traffic the attacker is sending is recognized by the firewall as being
    part of a Denial of Service attack.
  id: totrans-22
  prefs: []
  type: TYPE_NORMAL
  zh: 在上图中，连接到互联网的Web服务器受到防火墙的保护，防火墙位于它和互联网之间，过滤所有进出流量。在这种情况下，防火墙阻止了攻击者的非法流量。这可能是由于多种原因，比如防火墙从互联网上阻止了攻击者尝试连接的服务，因为攻击者的网络地址被列入黑名单，或者因为防火墙识别到攻击者发送的流量是拒绝服务攻击的一部分。
- en: In this scenario, the network that the web server sits on (which in a scenario
    such as this would probably contain multiple web servers) is segmented from the
    Internet by the firewall, effectively implementing a security policy dictating
    *what* can go from one network (or collection of networks) to the other. If our
    firewall disallowed the attacker from connecting to a file-sharing port on the
    web server, for instance, while the 'user' was free to access the web server on
    port 80, the other servers behind the firewall might be allowed access to the
    file sharing ports in order to synchronize content or make backups.
  id: totrans-23
  prefs: []
  type: TYPE_NORMAL
  zh: 在这种情况下，Web服务器所在的网络（在这种情况下可能包含多个Web服务器）被防火墙与互联网隔离，有效地实施了一个安全策略，规定了从一个网络（或一组网络）到另一个网络可以传输*什么*。例如，如果我们的防火墙禁止攻击者连接到Web服务器上的文件共享端口，而“用户”可以自由访问端口80上的Web服务器，那么防火墙后面的其他服务器可能被允许访问文件共享端口以同步内容或进行备份。
- en: Layered protocols are generally explained using the **Open System Interconnection**
    (**OSI**) layers. Knowledge of this is extremely useful to anyone working in networking
    or with firewalls in particular, as so many of the concepts pertaining to it require
    knowledge of the way in which this layering works.
  id: totrans-24
  prefs: []
  type: TYPE_NORMAL
  zh: 分层协议通常使用**开放系统互连**（**OSI**）层来解释。对于任何在网络或特别是防火墙中工作的人来说，对此的了解是非常有用的，因为与之相关的许多概念都需要了解这种分层工作方式。
- en: The OSI layers divide traffic and data into seven layers each of which in theory
    falls into a protocol. Although excellent in theory, networking and IT applications
    do not always strictly adhere to the OSI Layers, and it is worth considering them
    to be guidelines rather than a strict framework. That said, they are extremely
    useful for visualizing connectivity, and in general the vision of layers, each
    utilizing hardware and software designed by different vendors, each interoperating
    with the layers above and below is not unrealistic.
  id: totrans-25
  prefs: []
  type: TYPE_NORMAL
  zh: OSI层将流量和数据分为七层，每一层理论上都属于一个协议。尽管在理论上很好，但网络和IT应用并不总是严格遵守OSI层，因此值得将其视为指导方针而不是严格的框架。尽管如此，它们对于可视化连接非常有用，通常每一层都使用不同厂商设计的硬件和软件，与上下层进行互操作并不是不切实际的。
- en: The OSI Model
  id: totrans-26
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: OSI模型
- en: 'The OSI model is shown in the following figure:'
  id: totrans-27
  prefs: []
  type: TYPE_NORMAL
  zh: OSI模型如下图所示：
- en: '![The OSI Model](img/1361_01_02.jpg)'
  id: totrans-28
  prefs: []
  type: TYPE_IMG
  zh: '![OSI模型](img/1361_01_02.jpg)'
- en: 'Layer 1: The Physical Layer'
  id: totrans-29
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 第1层：物理层
- en: The physical layer encompasses the physical medium on which a network is built.
    Specifications that operate within the physical layer include physical interfaces
    such as ports, voltages, pin specifications, cable design, and materials. A **network
    hub is** a layer-one device.
  id: totrans-30
  prefs: []
  type: TYPE_NORMAL
  zh: 物理层包括构建网络的物理介质。在物理层内运行的规范包括物理接口，如端口、电压、引脚规范、电缆设计和材料。**网络集线器**是一个第一层设备。
- en: 'Layer 2: The Data Link Layer'
  id: totrans-31
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 第2层：数据链路层
- en: The data link layer provides connectivity between hosts on the same network
    segment. **MAC** addresses are used at the physical layer to distinguish between
    different physical network adapters and allow them to communicate. **Ethernet**
    is a layer-two standard.
  id: totrans-32
  prefs: []
  type: TYPE_NORMAL
  zh: 数据链路层在同一网络段上的主机之间提供连接。**MAC**地址在物理层上用于区分不同的物理网络适配器，并允许它们进行通信。**以太网**是一个第二层的标准。
- en: 'Layer 3: The Network Layer'
  id: totrans-33
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 第3层：网络层
- en: The network layer provides connectivity between hosts on different networks,
    and it is at this layer that routing occurs. **Internet Protocol** (**IP**) and
    **Address Resolution Protocol** (**ARP**) exist at this layer. ARP serves an important
    purpose, as it intermediates between layer two and layer three by ascertaining
    the layer-two (MAC) address for a given layer-three (IP) address.
  id: totrans-34
  prefs: []
  type: TYPE_NORMAL
  zh: 网络层在不同网络上的主机之间提供连接，并且在这一层进行路由。**Internet Protocol**（**IP**）和**Address Resolution
    Protocol**（**ARP**）存在于这一层。ARP具有重要作用，因为它通过确定给定层三（IP）地址的层二（MAC）地址来在第二层和第三层之间进行中介。
- en: 'Layer 4: The Transport Layer'
  id: totrans-35
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 第4层：传输层
- en: The transport layer, generally, acts as the layer that ensures data integrity.
    **TCP**, the protocol most frequently used at this layer, is a **stateful** protocol
    that, by maintaining connections with a remote host, can retransmit data that
    does not reach the destination. **UDP**, another (slightly less common) protocol
    also operates at this layer, but is not stateful—each message it sends is not
    part of a 'connection' as such, and is treated as entirely separate to a reply
    (if one is required) or any messages previously passed between two hosts.
  id: totrans-36
  prefs: []
  type: TYPE_NORMAL
  zh: 传输层通常作为确保数据完整性的层。**TCP**是在这一层最常用的协议，它是一个**有状态**的协议，通过与远程主机保持连接，可以重新传输未到达目的地的数据。**UDP**是另一个（稍微不太常见）在这一层操作的协议，但它不是有状态的——它发送的每条消息都不是作为一个“连接”的一部分，并且被视为与回复（如果需要）或之前在两个主机之间传递的任何消息完全分开。
- en: Note
  id: totrans-37
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 注意
- en: '**IP, TCP/IP, UDP, and other Layer four protocols**'
  id: totrans-38
  prefs: []
  type: TYPE_NORMAL
  zh: '**IP、TCP/IP、UDP和其他第四层协议**'
- en: As we can see from the examination of the OSI Layers, TCP is a protocol running
    on top of IP, forming the abbreviation TCP/IP. Unfortunately, when people use
    the term TCP/IP, this specific pair of protocols is not always what they mean—the
    'TCP/IP Protocol Suite' is quite frequently defined to be IP, TCP, and other protocols
    such as UDP and ICMP that are used along with it. This is a distinction that it
    is worth being aware of, and which is particularly common amongst IT professionals,
    and in the documentation for operating systems such as Microsoft's Windows.
  id: totrans-39
  prefs: []
  type: TYPE_NORMAL
  zh: 从对OSI层的考察中，我们可以看到TCP是在IP之上运行的协议，形成了TCP/IP的缩写。不幸的是，当人们使用术语TCP/IP时，并不总是指的是这一对特定的协议——“TCP/IP协议套件”经常被定义为IP、TCP以及与之一起使用的UDP和ICMP等其他协议。这是一个值得注意的区别，尤其是在IT专业人员中很常见，在操作系统的文档中也很常见，比如微软的Windows。
- en: 'Layer 5: The Session Layer'
  id: totrans-40
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 第5层：会话层
- en: The upper three layers in the OSI model are no longer concerned with (inter-)
    networking issues as such, and have more to do with the practicalities of software
    and applications that use connectivity. The session layer is where mechanisms
    for setting up sessions live, such as the **NetBIOS** protocol.
  id: totrans-41
  prefs: []
  type: TYPE_NORMAL
  zh: OSI模型中的最后三层不再关注（互联）网络问题，而更多地涉及使用连接的软件和应用的实际问题。会话层是建立会话的机制所在，比如**NetBIOS**协议。
- en: 'Layer 6: The Presentation Layer'
  id: totrans-42
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 第6层：表示层
- en: The presentation layer handles data-specific issues such as encoding, compression,
    and encryption. **SNMP** and **XML** are standards often used, which exist at
    this layer.
  id: totrans-43
  prefs: []
  type: TYPE_NORMAL
  zh: 表示层处理与数据特定问题，如编码、压缩和加密。**SNMP**和**XML**通常是在这一层存在的标准。
- en: 'Layer 7: The Application Layer'
  id: totrans-44
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 第7层：应用层
- en: The application layer is the layer at which common protocols used for communication
    live, such as **HTTP, FTP**, and **SMTP**.
  id: totrans-45
  prefs: []
  type: TYPE_NORMAL
  zh: 应用层是常用于通信的协议所在的层，比如**HTTP、FTP**和**SMTP**。
- en: Generally, Layers three and four, are the ones most commonly dealt with by firewalls,
    with a small (but increasing) number, generally referred to as 'proxy firewalls'
    or 'application-layer firewalls' sitting at layers above this (and being aware
    of protocols like HTTP, DNS, RCP, and NetBIOS). It is worth noting that many firewalls
    (incorrectly) classify all layers above layer three as *application layers*.
  id: totrans-46
  prefs: []
  type: TYPE_NORMAL
  zh: 通常，第三层和第四层是防火墙最常处理的层，还有一小部分（但数量在增加）通常被称为“代理防火墙”或“应用层防火墙”，位于这些层之上（并且了解诸如HTTP、DNS、RCP和NetBIOS等协议）。值得注意的是，许多防火墙（错误地）将第三层以上的所有层都分类为*应用层*。
- en: For our purposes, a thorough understanding (and explanation) of OSI layers and
    some of the more conceptual and technical aspects of networking are unnecessary—although
    we have tried to provide some outline of these, this is more for familiarity and
    in order to give you some idea as to what you may want to learn in future.
  id: totrans-47
  prefs: []
  type: TYPE_NORMAL
  zh: 对于我们的目的来说，对OSI层的深入理解（和解释）以及一些更概念性和技术性的网络方面是不必要的——尽管我们已经试图提供了一些概述，但这更多是为了熟悉和为了给你一些你可能想要在将来学习的想法。
- en: For our purposes a knowledge that layering exists is sufficient. If you feel
    the need (or are otherwise so inclined) to learn more about these topics, some
    of the URLs given in this chapter serve as good starting points for this. You
    don't necessarily have to understand, agree with, or like the OSI layers in order
    to work with firewalls (in fact, many TCP/IP stacks do not strictly adhere to
    segment handling of traffic based on them), but knowing that they exist and understanding
    approximately what they're designed to do and how the technologies built around
    them interact is important to anyone serious about understanding firewalls or
    networking or for anyone who regularly works with these technologies.
  id: totrans-48
  prefs: []
  type: TYPE_NORMAL
  zh: 对于我们的目的来说，知道分层存在就足够了。如果你有需要（或者有兴趣）了解更多关于这些主题的内容，本章中提供的一些URL可以作为很好的起点。你不一定要理解、同意或者喜欢OSI层，才能使用防火墙（事实上，许多TCP/IP堆栈并不严格遵循基于它们的流量处理），但知道它们的存在以及大致了解它们的设计目的以及围绕它们构建的技术如何相互作用，对于任何认真了解防火墙或网络的人，或者经常使用这些技术的人来说都是很重要的。
- en: In many instances, Wikipedia ([http://www.wikipedia.org](http://www.wikipedia.org))
    serves as a good starting reference for technical concepts where the (ostensibly
    well versed in IT) audience of wikipedia really shine at providing comprehensive
    coverage of topics! The wikipedia OSI Layer page is well referenced and has technically
    accurate content. This can be found at [http://en.wikipedia.org/wiki/OSI_seven-layer_model](http://en.wikipedia.org/wiki/OSI_seven-layer_model).
  id: totrans-49
  prefs: []
  type: TYPE_NORMAL
  zh: 在许多情况下，维基百科([http://www.wikipedia.org](http://www.wikipedia.org))是技术概念的很好起始参考，维基百科的受众通常在IT方面很精通，提供了全面的主题覆盖！维基百科的OSI层页面有很好的参考资料和技术上准确的内容。这可以在[http://en.wikipedia.org/wiki/OSI_seven-layer_model](http://en.wikipedia.org/wiki/OSI_seven-layer_model)找到。
- en: Another excellent online resource for information on all things on TCP/IP is
    [http://tcpipguide.com/](http://tcpipguide.com/).
  id: totrans-50
  prefs: []
  type: TYPE_NORMAL
  zh: 另一个关于TCP/IP所有事物信息的优秀在线资源是[http://tcpipguide.com/](http://tcpipguide.com/)。
- en: The IBM "TCP/IP Tutorial and Technical Overview" referenced earlier in this
    chapter, by Martin W. Murhammer, Orcun Atakan, Stefan Bretz, Larry R. Pugh, Kazunari
    Suzuki, and David H. Wood, is another good (and free) guide to the world of TCP/IP
    networking. Although slightly out of date (the last iteration was published in
    October 1998), many of the standards surrounding TCP/IP have not changed in over
    20 years, so the date should not put you off too much. This guide, and many others
    pertaining to open standards and IBM products can be found at the excellent 'IBM
    Redbooks' site at [http://www.redbooks.ibm.com/](http://www.redbooks.ibm.com/).
  id: totrans-51
  prefs: []
  type: TYPE_NORMAL
  zh: 本章前面提到的IBM“TCP/IP教程和技术概述”，作者是Martin W. Murhammer、Orcun Atakan、Stefan Bretz、Larry
    R. Pugh、Kazunari Suzuki和David H. Wood，是另一本很好（而且免费）的TCP/IP网络世界指南。尽管稍微有些过时（最后一次修订是在1998年10月），但围绕TCP/IP的许多标准在20多年来都没有改变，所以日期不应该让你太在意。这个指南以及许多其他与开放标准和IBM产品相关的指南可以在优秀的“IBM
    Redbooks”网站上找到[http://www.redbooks.ibm.com/](http://www.redbooks.ibm.com/)。
- en: For a published introduction to TCP/IP, the three "TCP/IP Illustrated" books
    by Richard W. Stevens are generally considered to be the authoritative source
    on the topic. The ISBN number for the complete set is 0-201-77631-6, and it can
    be found at any good major bookstore or online book retailer.
  id: totrans-52
  prefs: []
  type: TYPE_NORMAL
  zh: 对于TCP/IP的介绍，理查德·W·史蒂文斯的三本《TCP/IP图解》书籍通常被认为是该主题的权威来源。完整套装的ISBN号码是0-201-77631-6，可以在任何一家好的大型书店或在线书店找到。
- en: How Networks are Structured
  id: totrans-53
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 网络结构
- en: Whether you know it or not, the chances are that any network that you use is
    build on top of IP, Internet Protocol. IP and the protocols that are built on
    top of it (such as TCP, UDP, and ICMP, all of which use IP datagrams) are the
    foundation of almost every network presently deployed. The components that such
    networks are built out of are interoperable, and for these reasons their roles
    are well defined and well understood. We will, briefly, talk about these devices
    and—particularly—how they interconnect with firewalls.
  id: totrans-54
  prefs: []
  type: TYPE_NORMAL
  zh: 无论你是否知道，你使用的任何网络的机会都是建立在IP，即互联网协议的基础上。IP及其上面构建的协议（如TCP、UDP和ICMP，所有这些协议都使用IP数据报）是几乎每个当前部署的网络的基础。这些网络构成的组件是可互操作的，因此它们的角色是明确定义和理解的。我们将简要讨论这些设备，特别是它们如何与防火墙相互连接。
- en: Ethernet, as the underlying technology on top of which most of these protocols
    are generally layered, forms the basis of these devices. As such network devices,
    peripherals, and appliances are often referred to as **LAN**, Ethernet, or TCP/IP
    equipment (or more commonly, just "**Network**" equipment). There are other networking
    standards in use, two of them being **Token Ring** and **SNA** networks that have
    fairly specific uses. Many of theses standards including the two mentioned above,
    are generally considered outdated. It is commonly the case that in scenarios in
    which they are still deployed for legacy reasons, such networks, are hallmarked
    for replacement or are effectively change-frozen.
  id: totrans-55
  prefs: []
  type: TYPE_NORMAL
  zh: 以太网作为大多数这些协议通常层叠在其上的基础技术，构成了这些设备的基础。因此，网络设备、外围设备和设备通常被称为**LAN**、以太网或TCP/IP设备（或更常见的是**网络**设备）。还有其他正在使用的网络标准，其中两个是**Token
    Ring**和**SNA**网络，它们具有相当特定的用途。其中包括上述两种标准在内的许多标准通常被认为已过时。通常情况下，它们仍然部署在遗留原因的场景中，这些网络通常标志着需要更换或者已经被冻结更改。
- en: As a point of interest, Token Ring and SNA are often deployed in larger organizations,
    the latter almost unilaterally in communication with a mainframe such as IBM zSeries.
    Other specialized IT environments, such as clustering, have specific networking
    requirements that draw them towards other forms of networking also.
  id: totrans-56
  prefs: []
  type: TYPE_NORMAL
  zh: 值得一提的是，Token Ring和SNA通常部署在较大的组织中，后者几乎完全与IBM zSeries等大型机进行通信。其他专门的IT环境，如集群，具有特定的网络要求，这使它们倾向于其他形式的网络。
- en: 'Here, however, we shall consider the following (Ethernet/IP) network devices:'
  id: totrans-57
  prefs: []
  type: TYPE_NORMAL
  zh: 然而，在这里，我们将考虑以下（以太网/IP）网络设备：
- en: Servers and clients (microcomputers)
  id: totrans-58
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 服务器和客户端（微型计算机）
- en: Switches and Hubs
  id: totrans-59
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 交换机和集线器
- en: Routers
  id: totrans-60
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 路由器
- en: Combined Devices
  id: totrans-61
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 组合设备
- en: Servers and Clients
  id: totrans-62
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 服务器和客户端
- en: The server/client relationship is the cornerstone of the TCP/IP protocol and
    it is necessary to have some understanding of it in order to be able to effectively
    administer, implement, and think about it. Put very simply, a client is any device
    that initiates a connection (i.e. commences sending data) to another computer,
    and a server is any device that listens for such a connection in order to allow
    others to connect to it.
  id: totrans-63
  prefs: []
  type: TYPE_NORMAL
  zh: 服务器/客户端关系是TCP/IP协议的基石，有必要对其有一定的了解，以便能够有效地管理、实施和思考。简单地说，客户端是指发起连接（即开始发送数据）到另一台计算机的任何设备，服务器是指监听这样的连接以允许其他设备连接到它的任何设备。
- en: 'Within the context of TCP/IP, all devices on a network are servers and clients,
    irrespective of whether or not they are specifically assigned the role of server
    (such as a corporate mail server) or client (such as a desktop computer). This
    is for two reasons: firstly, many higher-level protocols initiate connections
    back to clients from the server itself; secondly, a TCP/IP connection actually
    involves data being sent to listening ports in both connections—initially from
    the client to the server in order to commence the transaction, connecting (generally)
    to a well-known port on the server in order to access a specific service (such
    as port 80 for HTTP, port 25 for SMTP, or port 21 for FTP) with traffic coming
    from a (generally) random ephemeral (i.e. greater than 1024) port on the client.'
  id: totrans-64
  prefs: []
  type: TYPE_NORMAL
  zh: 在TCP/IP的上下文中，网络上的所有设备都是服务器和客户端，无论它们是否被专门分配为服务器（如企业邮件服务器）或客户端（如台式电脑）。这是由于两个原因：首先，许多高级协议从服务器本身向客户端发起连接；其次，TCP/IP连接实际上涉及在两个连接中发送数据到监听端口——最初是从客户端到服务器，以启动交易，连接（通常）到服务器上的一个众所周知的端口，以访问特定服务（如端口80用于HTTP，端口25用于SMTP，或端口21用于FTP），流量来自客户端的（通常）随机的临时（即大于1024）端口。
- en: Once this data arrives, the server sends data to the client (and in this connection,
    the server is a client!) from the service port and to the (random) port on the
    client that was used as the source port for the initial connection. Traffic from
    the service port on the server to the client is used in order for the server to
    reply to the client. Data flowing in both directions, from client to server and
    server to client, constitutes a 'whole' TCP/IP connection. This particular distinction
    becomes important later on when we discuss traffic filtering.
  id: totrans-65
  prefs: []
  type: TYPE_NORMAL
  zh: 一旦数据到达，服务器从服务端向客户端发送数据（在这个连接中，服务器也是客户端！），并且发送到客户端的（随机）端口，该端口被用作初始连接的源端口。从服务器到客户端的服务端口的流量用于服务器回复客户端。从客户端到服务器和从服务器到客户端的数据流构成了一个完整的TCP/IP连接。当我们讨论流量过滤时，这种特定的区别后来变得重要。
- en: Within the context of a network, a server is a device that provides a fixed
    service to hosts on that network. Generally this involves some form of centraliszed
    resource; although a 'firewall' may be described as a server it doesn't necessarily
    have to accept connections to itself (but rather facilitates connections to other
    locations and/or servers).
  id: totrans-66
  prefs: []
  type: TYPE_NORMAL
- en: A server may serve files, email, or web pages, provide network configuration
    information via DHCP, provide translation between Domain Names and Host Names
    and IP addresses acting as a DNS server, or even provide other, more complex services,
    which facilitate single sign on or provide security services (such as Kerberos
    servers, radius servers, intrusion detection systems, etc.). For the purposes
    of this book, we will—generally—consider a server to be a *device that provides
    services and data to other computers and devices on a network.*
  id: totrans-67
  prefs: []
  type: TYPE_NORMAL
- en: Clients are generally used directly by users and will be situated on desks and
    have monitors and input devices plugged into them, or are laptops (servers frequently
    either share such peripherals or don't have them at all). They are directly used
    to access resources and information that is sometimes stored elsewhere (such as
    web pages or files from a file server) or locally (such as documents stored on
    a local `My Documents` folder). For the purposes of this book, we will, generally,
    consider a client to be a *device that a user uses to access services on other
    computers (and access data stored on them) on a network or on the Internet*.
  id: totrans-68
  prefs: []
  type: TYPE_NORMAL
- en: Note
  id: totrans-69
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: For more information on the client/server relationship, see [http://en.wikipedia.org/wiki/Client-server](http://en.wikipedia.org/wiki/Client-server).
  id: totrans-70
  prefs: []
  type: TYPE_NORMAL
- en: Switches and Hubs
  id: totrans-71
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: The hub is a networking device that allows multiple clients to be plugged into
    the network segment, within the context of which they can communicate with each
    other. A hub is, logically, very simple, and essentially acts as a logical connector
    for all devices attached to the device, allowing traffic to freely flow from port
    to port, such that in a four-port device, if the client attached to port 1 sends
    data to the client attached to port 4, the hub (unaware of the concept of 'clients')
    simply allows this traffic to flow to all ports on this device—clients 2 and 3
    ignore the traffic not destined for them.
  id: totrans-72
  prefs: []
  type: TYPE_NORMAL
- en: '![Switches and Hubs](img/1361_01_03.jpg)'
  id: totrans-73
  prefs: []
  type: TYPE_IMG
- en: Switches address several shortcomings of hubs and are typically deployed in
    preference to them. Increasingly, in addition, hubs are becoming a relic of a
    previous age, and are becoming very hard to purchase at retail outlets and online.
  id: totrans-74
  prefs: []
  type: TYPE_NORMAL
- en: '![Switches and Hubs](img/1361_01_04.jpg)'
  id: totrans-75
  prefs: []
  type: TYPE_IMG
- en: Switches work by keeping a table in memory correlating ports with MAC addresses,
    such that the switch knows which computers are plugged into which port. Some switches,
    which can be 'stacked', apply this to the entire network segment, although in
    a network in which unmanaged or un-stacked switches were simply connected to each
    other by crossover cabling, a given switch would simply see a large number of
    MAC addresses on a particular port.
  id: totrans-76
  prefs: []
  type: TYPE_NORMAL
- en: Since traffic on local segments (even traffic being routed through that segment
    and destined for another network) is passed from host to host (router to router,
    router to client, client to server, etc.) directly by MAC address, the switch
    can make a decision based on the ports it has, as to for which port a particular
    datagram is intended. As processing is required, switches have historically been
    more expensive than hubs, as the electronics required to perform such processing
    costs more than the 'stupid' components inside a hub.
  id: totrans-77
  prefs: []
  type: TYPE_NORMAL
- en: In terms of their advantages, switches are faster, since any two ports may use
    a large quantity of bandwidth without affecting the bandwidth available to other
    ports on the device. On an unswitched network, if clients 1 and 4 are generating
    traffic at 90% of the available bandwidth, there is only 10% of the bandwidth
    (or, practically, less, when dealing with overhead imposed by IP) available for
    the rest of the network. On a switched network, each port, logically, has a significantly
    increased bandwidth limit, typically up to the limit of the hardware of the switch.
  id: totrans-78
  prefs: []
  type: TYPE_NORMAL
  zh: 就其优势而言，交换机更快，因为任何两个端口都可以使用大量带宽，而不会影响设备上其他端口可用的带宽。在未切换的网络上，如果客户端1和4正在使用可用带宽的90%生成流量，则网络的其余部分只有10%的带宽（或者在处理IP强加的开销时，实际上更少）。在切换网络上，每个端口逻辑上具有显着增加的带宽限制，通常可达到交换机硬件的极限。
- en: It is worth noting that many switches will have an overall bandwidth limit for
    traffic through all ports, and most medium to higher-end switches have an 'uplink'
    port, which in addition to providing MDI-X ability (the ability to sense whether
    a crossover link is required, and if so, perform the necessary modification in
    the switch, so a normal 'patch' cable can be used for a switch-to-switch connection)
    is also a higher bandwidth port (gigabit on a 100 megabit switch), or is a GBIC
    interface enabling a modular uplink.
  id: totrans-79
  prefs: []
  type: TYPE_NORMAL
  zh: 值得注意的是，许多交换机将对所有端口的流量设置总带宽限制，大多数中高端交换机都有一个“上行”端口，除了提供MDI-X功能（能够感知是否需要交叉链接，并在需要时在交换机中执行必要的修改，以便可以使用普通的“补丁”电缆进行交换机到交换机的连接），还是一个更高带宽的端口（在100兆交换机上是千兆位），或者是一个GBIC接口，可以实现模块化上行。
- en: Switches are also inherently slightly more secure as it is harder for any device
    to arbitrarily listen to network traffic, which may contain private data or authentication
    information such as passwords. Switches understand which clients are plugged into
    which socket on the switch, and will under normal circumstances move data from
    one port to another without passing unrelated traffic to computers not acting
    as the destination.
  id: totrans-80
  prefs: []
  type: TYPE_NORMAL
  zh: 交换机本身也稍微更安全，因为任何设备都很难随意监听可能包含私人数据或身份验证信息（如密码）的网络流量。交换机了解哪些客户端插入了交换机上的哪个插座，并且在正常情况下会将数据从一个端口移动到另一个端口，而不会将无关的流量传递给不作为目的地的计算机。
- en: This is not, however, an absolute security measure, and may be circumvented
    using a technique known as ARP Spoofing or ARP Poisoning ([http://www.node99.org/projects/arpspoof/](http://www.node99.org/projects/arpspoof/)).
    **ARP Spoofing** is a very well-known technique, with several tools existing for
    multiple platforms in order to allow people to perform it. On a local segment,
    ARP spoofing allows any user with administrator or system-level access to a PC
    (administrator credentials, a spare network socket into which to plug a laptop,
    or just a computer configured to boot from CD or floppy disk) to intercept any
    and all traffic sent by other computers on the same segment, and redirect it transparently
    to the Internet (or another destination) without any visible disruption to the
    user. Once this layer-two protocol is compromised, every other protocol at every
    other layer (with the exception of strong cryptographic protocols involving handshakes
    that are hard to attack, or using certificates) must be considered to be compromised
    as well.
  id: totrans-81
  prefs: []
  type: TYPE_NORMAL
  zh: 然而，这并不是绝对的安全措施，可能会被一种称为ARP欺骗或ARP中毒的技术所规避（[http://www.node99.org/projects/arpspoof/](http://www.node99.org/projects/arpspoof/)）。**ARP欺骗**是一种非常著名的技术，存在多个平台的多个工具，允许人们执行它。在本地段上，ARP欺骗允许具有管理员或系统级访问PC的任何用户（管理员凭据，一个备用网络插座，可以插入笔记本电脑，或者只是配置为从CD或软盘启动的计算机）拦截同一段上其他计算机发送的任何和所有流量，并将其透明地重定向到互联网（或其他目的地），而不会对用户造成任何可见的中断。一旦这个第二层协议被破坏，每个其他层的每个其他协议（除了使用证书的难以攻击的强加密协议）都必须被认为是被破坏的。
- en: Modern switches often have many forms of advanced functionality. Traditional
    switches, although more intelligent than hubs, are described (in the form in which
    they were described above) as 'unmanaged' switches. Newer, 'managed' switches
    (which generally have larger microprocessors, more memory, and increased throughput
    (the amount of data that can traverse the network in a given timeframe)) offer
    more functionality. Some examples of this are the ability to provide added security
    features such as MAC address filtering, DHCP snooping, and monitoring ports. Other
    such new features may address security and network structure such as vLANs. As
    mentioned earlier, some 'managed' switches offer a stacking capability, whereby
    using a proprietary link cable (such as the 'Matrix' cable with 3com Superstack
    switches), or a plain patch/crossover cable between the uplink ports of the switches,
    a 'stack' of switches can be managed as one, effectively sharing configuration
    and management interface.
  id: totrans-82
  prefs: []
  type: TYPE_NORMAL
  zh: 现代交换机通常具有许多形式的高级功能。传统交换机虽然比集线器更智能，但在上面描述的形式中被描述为“未管理”的交换机。更新的“受管理”交换机（通常具有更大的微处理器、更多内存和增加的吞吐量（在给定时间内可以穿越网络的数据量））提供更多功能。其中一些例子是提供增加的安全功能，如MAC地址过滤、DHCP监听和监视端口。其他新功能可能涉及安全和网络结构，如虚拟局域网（vLANs）。正如前面提到的，一些“受管理”交换机提供堆叠功能，通过使用专有的链接电缆（例如3com
    Superstack交换机的“Matrix”电缆）或交换机的上行端口之间的普通补丁/交叉电缆，可以将一组交换机管理为一个，有效地共享配置和管理界面。
- en: Some very high-end switches, such as the Cisco 6500 series and the 3com Corebuilder
    switches also have 'routing engines', which allow them to fulfill some of the
    functionality of routers. This, again, leads to more 'blur' between the OSI Layers
    when we come to apply them to 'real life'.
  id: totrans-83
  prefs: []
  type: TYPE_NORMAL
  zh: 一些非常高端的交换机，如思科6500系列和3com Corebuilder交换机，还具有“路由引擎”，使它们能够实现一些路由器的功能。这再次导致在将它们应用于“现实生活”时，OSI层之间的更多“模糊”。
- en: Switches range from small four-port units often integrated with other network
    devices, and sold as consumer appliances (such as the Linksys WRT54G) to large,
    high-availability units designed for use in data centers, which support many hundreds
    of concurrent clients and have an extremely high throughput.
  id: totrans-84
  prefs: []
  type: TYPE_NORMAL
  zh: 交换机的范围从小型的四端口单元（通常与其他网络设备集成，并作为消费类电器销售，比如Linksys WRT54G）到设计用于数据中心的大型、高可用性单元，支持许多并发客户端并具有极高的吞吐量。
- en: Within the context of this book, we will consider switches in a fairly simple
    context, and ignore functionality such as vLANs and routing engines, which are
    outside the scope of what we can reasonably deal with while talking about IPCop
    (such discussion would more be suited to a book on networking). For the purposes
    of this book, although a knowledge of switches is useful, it should suffice to
    understand that switches are *devices that allow all clients plugged into a network
    socket to talk to every other host on the switch, and as such, provide connectivity
    for a number of hosts to each other, to a network, and to shared resources stored
    on servers*.
  id: totrans-85
  prefs: []
  type: TYPE_NORMAL
  zh: 在本书的背景下，我们将在一个相当简单的背景下考虑交换机，并忽略诸如vLAN和路由引擎之类的功能，这些功能超出了我们在谈论IPCop时可以合理处理的范围（这样的讨论更适合于网络书籍）。对于本书的目的，虽然了解交换机是有用的，但理解交换机是*允许插入网络插座的所有客户端彼此交谈，并且为许多主机之间、网络之间以及存储在服务器上的共享资源提供连接*的设备就足够了。
- en: Routers
  id: totrans-86
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 路由器
- en: If a series of switches and hubs connect together our client devices in order
    to form a network, routers are, very simply, devices that connect those networks
    together (put another way, routers are the foundation of inter-networking). A
    small router (such as a 1700-series Cisco router) may link a branch office to
    a main office via an ISDN or broadband link, while at the other end of the scale,
    an expensive high-end router from Cisco, Juniper, or Nortel (or based on an operating
    system like Windows 2003 or Linux) may have several network links and be responsible
    for linking a smaller ISP with several larger ISPs it uses to connect to the internet
    backbone. At the high end of the scale, dedicated devices, although based on architectures
    similar to PCs, can handle far more traffic than a 'normal' computer running an
    OS such as Windows or Linux, and as such, these 'backbone' routers are very rarely
    anything but dedicated devices.
  id: totrans-87
  prefs: []
  type: TYPE_NORMAL
  zh: 如果一系列交换机和集线器将我们的客户设备连接在一起以形成网络，那么路由器就是非常简单地连接这些网络的设备（换句话说，路由器是互联网的基础）。一个小型路由器（比如1700系列的思科路由器）可以通过ISDN或宽带连接将分支办公室与总部连接起来，而在另一端，思科、瞻博或北电（或基于Windows
    2003或Linux等操作系统）的昂贵高端路由器可能有几个网络链接，并负责将一个较小的ISP与几个较大的ISP连接到互联网骨干网。在高端设备中，专用设备虽然基于与PC类似的架构，但可以处理比运行Windows或Linux等操作系统的“普通”计算机更多的流量，因此这些“骨干”路由器几乎从不是除了专用设备以外的其他东西。
- en: On a TCP/IP network, computers on the same 'subnet' (i.e. plugged into the same
    hub/switch, or series of hubs/switches) will communicate directly with each other,
    using ARP (Address Resolution Protocol) to find out the hardware (or MAC) address
    of the destination computer (as we mentioned when discussing OSI Layers, ARP is
    used to essentially step between layers two and three), and then sending data
    directly to this MAC address on the local network segment. It is for this reason
    that a 'subnet mask' is important; it allows a device to calculate which network
    addresses are 'local', and which are not. If our network uses the (private) address
    range 192.168.0.1, and our subnet mask is 255.255.255.0 (or one class C network
    or a /24 CIDR address space), then any network address not starting with 192.168.0\.
    will be considered as a remote address, and rather than attempting to connect
    to it directly (via layer two), the device will consult a 'routing table' to see
    which 'router' should be used to send the data through (via layer three), as an
    intermediary to another network.
  id: totrans-88
  prefs: []
  type: TYPE_NORMAL
  zh: 在TCP/IP网络上，位于同一“子网”（即插入同一集线器/交换机或一系列集线器/交换机的计算机）的计算机将直接使用ARP（地址解析协议）进行通信，以查找目标计算机的硬件（或MAC）地址（正如我们在讨论OSI层时提到的，ARP用于在第二层和第三层之间进行转换），然后直接向本地网络段上的这个MAC地址发送数据。正因为如此，“子网掩码”非常重要；它允许设备计算哪些网络地址是“本地”的，哪些不是。如果我们的网络使用（私有）地址范围192.168.0.1，并且我们的子网掩码是255.255.255.0（或一个C类网络或/24
    CIDR地址空间），那么任何不以192.168.0\开头的网络地址都将被视为远程地址，设备将不会直接尝试连接它（通过第二层），而是会查阅“路由表”以查看通过哪个“路由器”（通过第三层）发送数据，作为连接到另一个网络的中介。
- en: A fairly typical configuration for clients on smaller networks (or well-structured
    larger networks) is that there is only one router—the 'default' router—through
    which traffic goes. Using the previous example, if our device attempts to connect
    to another device at network address 192.0.2.17, the operating system—seeing that
    this is not a local device according to the network address and subnet of the
    network adapter—will send data for this destination to the 'default gateway',
    which then 'routes' the traffic to the correct destination. Although it is possible
    to configure a client to use different routers for different network segments,
    this is a more advanced and less common configuration option.
  id: totrans-89
  prefs: []
  type: TYPE_NORMAL
  zh: 在较小网络（或结构良好的较大网络）上，客户端的一个相当典型的配置是只有一个路由器——“默认”路由器——通过它进行流量传输。使用前面的例子，如果我们的设备尝试连接到网络地址192.0.2.17的另一个设备，操作系统会看到根据网络适配器的网络地址和子网，这不是一个本地设备，然后将数据发送到“默认网关”，然后“路由”流量到正确的目的地。虽然可以配置客户端使用不同的路由器来连接不同的网络段，但这是一个更高级和不太常见的配置选项。
- en: One may want to configure clients with multiple routes if, for instance, a network
    uses a fast network connection such as an ADSL router as the default gateway (for
    Internet access), and a slower network connection with a separate router to access
    another subnet of the internal network (for instance, a branch office of a company
    that has multiple sites). A preferable scenario for this in a smaller company
    would be to provide the internal and internet connectivity through one router
    that handled both, making client configuration and administration simpler (with
    all traffic via a default gateway, rather than static routing tables on every
    client pointing to different routers), but this may not always be possible or
    desirable.
  id: totrans-90
  prefs: []
  type: TYPE_NORMAL
  zh: 如果一个网络使用快速网络连接（如ADSL路由器）作为默认网关（用于互联网访问），并且使用另一个路由器访问内部网络的另一个子网（例如，一个公司有多个站点的分公司），则可能希望为客户端配置多个路由。在较小的公司中，这种情况更好的方案是通过一个处理两者的路由器提供内部和互联网连接，使客户端配置和管理更简单（所有流量通过默认网关，而不是每个客户端都指向不同路由器的静态路由表），但这可能并非总是可能或理想。
- en: '![Routers](img/1361_01_05.jpg)'
  id: totrans-91
  prefs: []
  type: TYPE_IMG
  zh: '![路由器](img/1361_01_05.jpg)'
- en: In the above illustration, we consider a company with a head office building.
    The **Head Office** LAN Infrastructure (represented here by the colonnaded building
    at the bottom left-hand corner) contains internally accessed servers such as file,
    mail, print, and directory servers, as well as clients. Situated in between this
    network and both the Internet and the non-trusted network segment, or DMZ (in
    which are contained the externally accessible corporate web/mail systems, hosting
    the corporate website and accepting incoming email) is a firewall.
  id: totrans-92
  prefs: []
  type: TYPE_NORMAL
  zh: 在上面的插图中，我们考虑一个拥有总部大楼的公司。**总部**局域网基础设施（在这里由左下角的柱廊建筑代表）包含内部访问的服务器，如文件、邮件、打印和目录服务器，以及客户端。在这个网络和互联网以及不受信任的网络段或DMZ之间（其中包含外部可访问的公司网站/邮件系统，托管公司网站并接受传入电子邮件）之间是一个防火墙。
- en: In addition to clients at the head office situated behind the firewall, we also
    have a **Secondary Office**, in the same town as the head office—opened when the
    head office ran out of space for expansion. This office has both server and client
    systems on the same logical network infrastructure as the **Head Office**, but
    in its own (routed) subnet, connected to the head office network via a building-to-building
    wireless link, possibly working by either microwave or laser link.
  id: totrans-93
  prefs: []
  type: TYPE_NORMAL
  zh: 除了总部后面的防火墙处的客户端，我们还有一个**分部办公室**，位于总部所在的城镇——当总部没有扩展空间时开设的。这个办公室在与**总部**相同的逻辑网络基础设施上拥有服务器和客户端系统，但在自己的（路由）子网中，通过建筑间的无线链接连接到总部网络，可能是通过微波或激光链接。
- en: A **Branch Office** (perhaps for sales staff in another part of the country
    with a high density of customers for our fictitious business) also uses resources
    on the **Head Office** network. Due to the distance, this office also has its
    own servers (most likely file, print, and email systems with content and information
    being synchronized to the corresponding systems in **Head Office**). In a subnet
    of its own, this network is linked via VPN, with the route from **Secondary Office**
    segment to **Head Office** segment tunneled over the Internet and through firewalls
    due to the prohibitive cost of a leased line or similar connection.
  id: totrans-94
  prefs: []
  type: TYPE_NORMAL
  zh: 一个**分公司**（也许是为了我们虚构的业务在国家另一地区的销售人员，客户密度很高）也使用**总部**网络的资源。由于距离的原因，这个办公室也有自己的服务器（很可能是文件、打印和电子邮件系统，内容和信息与**总部**相应系统同步）。在自己的子网中，这个网络通过VPN连接，从**分公司**段到**总部**段通过互联网和防火墙隧道传输，因为租用线路或类似连接的成本过高。
- en: Due to web/mail services being made available to the Internet, our **Head Office**
    has multiple Internet connections for redundancy. In a scenario like this, there
    would frequently be several more routers employed both for the **Head Office**
    infrastructure (which may be fairly large) and for the Internet service provision
    (and the **Head Office** firewall itself would most likely be, or be accompanied
    by, another router). These have been omitted for simplicity!
  id: totrans-95
  prefs: []
  type: TYPE_NORMAL
  zh: 由于网页/邮件服务向互联网开放，我们的**总部**有多个互联网连接以实现冗余。在这种情况下，**总部**基础设施（可能相当大）和互联网服务提供（**总部**防火墙本身很可能是或伴随着另一个路由器）通常会使用更多的路由器。这些都被简化了！
- en: For our purposes, we will consider a router to be a *device that forwards packets
    across a wide area network or inter-network to their correct destination*.
  id: totrans-96
  prefs: []
  type: TYPE_NORMAL
  zh: 对于我们的目的，我们将考虑路由器是一个*将数据包跨越广域网或互联网转发到它们正确目的地的设备*。
- en: Routers, Firewalls, and NAT
  id: totrans-97
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 路由器、防火墙和NAT
- en: Although it is easy to talk about networks in such cut and dry terms—separate
    networks based on layers, and network devices as isolated, well-defined items,
    this is quite frequently not the case. For many reasons, including network topology
    and limited resources, roles are quite frequently combined, particularly in smaller
    networks. Frequently, the first of these to be combined are the roles of 'firewall'
    and 'router'.
  id: totrans-98
  prefs: []
  type: TYPE_NORMAL
  zh: 虽然很容易用这种干净利落的术语来谈论网络——基于层的分离网络和网络设备作为孤立的、明确定义的项目，但这通常并非如此。出于许多原因，包括网络拓扑和有限的资源，角色经常被合并，特别是在较小的网络中。经常，首先合并的是“防火墙”和“路由器”的角色。
- en: As networks are frequently joined together by routers, this natural choke point
    can seem a convenient place to firewall as well. This in itself is good networking
    theory, but frequently this is implemented by adding firewalling functionality
    or rule sets to the existing router without any change to the network. Although
    on a small network this makes some sense, it can cause problems in handling load,
    and adds complexity to a device (router) that should be kept as simple as possible.
    In general, it is a good idea to split roles wherever possible, by utilizing separate
    routers, firewalls, proxy servers, etc.
  id: totrans-99
  prefs: []
  type: TYPE_NORMAL
  zh: 由于网络经常由路由器连接在一起，这个自然的瓶颈点似乎是一个方便的防火墙位置。这本身是良好的网络理论，但经常是通过向现有路由器添加防火墙功能或规则集来实现的，而不对网络进行任何更改。虽然在小型网络上这是有些合理的，但它可能会导致处理负载的问题，并给设备（路由器）增加复杂性。一般来说，尽可能地分离角色是一个好主意，通过使用单独的路由器、防火墙、代理服务器等。
- en: This also applies to other infrastructure roles on servers—DNS servers, Kerberos
    Domain Controllers, DHCP servers, web servers, and so on, should be kept apart
    as far as possible, in the interests of performance, reliability, and security.
  id: totrans-100
  prefs: []
  type: TYPE_NORMAL
  zh: 这也适用于服务器上的其他基础设施角色 - DNS服务器、Kerberos域控制器、DHCP服务器、Web服务器等等，应尽可能地保持分离，以提高性能、可靠性和安全性。
- en: Unfortunately, as we've already mentioned, this isn't always possible, and there
    are several network roles that are frequently combined, such as firewalls and
    routers. Particularly in organizations that do not have their own routable IP
    addresses for every network device (which is virtually every SME (Small and Medium
    Enterprise)), there is a need for Network Address Translation. NAT is a process
    whereby (in order to alleviate the increasing shortage of IP addresses available
    for use on the Internet), a local network will not use IP addresses that work
    (are 'routable') on the Internet.
  id: totrans-101
  prefs: []
  type: TYPE_NORMAL
  zh: 不幸的是，正如我们已经提到的，这并不总是可能的，有一些网络角色经常被合并，比如防火墙和路由器。特别是在没有为每个网络设备拥有自己的可路由IP地址的组织中（这几乎是每个中小型企业），需要进行网络地址转换。NAT是一个过程，通过这个过程（为了缓解互联网可用IP地址的不断减少），本地网络将不使用在互联网上可用的IP地址。
- en: Network Address Translation
  id: totrans-102
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 网络地址转换
- en: Network Address Translation is another consequence of the way in which the Internet
    and the protocols it is built upon were designed. Much as protocols such as DNS,
    SMTP, and TCP/IP were designed in an environment in which security was frequently
    an afterthought, so too was the extent to which (what would become) the Internet
    would grow. The IPv4 addressing scheme, which we should be familiar with, uses
    four octets of numbers, each with a range of 0 to 255, a hypothetical maximum
    of just over four billion addresses (255^4, to be precise).
  id: totrans-103
  prefs: []
  type: TYPE_NORMAL
  zh: 网络地址转换是互联网及其构建的协议的另一个结果。就像DNS、SMTP和TCP/IP等协议是在安全性经常被忽视的环境中设计的一样，互联网的增长程度也是如此。我们应该熟悉的IPv4寻址方案使用四个数字的八位组，每个数字的范围是0到255，最多只有40多亿个地址（精确地说是255^4）。
- en: Given the wide proliferation of internet connectivity and the vast number of
    personal computers, mobile telephones, PDAs, and other devices that use IP addresses
    (of which routers, non-mobile IP telephones, and even appliances such as fridges
    and microwaves are just a few), this address space although initially probably
    considered huge, is beginning to run out. For this reason, and as a result of
    the long timeframe for deployment of IPv6 (which aside from many other functional
    improvements upon IPv4 includes a larger address space), an interim method was
    required in order to reduce the rate at which IP addresses were being consumed—this
    is NAT.
  id: totrans-104
  prefs: []
  type: TYPE_NORMAL
  zh: 鉴于互联网连接的广泛普及和使用IP地址的个人计算机、移动电话、PDA和其他设备的数量庞大（其中路由器、非移动IP电话，甚至家用电器如冰箱和微波炉只是其中的一部分），这个地址空间虽然最初可能被认为是巨大的，但开始用尽。因此，为了减少IP地址消耗的速度，需要一种临时方法，这就是NAT。
- en: 'As an example of how NAT is used in practice, consider the following hypothetical
    scenario:'
  id: totrans-105
  prefs: []
  type: TYPE_NORMAL
  zh: 作为NAT在实践中的使用示例，考虑以下假设情景：
- en: '![Network Address Translation](img/1361_01_06.jpg)'
  id: totrans-106
  prefs: []
  type: TYPE_IMG
  zh: '![网络地址转换](img/1361_01_06.jpg)'
- en: Consider the diagram above—a fictional ISP and four of its customers. Each customer
    is allocated one IP address by the ISP, assigned to the computer or device directly
    attached to the connection provided by the ISP.
  id: totrans-107
  prefs: []
  type: TYPE_NORMAL
  zh: 考虑上面的图表 - 一个虚构的ISP和它的四个客户。每个客户由ISP分配一个IP地址，分配给ISP提供的连接直接连接的计算机或设备。
- en: Customer A is a medium-sized solicitors firm—Customer A has a firewall based
    on IPCop, several servers, and several clients in its private network segment.
    It uses the 10.0.1.0/24 (class C) subnet for its internal clients, but its external
    IP is actually used by several dozen computers.
  id: totrans-108
  prefs: []
  type: TYPE_NORMAL
  zh: 客户A是一个中等规模的律师事务所 - 客户A有一个基于IPCop的防火墙，几台服务器和几个私人网络段中的客户端。它使用10.0.1.0/24（C类）子网用于内部客户端，但其外部IP实际上被几十台计算机使用。
- en: Customer B is a home user—customer B has only one computer, a laptop, which
    is directly attached to the ISP's internet connection. Customer B's external IP
    is used by one computer, and has no NAT and no private internal network.
  id: totrans-109
  prefs: []
  type: TYPE_NORMAL
  zh: 客户B是一个家庭用户 - 客户B只有一台电脑，一台笔记本电脑，直接连接到ISP的互联网连接。客户B的外部IP被一台计算机使用，没有NAT和私人内部网络。
- en: Customer C is a larger manufacturing company—customer C has a high-end firewall
    attached to its internet connection, and a large number of diverse devices in
    its internal network. Customer C uses the 172.16.5.0/24 subnet for the network
    segment directly behind its firewall, and has a phone system, clients, server
    systems, and a midrange mainframe system in its internal network.
  id: totrans-110
  prefs: []
  type: TYPE_NORMAL
  zh: 客户C是一个较大的制造公司 - 客户C在其互联网连接上连接了一个高端防火墙，并在其内部网络中有大量不同的设备。客户C在其防火墙后面的网络段中使用172.16.5.0/24子网，并在其内部网络中有电话系统、客户端、服务器系统和中档主机系统。
- en: Customer D is a home with several computers for members of the family, and a
    tablet PC—they have a handful of clients attached to a wireless network provided
    by an all-in-one switch/router/firewall device (possibly the Linksys WAP54G mentioned
    earlier) purchased at a local computer store.
  id: totrans-111
  prefs: []
  type: TYPE_NORMAL
  zh: 客户D是一个家庭，有几台电脑供家庭成员使用，还有一台平板电脑——他们有几个客户端连接到由一台一体化交换机/路由器/防火墙设备（可能是之前提到的Linksys
    WAP54G）提供的无线网络。
- en: Just four IP addresses actually represent hundreds of clients on the Internet—through
    clever use of technology, clients using Internet Service Providers to provide
    access to the Internet reduce IP wastage by not allocating an IP address for every
    host.
  id: totrans-112
  prefs: []
  type: TYPE_NORMAL
  zh: 实际上，只有四个IP地址代表了互联网上数百个客户端，通过巧妙地利用技术，使用互联网服务提供商为客户端提供互联网访问，减少了IP地址的浪费，不为每个主机分配一个IP地址。
- en: If your computer exists as a host on a network on which the default gateway
    is performing Network Address Translation, and you visit a website, your computer
    will initiate a connection to port 80 on the web server you are connecting to,
    your computer will send a packet of data from the IP address it has (in the case
    of NAT, a private address like 192.168.1.23) to the destination. The destination
    will, in the case of a website on the Internet, be an internet-routable IP address
    such as 72.14.207.99 (one of Google's IP addresses).
  id: totrans-113
  prefs: []
  type: TYPE_NORMAL
  zh: 如果您的计算机作为网络上的主机存在，并且默认网关执行网络地址转换，并且您访问一个网站，您的计算机将发起到您正在连接的Web服务器的端口80的连接，您的计算机将从其拥有的IP地址（在NAT的情况下，是一个私有地址，如192.168.1.23）发送数据包到目的地。目的地在互联网上的网站的情况下，将是一个互联网可路由的IP地址，例如72.14.207.99（Google的IP地址之一）。
- en: If your gateway simply forwarded this packet to Google, it would be unlikely
    to get there in the first place, as a router between your computer and Google
    would almost certainly be configured to 'drop' packets from addresses like the
    192.168.0.0/16 address range, which are not valid for internet communications.
    Instead, therefore, your router *rewrites* the packet before forwarding it, and
    swaps the 192.168.1.23 for the external address of your router, given to you temporarily
    by your ISP.
  id: totrans-114
  prefs: []
  type: TYPE_NORMAL
  zh: 如果您的网关只是将此数据包转发给Google，那么它很可能根本无法到达那里，因为您的计算机和Google之间的路由器几乎肯定会配置为“丢弃”来自192.168.0.0/16地址范围的数据包，这些数据包对于互联网通信是无效的。因此，您的路由器在转发数据包之前*重新写入*数据包，并将192.168.1.23替换为您的ISP临时分配给您的路由器的外部地址。
- en: When replies come back from the host at the other end, the router, having made
    a note of the translation process, consults a table in memory, establishes based
    on the sequence number of the connection that 192.168.1.23 was the originating
    host, and rewrites the packet back again. Effectively, your clients are masquerading
    as the device attached to the Internet (or it is masquerading as them), and indeed,
    'masquerading' is the technical term used for NAT in the iptables/netfilter firewalling
    components in Linux. Although the NAT process breaks some more complicated protocols,
    it is an extremely effective way of having many hundreds or thousands of devices
    online behind one internet-routable (public) IP address.
  id: totrans-115
  prefs: []
  type: TYPE_NORMAL
  zh: 当来自另一端主机的回复返回时，路由器在记下翻译过程后，会在内存中的表中查找，根据连接的序列号确定192.168.1.23是发起主机，并重新写回数据包。实际上，您的客户端是伪装成连接到互联网的设备（或者它在伪装成他们），确实，“伪装”是Linux中iptables/netfilter防火墙组件中NAT的技术术语。尽管NAT过程会破坏一些更复杂的协议，但它是一种非常有效的方式，可以让成百上千台设备在一个互联网可路由（公共）IP地址后面在线。
- en: For the clients, the setup appears as if their address range existed as a normal,
    routed segment of the Internet, whereas in actual fact, the 'default gateway'
    is performing Network Address Translation. In this manner, the worldwide shortage
    of IP addresses is alleviated at the expense of some convenience. Small and home
    office devices in particular, such as any of those marketed by D-Link, Linksys
    et al., almost always use Network Address Translation to provide connectivity
    to their clients, and IPCop uses it too.
  id: totrans-116
  prefs: []
  type: TYPE_NORMAL
  zh: 对于客户端来说，设置看起来就像他们的地址范围存在于互联网的一个正常路由段中，而实际上，“默认网关”正在执行网络地址转换。通过这种方式，IP地址的全球短缺得到缓解，但牺牲了一些便利。特别是小型和家庭办公设备，如D-Link、Linksys等公司销售的设备，几乎总是使用网络地址转换来为其客户提供连接，IPCop也使用它。
- en: Note
  id: totrans-117
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 注意
- en: '**Private Address Ranges**'
  id: totrans-118
  prefs: []
  type: TYPE_NORMAL
  zh: '**私有地址范围**'
- en: These 'private' IP address ranges are set out in RFC 1918 ([http://www.rfc-archive.org/getrfc.php?rfc=1918](http://www.rfc-archive.org/getrfc.php?rfc=1918)).
    RFCs, or Requests For Comment, while not technical standards, are "technical *and
    organizational notes about the Internet (originally the ARPANET), beginning in
    1969\. Memos in the RFC series discuss many aspects of computer networking, including
    protocols, procedures, programs, and concepts, as well as meeting notes, opinions,
    and sometimes humor."* ([http://www.rfc-editor.org/](http://www.rfc-editor.org/),
    front page, November 20, 2005). For protocols, standards, and convention, they
    make an excellent first line of reference, although (often depending upon the
    authors and intended audience) they are usually fairly technical.
  id: totrans-119
  prefs: []
  type: TYPE_NORMAL
  zh: 这些“私有”IP地址范围在RFC 1918中设置。RFC或请求评论，虽然不是技术标准，但是“关于互联网（最初是ARPANET）的技术和组织笔记，始于1969年。RFC系列中的备忘录讨论了计算机网络的许多方面，包括协议、程序、程序和概念，以及会议记录、意见，有时还有幽默。”对于协议、标准和惯例，它们是一个很好的第一参考线，尽管（通常取决于作者和预期受众）它们通常是相当技术性的。
- en: The most recognizable of the private IP ranges is probably the 192.168.0.0/16
    range, which constitutes 255 class C 'subnets', of which the two most commonly
    used are the 192.168.0.1/24 and the 192.168.1.1/24 subnets. This address range
    is very frequently used as the default private address range for **Small Office
    Home Office** (**SOHO**) routers. There are also two other private address ranges
    for these purposes, the 10.0.0.0/8 and 172.16.0.0/12 ranges.
  id: totrans-120
  prefs: []
  type: TYPE_NORMAL
  zh: 私有IP范围中最为人熟知的可能是192.168.0.0/16范围，其中包括255个C类“子网”，其中最常用的是192.168.0.1/24和192.168.1.1/24子网。这个地址范围经常被用作**小型办公室家庭办公室**（SOHO）路由器的默认私有地址范围。还有另外两个私有地址范围用于这些目的，即10.0.0.0/8和172.16.0.0/12范围。
- en: Combined Role Devices
  id: totrans-121
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 组合角色设备
- en: 'As a result of NAT, devices at the border of Small Office Home Office Networks,
    therefore, are almost always *combined-role*, and although typically marketed
    as *router/firewalls* or simply *routers*, often perform all of the following
    roles:'
  id: totrans-122
  prefs: []
  type: TYPE_NORMAL
  zh: 因为NAT的结果，因此几乎总是处于**小型办公室家庭办公室**网络边界的设备几乎总是*组合角色*，尽管通常被营销为*路由器/防火墙*或简单地*路由器*，但通常执行以下所有角色：
- en: Router (performing Network Address Translation)
  id: totrans-123
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 路由器（执行网络地址转换）
- en: Firewall
  id: totrans-124
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 防火墙
- en: DHCP server
  id: totrans-125
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: DHCP服务器
- en: Caching / Resolving DNS server
  id: totrans-126
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 缓存/解析DNS服务器
- en: 'Some such devices (including IPCop) may also provide some of the following
    pieces of functionality, most of which are generally more commonly found in enterprise
    products:'
  id: totrans-127
  prefs: []
  type: TYPE_NORMAL
  zh: 一些这样的设备（包括IPCop）可能还提供以下一些功能，其中大多数通常更常见于企业产品中：
- en: Proxy server
  id: totrans-128
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 代理服务器
- en: Content Filtering
  id: totrans-129
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 内容过滤
- en: File server
  id: totrans-130
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 文件服务器
- en: Intrusion Detection
  id: totrans-131
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 入侵检测
- en: VPN/IPSec server
  id: totrans-132
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: VPN/IPSec服务器
- en: Due to the complex nature of some of these tasks, it is often the case that
    the 'embedded' combined devices are difficult to configure and interoperating
    some of the more complex functions (such as IPSec and File Serving) with other
    devices (such as an IPSec/VPN device from another vendor) can be very difficult.
    Although the price and size of these devices makes them a very attractive prospect
    for smaller networks, networks requiring some of the more advanced functionality
    should look at them quite carefully and evaluate whether or not, economically
    and technically, they will meet their needs.
  id: totrans-133
  prefs: []
  type: TYPE_NORMAL
  zh: 由于某些任务的复杂性，通常情况下，“嵌入式”组合设备很难配置，并且与其他设备（如来自其他供应商的IPSec/VPN设备）进行一些更复杂功能（如IPSec和文件共享）的互操作可能非常困难。尽管这些设备的价格和大小使它们对较小的网络非常有吸引力，但需要一些更高级功能的网络应该仔细考虑它们，并评估它们是否在经济和技术上能够满足他们的需求。
- en: When combined roles are required, larger, more fully designed solutions (such
    as a firewall appliance from Borderware, Checkpoint, Cisco, et al.) or commercial
    piece of software (such as Microsoft's ISA server) often do the job more effectively
    and in a manner more configurable and interoperable than their smaller, cheaper
    SOHO cousins. Obviously, we believe that not only does IPCop do a better job at
    the tasks it is intended for than embedded devices, but than some of the commercial
    firewall and gateway packages as well!
  id: totrans-134
  prefs: []
  type: TYPE_NORMAL
  zh: 当需要组合角色时，更大、更完全设计的解决方案（如Borderware、Checkpoint、Cisco等的防火墙设备）或商业软件（如Microsoft的ISA服务器）通常比它们更有效地完成工作，并以更可配置和可互操作的方式。显然，我们相信IPCop不仅在其预期任务上比嵌入式设备做得更好，而且比一些商业防火墙和网关软件包做得更好！
- en: Traffic Filtering
  id: totrans-135
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 流量过滤
- en: Knowing what firewalls are intended to do and why their function is important
    to us, it is now necessary to explore, briefly, how it is that firewalls accomplish
    the broad purpose we've assigned for them.
  id: totrans-136
  prefs: []
  type: TYPE_NORMAL
  zh: 了解防火墙的预期功能以及为什么它们的功能对我们很重要，现在有必要简要探讨一下防火墙是如何实现我们为其分配的广泛目的的。
- en: Personal Firewalls
  id: totrans-137
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 个人防火墙
- en: Personal firewalls have become increasingly common in the last five years. With
    the inclusion of personal firewalling technology in Windows XP Service Pack 2
    (and augmented technology in the upcoming Windows Vista), as well as firewalling
    stacks in the OSX and Linux operating systems, it is now a fairly normal occurrence
    for workstations and desktops to be running firewalling software.
  id: totrans-138
  prefs: []
  type: TYPE_NORMAL
  zh: 个人防火墙在过去五年中变得越来越普遍。随着Windows XP Service Pack 2中个人防火墙技术的加入（以及即将推出的Windows Vista中的增强技术），以及OSX和Linux操作系统中的防火墙堆栈，现在工作站和台式机运行防火墙软件已经成为相当正常的事情。
- en: Generally, this comes in one of two forms—either firewalling software built
    into the operating system (as in the case of OSX, Linux, and XP's Windows Firewall),
    or one of the many third-party firewalls from software vendors who write such
    software. Two relatively well regarded examples of such packages are Agnitum's
    Outpost package and ZoneLabs ZoneAlarm package.
  id: totrans-139
  prefs: []
  type: TYPE_NORMAL
  zh: 一般来说，防火墙软件有两种形式——一种是内置于操作系统中的防火墙软件（如OSX、Linux和XP的Windows防火墙），另一种是来自软件供应商编写的许多第三方防火墙。这类软件包的两个相对受好评的例子是Agnitum的Outpost软件包和ZoneLabs的ZoneAlarm软件包。
- en: Personal firewalling software cannot be a true firewall. As we have discussed
    earlier, a firewall is a security boundary between one side of the firewall and
    another. By definition, a personal firewall must accept data onto a computer before
    making the decision as to whether it is allowed to be there or not. Many forms
    of exploit involve the misinterpretation of maliciously crafted data while parsing
    and evaluating that data. Since a firewall is performing these tasks on the host
    it is supposed to be protecting, there is no way in which it can effectively isolate
    the portions of the software that are doing the protecting from the portions of
    the software that are being protected. Even for a smaller network, a personal
    firewall can never offer the degree of segregation that a network firewall provides.
  id: totrans-140
  prefs: []
  type: TYPE_NORMAL
- en: Although personal firewalling software is relatively effective against inbound
    (ingress) traffic, such software cannot offer protection against unauthorized
    outbound (or egress) traffic, since an application generating such traffic on
    the workstation will typically have some degree of access to the firewall's internals.
    If the logged on user is an administrator of the workstation (or if there exists
    a security flaw in the operating system allowing a non-administrative application
    to gain system or administrative privileges), it is quite possible to circumvent
    software/personal firewalls using the operating system ([http://www.vigilantminds.com/files/defeating_windows_personal_firewalls.pdf](http://www.vigilantminds.com/files/defeating_windows_personal_firewalls.pdf))
    in a way that simply isn't possible with a firewall distinct from the client itself.
  id: totrans-141
  prefs: []
  type: TYPE_NORMAL
- en: Many personal firewall packages, such as ZoneAlarm, step beyond the services
    offered solely by a packet filtering firewall, and serve as a Host-based Intrusion
    Detection System (HIDS) or Host-based Intrusion Prevention System (HIPS). These
    systems actively monitor, and in the case of a HIPS, prevent, alterations to the
    operating system and its components. Such functions cannot be provided by a network
    firewall such as IPCop for obvious reasons, but the same criticisms apply to a
    HIPS as to a Personal Firewall—ultimately, if the host it is running on is compromised,
    the accuracy of the Intrusion Prevention System is compromised also.
  id: totrans-142
  prefs: []
  type: TYPE_NORMAL
- en: Recent developments in security include rootkit software, which is capable of
    providing a 'backdoor' into a host operating system using virtualization software
    (such as VMware) and hardware-based virtualization support (such as that in AMD
    and Intel's newest processors). Such software, like VMware and Virtual PC themselves,
    literally acts as a container (or hypervisor) for the OS running inside it, the
    consequence of which is that such backdoors literally exist outside the OS that
    installed them. In light of these concepts being demonstrated publicly, the role
    of host-based firewall and IPS software is redoubled—part of a security solution,
    but not a 'killer app'. Fundamentally, what we can take from this that is for
    sure is that different packages have different strengths, and we shouldn't ever
    rely on one in particular.
  id: totrans-143
  prefs: []
  type: TYPE_NORMAL
- en: Although an important part of an overall stance on security, not all firewalls
    are created equal, and a personal firewall should never be considered to be a
    substitute for well-designed, well-maintained perimeter and segment firewalling
    as part of a network's overall security strategy.
  id: totrans-144
  prefs: []
  type: TYPE_NORMAL
- en: Stateless Packet Filtering
  id: totrans-145
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: '''Packet filtering'' is a term generally used to describe a firewall, acting
    at the network layer, which decides where data should go based on criteria from
    the data packet. Generally, this will include the source and destination ports
    and source and destination addresses—so, for instance, an organization may allow
    connections to its remote access server from a business partner''s IP address
    range but not from the Internet in general. Other criteria may include the time
    of day at which the connection is made.'
  id: totrans-146
  prefs: []
  type: TYPE_NORMAL
- en: Although fast and historically effective, 'stateless' packet filters operate
    solely at the network layer and provide no inspection of data traveling through
    them at all—a stateless packet filter configured to allow traffic from the Internet
    to port 80 in an organization's DMZ will allow such traffic, irrespective of what
    the data going to port 80 is, and more importantly whether or not that data is
    actually part of an established connection.
  id: totrans-147
  prefs: []
  type: TYPE_NORMAL
  zh: 尽管快速且在历史上有效，“无状态”数据包过滤器仅在网络层操作，并且根本不检查通过它们传输的数据——一个配置为允许来自互联网到组织DMZ端口80的流量的无状态数据包过滤器将允许这样的流量，无论去往端口80的数据是什么，更重要的是这些数据是否实际上是已建立连接的一部分。
- en: Stateful Packet Filtering
  id: totrans-148
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 有状态数据包过滤
- en: A packet filter that is stateful understands the state of a TCP connection that
    is in progress through it. When a TCP Connection is set up a very specific process
    known as a 'three-way handshake' takes place between the source and the target
    hosts.
  id: totrans-149
  prefs: []
  type: TYPE_NORMAL
  zh: 有状态的数据包过滤器理解通过它进行的正在进行的TCP连接的状态。当建立TCP连接时，源和目标主机之间会进行一个称为“三次握手”的特定过程。
- en: 'This is a very basic, simplistic explanation of stateful firewalling—it would
    be out of scope for this text to cover the entire topic of stateful firewalling
    (there are other resources such as [http://en.wikipedia.org/wiki/Stateful_inspection](http://en.wikipedia.org/wiki/Stateful_inspection)
    that cover this), but a basic explanation of the topic is useful:'
  id: totrans-150
  prefs: []
  type: TYPE_NORMAL
  zh: 这是对有状态防火墙的非常基本和简单的解释——本文的范围不包括有状态防火墙的整个主题（还有其他资源如[http://en.wikipedia.org/wiki/Stateful_inspection](http://en.wikipedia.org/wiki/Stateful_inspection)），但对该主题的基本解释是有用的：
- en: Firstly, the client in the connection issues a TCP SYN packet to the destination.
    For the firewall, this is considered a 'new' connection, and at this point the
    firewall will allocate memory to track the status of the connection as it progresses.
  id: totrans-151
  prefs: []
  type: TYPE_NORMAL
  zh: 首先，连接中的客户端向目的地发出一个TCP SYN数据包。对于防火墙来说，这被视为一个“新”连接，此时防火墙将分配内存来跟踪连接的状态随着其进展。
- en: Secondly, the server—if the connection proceeds as expected—replies by sending
    back a packet with the correct sequence number, source, and destination ports,
    with both SYN and ACK flags set.
  id: totrans-152
  prefs: []
  type: TYPE_NORMAL
  zh: 其次，如果连接按预期进行，服务器会通过发送一个带有正确序列号、源和目的端口的数据包来回复，同时设置SYN和ACK标志。
- en: Thirdly, the client, upon receiving the SYN ACK packet, returns a third packet
    with solely the ACK packet set. Frequently, this packet will also contain some
    of the first bits of data pertaining to the connection in it. At this point, the
    firewall considers the connection to be 'established', and will allow data associated
    with this connection (that is to say, data to and from the source/destination
    addresses, going to and from the correct ports, with the correct sequence number)
    to freely pass through the firewall.
  id: totrans-153
  prefs: []
  type: TYPE_NORMAL
  zh: 第三，客户端在收到SYN ACK数据包后，返回一个仅包含ACK数据包的第三个数据包。通常，这个数据包也会包含与连接相关的一些数据的前几位。在这一点上，防火墙认为连接已经“建立”，并且将允许与该连接相关的数据（即来自源/目的地址的数据，去往和来自正确端口的数据，带有正确序列号的数据）自由通过防火墙。
- en: In the event that this is not completed, the firewall will forget about the
    details of the connection either after a specific time period or when the available
    memory to remember such connections is exhausted, depending upon how the firewall
    works. This added use of memory makes 'stateful' packet inspection more processor
    and memory intensive, although as it only inspects the header of our data, it
    is still not as processor or memory-intensive as a firewall that inspects data
    all of the way up to the application layer and so unpacks the payload of data
    packets traversing it also.
  id: totrans-154
  prefs: []
  type: TYPE_NORMAL
  zh: 如果未完成这一点，防火墙将在特定时间段后或者在可用内存用尽时忘记连接的细节，这取决于防火墙的工作方式。这种额外的内存使用使得“有状态”数据包检查更加依赖处理器和内存，尽管它只检查我们数据的头部，但它仍然不像检查数据一直到应用层并解开数据包的有效载荷的防火墙那样依赖处理器或内存。
- en: The principle advantage of a stateful firewall, however, stems from the understanding
    it has of 'established' connections. In a network with several clients with a
    non-stateful firewall that allows those clients to connect to external sites on
    port 80, any traffic with a destination port of 80 will be allowed out of the
    network, but more importantly, any host on the Internet will be able to bypass
    the firewall completely and connect to internal clients simply by sending their
    traffic from a source port of 80\. Because responses from web servers will come
    from port 80, without the firewall checking to see if connections from outside
    the network from port 80 are responses to internal clients (i.e. without acting
    statefully), there is no way to prevent this.
  id: totrans-155
  prefs: []
  type: TYPE_NORMAL
  zh: 然而，有状态防火墙的主要优势源于其对“已建立”连接的理解。在一个具有非有状态防火墙的多个客户端的网络中，允许这些客户端连接到端口80的外部站点，任何目的端口为80的流量都将被允许离开网络，但更重要的是，任何互联网上的主机都可以完全绕过防火墙，并通过从源端口为80发送其流量来连接到内部客户端。因为Web服务器的响应将来自端口80，没有防火墙检查来自网络外部端口80的连接是否是对内部客户端的响应（即没有进行有状态处理），因此无法阻止这种情况发生。
- en: A stateful firewall, however, will only allow data to traverse the firewall
    if it is part of an 'established' connection. Since there should be no payload
    allowed through for packets that are sent before the three-way handshake, this
    minimizes what an attacker could actually do to a target system without fully
    connecting to it in a way allowed by the firewall.
  id: totrans-156
  prefs: []
  type: TYPE_NORMAL
  zh: 然而，有状态的防火墙只有在数据是属于一个“已建立”的连接时才允许数据穿过防火墙。由于在三次握手之前发送的数据包不应该允许通过任何有效载荷，这最大程度地减少了攻击者对目标系统的实际影响，除非完全按照防火墙允许的方式连接到目标系统。
- en: Application-Layer Firewalling
  id: totrans-157
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 应用层防火墙
- en: Although stateful packet firewalls can very effectively restrict where traffic
    can go to and from on a network, it cannot control what exactly that traffic is.
    The actual data inside data packets themselves exists at a higher level than packet
    firewalls, which as network-layer devices are unaware of the application layer.
  id: totrans-158
  prefs: []
  type: TYPE_NORMAL
  zh: 尽管有状态包过滤防火墙可以非常有效地限制网络上的流量去向，但它无法控制流量的确切内容。数据包内部的实际数据存在于比数据包防火墙更高的级别，因为作为网络层设备的数据包防火墙不了解应用层。
- en: As an example of this, consider a simple office network with a gateway that
    allows connections outbound to port 80 (HTTP) in order to allow clients on the
    network to browse the Internet. The network administrator has denied connections
    to all other ports such as 443 and 25, as the company policy dictates that staff
    should not be able to access external mail (via 25) or sites that require HTTPS
    login (as many of these are sites such as eBay and webmail sites, which the company
    does not want its staff to access). It uses a stateful firewall in order to prevent
    traffic coming into its network with a source port of 80, which might be used
    to attack, probe, or scan clients on its network.
  id: totrans-159
  prefs: []
  type: TYPE_NORMAL
  zh: 举例来说，考虑一个简单的办公网络，网关允许对端口80（HTTP）的出站连接，以便允许网络上的客户端浏览互联网。网络管理员已经拒绝了对所有其他端口的连接，比如443和25，因为公司政策规定员工不应该能够访问外部邮件（通过25端口）或需要HTTPS登录的网站（因为其中许多是eBay和网页邮件等网站，公司不希望员工访问）。它使用有状态防火墙来防止带有源端口80的流量进入其网络，因为这可能被用于攻击、探测或扫描其网络上的客户端。
- en: This firewall, however, does not prevent staff from accessing other resources
    on port 80—one of the staff might, for instance, have set up a mail server listening
    on port 80 and be using this to read his or her mail. Another might have the SSH
    service or a VPN server running on a server outside the company or at home listening
    to port 80 and use this connection to 'tunnel' other traffic through in order
    to connect to services (such as mail, IRC, etc.) that the IT policy denies.
  id: totrans-160
  prefs: []
  type: TYPE_NORMAL
  zh: 然而，这种防火墙无法阻止员工访问端口80上的其他资源——例如，员工中的某人可能已经在端口80上设置了邮件服务器，并且正在使用它来阅读自己的邮件。另一个可能在公司外部或家中的服务器上运行SSH服务或VPN服务器，并且正在监听端口80并使用此连接来“隧道”其他流量，以便连接到IT政策禁止访问的服务（如邮件、IRC等）。
- en: This is extremely hard to prevent unless the administrator has a firewall that
    understands the application layer, because only then can he or she restrict traffic
    based specifically on what sort of traffic it is. Such firewalls are often called
    'proxy firewalls', because the way in which they function is frequently by proxying
    traffic—accepting the connection on behalf of the client, unpacking it and inspecting
    the data, and then forwarding it on to the destination if it is allowed by whatever
    access control the firewall has in place. As with stateful firewalls, an application-layer
    firewall or proxy server may restrict traffic based on destination, time, content,
    (in this case), and many other factors. Squid, the open-source proxy server that
    ships with IPCop, is very powerful in this respect, and has the ability to enforce
    powerful access control, particularly in conjunction with the Squidguard add-on.
  id: totrans-161
  prefs: []
  type: TYPE_NORMAL
  zh: 除非管理员有一个理解应用层的防火墙，否则很难防止这种情况，因为只有这样，他或她才能根据流量的类型来限制流量。这样的防火墙通常被称为“代理防火墙”，因为它们的功能方式经常是通过代理流量——代表客户端接受连接，解包并检查数据，然后根据防火墙所设定的访问控制来转发到目的地。与有状态防火墙一样，应用层防火墙或代理服务器可以根据目的地、时间、内容（在这种情况下）和许多其他因素来限制流量。Squid是与IPCop一起提供的开源代理服务器，在这方面非常强大，并且能够强制执行强大的访问控制，特别是与Squidguard附加组件结合使用时。
- en: Web proxy servers, debatably, are a frequently deployed application-layer firewall—although
    not often considered as such, many proxy servers have functionality that approximates
    that of a full-fledged application-layer firewall, and by blocking normal connections
    to port 80 and forcing connections to the Internet through a proxy server, organizations
    ensure that requests made to port 80 are HTTP, and no other protocol is allowed
    over that port. Unfortunately, many protocols (such as SSL on port 443) are very
    hard to proxy due to their use of cryptography, and for this reason these ports
    are frequently unprotected and therefore are good candidates for a malicious intruder
    (or errant employee) to use for nefarious purposes.
  id: totrans-162
  prefs: []
  type: TYPE_NORMAL
  zh: Web代理服务器可以说是经常部署的应用层防火墙，尽管通常不被视为这样，许多代理服务器具有近似完整的应用层防火墙功能，通过阻止对端口80的正常连接并强制通过代理服务器连接到互联网，组织确保对端口80的请求是HTTP，并且不允许在该端口上使用其他协议。不幸的是，许多协议（如端口443上的SSL）由于使用了加密技术，很难进行代理，因此这些端口经常是不受保护的，因此是恶意入侵者（或错误的员工）用于不良目的的好选择。
- en: Consider border control as an object lesson—we restrict cross-border travel
    by using passports to verify whether someone is authorized to go to and from a
    source and destination country—this is analogous to stateless packet filtering,
    as passports are similar in nature to packet headers; they contain information
    about the bearer (or payload). We then use visas to verify the *state* of someone
    during their travel—that is to say, whether they are in the state of being at
    the end of their legitimate stay, having no legitimate reason to enter the country
    (even though by law they may be entitled to), and so on. The passport (and inspection
    of it) by itself does not restrict travel based on who someone is and what they
    are doing, as well as whether they are on a blacklist or not for security reasons.
    This is analogous to application-layer firewalling. Further, through passports
    and lists, governments inspect the people themselves who travel cross-border,
    and examine their bags (their payload) to verify whether it is legitimately carried
    (or contains contraband, such as explosives or munitions)—this could be compared
    both to application-layer firewalls and Intrusion Detection / Prevention Systems.
  id: totrans-163
  prefs: []
  type: TYPE_NORMAL
  zh: 将边境控制作为一个教训——我们通过护照限制跨境旅行，以验证某人是否被授权前往源和目的地国家——这类似于无状态数据包过滤，因为护照类似于数据包头部；它们包含有关持有者（或有效载荷）的信息。然后，我们使用签证来验证某人在旅行中的“状态”，也就是说，他们是否处于合法停留的状态，没有合法理由进入该国家（尽管根据法律他们可能有权进入），等等。单凭护照（及其检查）本身并不会根据某人的身份和所做的事情以及他们是否因安全原因被列入黑名单来限制旅行。这类似于应用层防火墙。此外，通过护照和名单，政府检查跨境旅行的人员本身，并检查他们的行李（有效载荷）以验证其是否合法携带（或包含违禁品，如爆炸物或军火）——这可以与应用层防火墙和入侵检测/预防系统进行比较。
- en: Proxy Servers
  id: totrans-164
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 代理服务器
- en: Proxy servers, then, can be a form of application-layer firewalling. A proxy
    server is, very simply, a device that accepts a request from one computer, and
    passes it to another. In passing the request along, a proxy server may also levy
    certain restrictions upon exactly what that request can be. Most importantly,
    however, as a proxy server understands the concept of a 'request', it provides
    security over and above simply allowing a client to connect to the destination
    server or service itself, as a proxy server will not allow just anything to traverse
    the firewall.
  id: totrans-165
  prefs: []
  type: TYPE_NORMAL
  zh: 因此，代理服务器可以是一种应用层防火墙。代理服务器非常简单，它接受来自一台计算机的请求，并将其传递给另一台计算机。在传递请求的同时，代理服务器还可能对该请求施加一定的限制。然而，最重要的是，代理服务器理解“请求”的概念，它提供的安全性不仅仅是允许客户端连接到目标服务器或服务本身，因为代理服务器不会允许任何东西穿过防火墙。
- en: Consider our earlier example—the small network that wishes to allow clients
    to access the Internet, while preventing them from accessing certain resources
    (such as mail, online auction sites, games, etc.). The network administrator,
    deciding that the present firewalling strategy is inadequate, installs a proxy
    server, and configures the web browser for clients on the network (either by hand,
    or automatically using a script or a centralized configuration method such as
    Red Hat Directory server or Microsoft's Active Directory) to point to the proxy
    server for Internet access.
  id: totrans-166
  prefs: []
  type: TYPE_NORMAL
  zh: 考虑我们之前的例子——希望允许客户端访问互联网，同时阻止他们访问某些资源（如邮件、在线拍卖网站、游戏等）的小型网络。网络管理员决定当前的防火墙策略不够，安装了代理服务器，并为网络上的客户端配置了Web浏览器（可以手动配置，也可以使用脚本或集中配置方法，如Red
    Hat Directory服务器或微软的Active Directory）指向代理服务器进行互联网访问。
- en: The network administrator then configures the firewall to drop all outbound
    connections from workstations on the network (allowing connections to the Internet
    from the proxy server). At this point, if anyone is using the gateway/firewall
    to connect to the Internet, such as a hypothetical employee connecting to an SSH
    server on port 80 for nefarious purposes, those connections will be dropped by
    the firewall (and possibly logged). From this point onwards, whenever an employee
    initiates a connection to a website using his or her web browser, the web browser
    does not do what it had done previously and attempt to connect to the website
    in question and retrieve content for the user. Instead, the web browser connects
    to the proxy server it has been configured with, and requests that the proxy server
    give it the webpage in question.
  id: totrans-167
  prefs: []
  type: TYPE_NORMAL
  zh: 然后，网络管理员配置防火墙，以阻止网络上工作站的所有出站连接（允许代理服务器连接到互联网）。此时，如果有人使用网关/防火墙连接到互联网，比如一个假设的员工以恶意目的连接到端口80上的SSH服务器，这些连接将被防火墙拒绝（并可能被记录）。从这时起，每当员工使用他或她的网络浏览器连接到网站时，网络浏览器不再像以前那样尝试连接到相关网站并为用户检索内容。相反，网络浏览器连接到它被配置的代理服务器，并请求代理服务器提供所需的网页。
- en: It is at this point that a proxy server enacting any form of access control
    would determine whether the user in question was allowed to access the requested
    resource it. Dan's Guardian is an example of a package for IPCop that allows the
    filtering of inappropriate websites.
  id: totrans-168
  prefs: []
  type: TYPE_NORMAL
  zh: 在这一点上，代理服务器实施任何形式的访问控制，将确定用户是否被允许访问所请求的资源。Dan's Guardian是一个允许过滤不适当网站的IPCop软件包的例子。
- en: Another advantage of proxy servers is that as they act as a chokepoint for the
    **requests** for content, they can check to see if a webpage has been requested
    already, and if it has, then give the client a local (cached) copy of the page,
    instead of retrieving another copy of the same content. Such proxy servers are
    referred to as *caching web proxies*. Microsoft's ISA server, and the Open Source
    package Squid are both examples of these.
  id: totrans-169
  prefs: []
  type: TYPE_NORMAL
  zh: 代理服务器的另一个优点是，它们作为内容请求的瓶颈，可以检查网页是否已经被请求过，如果是的话，就给客户端一个本地（缓存）页面的副本，而不是检索相同内容的另一个副本。这样的代理服务器被称为缓存网络代理。微软的ISA服务器和开源软件Squid都是这方面的例子。
- en: Having established that there is no local copy of the content (if the proxy
    server is caching) and that the user is authorized to view the content (if there
    is access control in effect), the proxy server will attempt to retrieve the content
    itself, either from an upstream proxy server, or (more likely) from the Internet
    itself. The proxy server may return an error to the user if the destination site
    does not exist, or give an error returned from the remote site to the user.
  id: totrans-170
  prefs: []
  type: TYPE_NORMAL
- en: Transparent proxies (which IPCop has support for), or '*intercepting proxies'*
    ([http://www.rfc.org.uk/cgi-bin/lookup.cgi?rfc=rfc3040](http://www.rfc.org.uk/cgi-bin/lookup.cgi?rfc=rfc3040))'
    perform this via NAT without the need for reconfiguration (and without the required
    participation of the client), taking advantage of chokepoints to impose network
    policy upon traffic.
  id: totrans-171
  prefs: []
  type: TYPE_NORMAL
- en: '![Proxy Servers](img/1361_01_07.jpg)'
  id: totrans-172
  prefs: []
  type: TYPE_IMG
- en: In the example above, our transparent proxy server fetches [www.google.com](http://www.google.com)
    for a laptop client. Hypothetically, we allow access to most internet sites (such
    as Google) but block access to sites with keywords such as "pornography" or which
    are contained on a blacklist. In this situation, the proxy server accomplishes
    the goals of our IT Policy by providing content filtering. It also sanitizes the
    content to ensure that only valid HTTP traffic is allowed, and not connections
    for arbitrary applications (such as Skype or MSN), which our IT Policy disallows.
    If a second client now requests the same page, the proxy server can deliver the
    cached copy (eliminating step 3) significantly quicker than the first time around,
    delivering a better service for clients and reducing the load on the internet
    connection. The proxy server essentially does the 'heavy lifting' for the client
    itself.
  id: totrans-173
  prefs: []
  type: TYPE_NORMAL
- en: In a firewalling role, the principle advantage of a proxy server, aside from
    the ability to more effectively restrict users from accessing certain resources,
    is the fact that it sanitizes, to a certain degree, data going into and out of
    the network. Since in order for traffic to go out of, or come into, the network
    it must conform to the standards pertaining to web pages, which a web proxy understands,
    'out of band' or non-standard data is significantly harder to get into/out of
    the security perimeter.
  id: totrans-174
  prefs: []
  type: TYPE_NORMAL
- en: Some packages, such as the open-source package Zorp and Microsoft's ISA server,
    will also proxy other protocols, such as RPC—this is a relatively new entrant
    to the firewalling world, and it is less common to see firewalls deployed with
    this sort of functionality outside enterprise networks.
  id: totrans-175
  prefs: []
  type: TYPE_NORMAL
- en: Other Services Sometimes Run on Firewalls
  id: totrans-176
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: Although in enterprise scenarios (such as the example of network topology listed
    earlier in this chapter) firewalls, routers, and proxy servers are generally separate
    devices, in smaller networks (and even some larger ones), roles are very frequently
    combined. Even in a large enterprise, in our branch office, it might not make
    economic sense to have three network infrastructure servers (firewall, router,
    proxy server) and three desktop infrastructure servers (fileserver, mail server,
    print server) if the office only has a staff of 50! By putting all of our network
    tasks on one host running something such as IPCop, and handling our desktop services
    off one server, we cut our equipment by 2/3, and possibly improve performance
    (since we can put those services on higher-specification machines). Our easier-to-manage
    environment requires less electricity, reduced air conditioning, and takes up
    less space.
  id: totrans-177
  prefs: []
  type: TYPE_NORMAL
- en: DNS
  id: totrans-178
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: DNS, the Domain Name System ([http://www.dns.net/dnsrd/rfc/](http://www.dns.net/dnsrd/rfc/)),
    is the system used across the Internet (and on private networks) to translate
    hostnames into IP addresses. As with previous topics, this is a very basic, simplistic
    explanation of what DNS does—this is designed to give a basic understanding of
    the topic, and not breed DNS experts. There have been many books written on the
    theory and practicalities of DNS ([http://www.packtpub.com/DNS/book](http://www.packtpub.com/DNS/book)
    being one such example), and it is outside our scope to recreate them here.
  id: totrans-179
  prefs: []
  type: TYPE_NORMAL
- en: In addition to a default gateway and/or proxy server for internet access, clients
    are assigned a DNS server, which allows them to look up an Internet Protocol address
    for any given DNS domain name. When a connection is made to another host, a network
    client will issue a lookup request to the first DNS server that it has been assigned,
    asking for an A record (unless it is connecting to a service such as SMTP, which
    uses its own specific record, in this instance MX, for configuration).
  id: totrans-180
  prefs: []
  type: TYPE_NORMAL
- en: The DNS server returns to the client an IP address, or more than one IP address,
    which the client then uses to connect to the site via the default gateway or to
    issue a request to the proxy server for connectivity. In many instances there
    is one IP address defined as the A record for a website, which the client will
    connect to, but in some instances, typically for larger sites, there are several—in
    these instances, they will be returned in a random order by the responding DNS
    server each time they are requested, using this order to balance traffic across
    all of the IP addresses. This technique is known as "round-robin DNS", and a prime
    example of a site using this is Google.
  id: totrans-181
  prefs: []
  type: TYPE_NORMAL
- en: Email uses MX records to indicate where email for a particular domain should
    go to. Each MX record listed for a domain will typically have its own 'preference
    number'—convention is that the lowest preference number is the most important
    mail server, so it is quite a frequent occurrence for a domain name to have two
    (or more) MX records set up, a primary (with a priority of, for instance, 10)
    for a main mail server, and a secondary (with a priority of, for instance, 50)
    pointing to a backup MX server in case the primary is down.
  id: totrans-182
  prefs: []
  type: TYPE_NORMAL
- en: 'Using the `dig` or `host` commands on a Unix or Linux system (or a Windows
    system with the cygwin toolkit installed), or using the `nslookup` command in
    Windows (or Unix/Linux), we can retrieve the IP addresses listed for a given domain
    name and (with a recent version of the `host` command) the MX records for it,
    like so:'
  id: totrans-183
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE0]'
  id: totrans-184
  prefs: []
  type: TYPE_PRE
  zh: '[PRE0]'
- en: 'The `dig` command (which takes as input the type of record to retrieve as the
    first argument) can also be used to troubleshoot this, as follows:'
  id: totrans-185
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE1]'
  id: totrans-186
  prefs: []
  type: TYPE_PRE
  zh: '[PRE1]'
- en: As a perfect demonstration of round-robin DNS, we can see that the MX records
    were returned in a different order (2341, 3412) each time we queried for them,
    spreading out the load among them.
  id: totrans-187
  prefs: []
  type: TYPE_NORMAL
- en: 'The `nslookup` command in Windows may be used as follows in interactive mode
    to look up MX records (or A records, which are the default, without setting an
    explicit record type) as follows:'
  id: totrans-188
  prefs: []
  type: TYPE_NORMAL
- en: '![DNS](img/1361_01_08.jpg)'
  id: totrans-189
  prefs: []
  type: TYPE_IMG
- en: This knowledge can often be useful when troubleshooting firewall and networking
    problems, as DNS failure is one of many problems that can prevent connectivity
    (and is virtually the number one cause of malfunctions in misconfigured Active
    Directory environments). Knowledge of DNS (and how to look up DNS records manually)
    and knowing how to use the `ping` command are the first two tools in the IT Professional's
    toolkit for debugging connectivity issues. The `ping` command is often useful
    for troubleshooting connectivity, although frequently the layer-four protocol
    that `ping` uses, icmp, is firewalled either at the client side or at the destination
    ([www.microsoft.com](http://www.microsoft.com) is an example of a website that
    drops ICMP packets), so the lack of a `ping` response cannot always be relied
    upon as a clear indicator of connectivity issues.
  id: totrans-190
  prefs: []
  type: TYPE_NORMAL
  zh: 在排除防火墙和网络问题时，这些知识通常会很有用，因为DNS故障是可能导致连接失败的许多问题之一（也是在配置错误的Active Directory环境中几乎是故障的主要原因）。了解DNS（以及如何手动查找DNS记录）和如何使用`ping`命令是IT专业人员用于调试连接问题的工具包中的前两个工具。`ping`命令通常用于排除连接问题，尽管经常使用的`ping`所使用的第四层协议icmp在客户端或目的地处被防火墙屏蔽（[www.microsoft.com](http://www.microsoft.com)是一个丢弃ICMP数据包的网站的例子），因此`ping`无响应并不总是可以作为连接问题的明确指标。
- en: IPCop includes a DNS server, which, set up by default, acts as a resolving name
    server—that is to say, it will accept DNS requests from clients and resolve them
    externally, passing the results back to clients on the local network. As with
    a web proxy server, this can speed up requests when the resolving name server
    has a cached copy of the domain/IP correlation, which it can pass back to a client
    without the added milliseconds of resolving it fully. Clients can also be configured
    to make their own DNS queries through the firewall to an external DNS server,
    but this is inefficient, opens unnecessary ports through the firewall, and is
    generally not a recommended configuration.
  id: totrans-191
  prefs: []
  type: TYPE_NORMAL
  zh: IPCop包括一个DNS服务器，默认设置为作为解析名称服务器，即它将接受来自客户端的DNS请求并在外部解析，将结果传递回本地网络上的客户端。与Web代理服务器一样，当解析名称服务器具有域名/IP对应关系的缓存副本时，它可以将其传递回客户端，而无需完全解析，从而加快请求速度。客户端也可以配置通过防火墙向外部DNS服务器进行自己的DNS查询，但这是低效的，会通过防火墙打开不必要的端口，并且通常不建议这样配置。
- en: DHCP
  id: totrans-192
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: DHCP
- en: DHCP, the Dynamic Host Configuration Protocol, is a descendant of BOOTP, an
    earlier protocol, and is used to configure hosts on a network automatically with
    network addresses and other configuration information, such as gateway and DNS
    server information. DHCP works using broadcast traffic—very simply, a client configured
    to use DHCP sends out a UDP packet with a DHCPDISCOVER message to the address
    255.255.255.255 (a broadcast address, forwarded to every host in the same subnet)
    when it connects to a network, requesting a DHCP server.
  id: totrans-193
  prefs: []
  type: TYPE_NORMAL
  zh: DHCP（动态主机配置协议）是BOOTP的后代，用于自动配置网络上的主机的网络地址和其他配置信息，如网关和DNS服务器信息。DHCP使用广播流量——简单地说，配置为使用DHCP的客户端在连接到网络时会向地址255.255.255.255（广播地址，转发到同一子网中的每个主机）发送一个带有DHCPDISCOVER消息的UDP数据包，请求DHCP服务器。
- en: Based on the client's request, a DHCP server on the network segment will send
    a DHCPOFFER request back, specifying an IP address it offers to the client. Generally
    speaking, a client will only be offered one IP address by one server (it's fairly
    rare for more than one DHCP server to be running on the same network segment),
    but in the event that there is more than one server, the client will pick one
    of the offered IP addresses. The client then returns a DHCPREQUEST message to
    the broadcast address, requesting the configuration it has picked. All things
    going well, the server returns a DHCPACK message to the client to confirm that
    it can have the assigned configuration information.
  id: totrans-194
  prefs: []
  type: TYPE_NORMAL
  zh: 根据客户的要求，网络段上的DHCP服务器将发送一个DHCPOFFER请求，指定它向客户端提供的IP地址。一般来说，一个客户端只会被一个服务器提供一个IP地址（在同一网络段上运行多个DHCP服务器的情况非常罕见），但如果有多个服务器的情况，客户端将选择其中一个提供的IP地址。然后客户端向广播地址返回一个DHCPREQUEST消息，请求它选择的配置。如果一切顺利，服务器将返回一个DHCPACK消息给客户端，确认它可以获得分配的配置信息。
- en: DHCP, in addition to an IP address, is also capable of assigning a variety of
    other configuration information, the most common few options being DNS servers,
    WINS servers, Gateway, Subnet Mask, NTP servers, and DNS Domain Name. IPCop includes
    a DHCP implementation configured by default to hand out the requisite information
    to use the IPCop server for internet access, and uses *Dynamic DNS* to populate
    the DNS server with hostnames sent out by DHCP requests, such that there are DNS
    entries set up for clients on the network when they request configuration via
    DHCP.
  id: totrans-195
  prefs: []
  type: TYPE_NORMAL
  zh: 除了IP地址外，DHCP还能够分配各种其他配置信息，最常见的几个选项包括DNS服务器、WINS服务器、网关、子网掩码、NTP服务器和DNS域名。IPCop包括一个DHCP实现，默认配置为向客户端分发使用IPCop服务器进行互联网访问所需的信息，并使用动态DNS来通过DHCP请求发送的主机名填充DNS服务器，以便在客户端通过DHCP请求配置时为网络上的客户端设置DNS条目。
- en: DHCP configuration (or static network configuration) can be viewed on a client
    device in Windows using the '`ipconfig /a`' command or, in Unix/Linux, using the
    '`ifconfig -a`' command. In Windows, the `ipconfig` command also allows the user
    to release and renew DHCP information.
  id: totrans-196
  prefs: []
  type: TYPE_NORMAL
  zh: 在Windows上，可以使用`ipconfig /a`命令查看DHCP配置（或静态网络配置），在Unix/Linux上，可以使用`ifconfig -a`命令。在Windows上，`ipconfig`命令还允许用户释放和更新DHCP信息。
- en: Summary
  id: totrans-197
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 总结
- en: In this chapter, we have covered topics like where the Internet came from, some
    of the design considerations that went into it, and why firewalls are important
    and fit into the grand scheme of things. We also took a look at basic networking,
    including how network layers are significant and what they do, some different
    types of firewall, and some other services firewalls may operate.
  id: totrans-198
  prefs: []
  type: TYPE_NORMAL
  zh: 在本章中，我们涵盖了一些关于互联网的起源，一些设计考虑因素以及防火墙的重要性以及其在整个体系中的适应性。我们还了解了基本的网络，包括网络层的重要性及其功能，一些不同类型的防火墙以及防火墙可能运行的一些其他服务。
- en: We should by this point have a relatively good understanding of the scope of
    the protocols and technology used in IPCop. We may also have identified some technologies
    that you hadn't heard of or didn't understand—don't worry, this is a good thing!
    If so inclined, there is plenty of scope to learn about these technologies based
    on the information summarized here and the links given to other resources.
  id: totrans-199
  prefs: []
  type: TYPE_NORMAL
  zh: 到目前为止，我们应该对IPCop中使用的协议和技术的范围有相对良好的理解。我们可能还发现了一些你之前没有听说过或不理解的技术，不用担心，这是件好事！如果有兴趣，可以根据这里总结的信息和提供的其他资源链接来学习这些技术。

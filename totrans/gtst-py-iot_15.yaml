- en: Requests and Web Frameworks
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: The main topics of this chapter are requests and web frameworks in Python. We
    are going to discuss libraries and frameworks that enable retrieving data from
    the Web (for example, get weather updates), upload data to a remote server (for
    example, log sensor data), or control appliances on a local network. We will also
    discuss topics that will help with learning the core topics of this chapter.
  prefs: []
  type: TYPE_NORMAL
- en: The try/except keywords
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: So far, we have reviewed and tested all our examples assuming the ideal condition,
    that is, the execution of the program will encounter no errors. On the contrary,
    applications fail from time to time either due to external factors, such as invalid
    user input and poor Internet connectivity, or program logic errors caused by the
    programmer. In such cases, we want the program to report/log the nature of error
    and either continue its execution or clean up resources before exiting the program.
    The `try`/`except` keywords offer a mechanism to trap an error that occurs during
    a program's execution and take remedial action. Because it is possible to trap
    and log an error in crucial parts of the code, the `try`/`except` keywords are
    especially useful while debugging an application.
  prefs: []
  type: TYPE_NORMAL
- en: 'Let''s understand the `try`/`except` keywords by comparing two examples. Let''s
    build a simple guessing game where the user is asked to guess a number between
    0 and 9:'
  prefs: []
  type: TYPE_NORMAL
- en: A random number (between 0 and 9) is generated using Python's `random` module.
    If the user's guess of the generated number is right, the Python program declares
    the user as the winner and exits the game.
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: If the user input is the letter `x`, the program quits the game.
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: The user input is converted into an integer using the `int()` function. A sanity
    check is performed to determine whether the user input is a number between 0 and
    9.
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: The integer is compared against a random number. If they are the same, the user
    is declared the winner and the program exits the game.
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: 'Let''s observe what happens when we deliberately provide an erroneous input
    to this program (the code snippet shown here is available for download along with
    this chapter as `guessing_game.py`):'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE0]'
  prefs: []
  type: TYPE_PRE
- en: 'Let''s execute the preceding code snippet and provide the input `hello` to
    the program:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE1]'
  prefs: []
  type: TYPE_PRE
- en: 'In the preceding example, the program fails when it is trying to convert the
    user input `hello` to an integer. The program execution ends with an exception.
    An exception highlights the line where the error has occurred. In this case, it
    has occurred in line 10:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE2]'
  prefs: []
  type: TYPE_PRE
- en: 'The nature of the error is also highlighted in the exception. In this example,
    the last line indicates that the exception thrown is `ValueError`:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE3]'
  prefs: []
  type: TYPE_PRE
- en: 'Let''s discuss the same example (available for download along with this chapter
    as `try_and_except.py`) that makes use of the `try`/`except` keywords. It is possible
    to continue playing the game after trapping this exception and printing it to
    the screen. We have the following code:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE4]'
  prefs: []
  type: TYPE_PRE
- en: 'Let''s discuss how the same example works with the `try`/`except` keywords:'
  prefs: []
  type: TYPE_NORMAL
- en: From the previous example, we know that when a user provides the wrong input
    (for example, a letter instead of a number between 0 and 9), the exception occurs
    at line 10 (where the user input is converted into an integer), and the nature
    of the error is named `ValueError`.
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: 'It is possible to avoid interruption of the program''s execution by wrapping
    this in a `try...except` block:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE5]'
  prefs: []
  type: TYPE_PRE
- en: On receiving a user input, the program attempts converting the user input into
    an integer under the `try` block.
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: 'If `ValueError` has occurred, `error` is trapped by the `except` block, and
    the following message is printed to the screen along with the actual error message:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE6]'
  prefs: []
  type: TYPE_PRE
- en: 'Try executing the code example and try providing an invalid input. You will
    note that the program prints the error message (along with the nature of the error)
    and goes back to the top of the game loop and continues seeking valid user input:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE7]'
  prefs: []
  type: TYPE_PRE
- en: The `try...except` block comes with a substantial processing power cost. Hence,
    it is important to keep the `try...except` block as short as possible. Because
    we know that the error occurs on the line where we attempt converting the user
    input into an integer, we wrap it in a `try...except` block to trap an error.
  prefs: []
  type: TYPE_NORMAL
- en: Thus, the `try`/`except` keywords are used to prevent any abnormal behavior
    in a program's execution due to an error. It enables logging the error and taking
    remedial action. Similar to the `try...except` block, there are also `try...except...else`
    and `try...except...else` code blocks. Let's quickly review those options with
    a couple of examples.
  prefs: []
  type: TYPE_NORMAL
- en: try...except...else
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: 'The `try...except...else` block is especially useful when we want a certain
    block of code to be executed only when no exceptions are raised. In order to demonstrate
    this concept, let''s rewrite the guessing game example using this block:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE8]'
  prefs: []
  type: TYPE_PRE
- en: The modified guessing game example that makes use of the `try...except...else` block
    is available for download along with this chapter as `try_except_else.py`. In
    this example, the program compares the user input against the random number only
    if a valid user input was received. It otherwise skips the `else` block and goes
    back to the top of the loop to accept the next user input. Thus, `try...except...else` is
    used when we want a specific code block to be executed when no exceptions are
    raised due to the code in the `try` block.
  prefs: []
  type: TYPE_NORMAL
- en: try...except...else...finally
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: As the name suggests, the `finally` block is used to execute a block of code
    on leaving the `try` block. This block of code is executed even after an exception
    is raised. This is useful in scenarios where we need to clean up resources and
    free up memory before moving on to the next stage.
  prefs: []
  type: TYPE_NORMAL
- en: 'Let''s demonstrate the function of the `finally` block using our guessing game.
    To understand how the `finally` keyword works, let''s make use of a counter variable
    named `count` that is incremented in the `finally` block, and another counter
    variable named `valid_count` that is incremented in the `else` block. We have
    the following code:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE9]'
  prefs: []
  type: TYPE_PRE
- en: 'The preceding code snippet is from the `try_except_else_finally.py` code sample (available
    for download along with this chapter). Try executing the code sample and playing
    the game. You will note the total number of attempts it took to win the game and
    the number of inputs that were valid:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE10]'
  prefs: []
  type: TYPE_PRE
- en: This demonstrates how the `try-except-else-finally` block works. Any code under
    the `else` keyword is executed when the critical code block (under the `try` keyword)
    is executed successfully, whereas the code block under the `finally` keyword is
    executed while exiting the `try...except` block (useful for cleaning up resources
    while exiting a code block).
  prefs: []
  type: TYPE_NORMAL
- en: Try providing invalid inputs while playing the game using the previous code
    example to understand the code block flow.
  prefs: []
  type: TYPE_NORMAL
- en: Connecting to the Internet – web requests
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: Now that we discussed the `try`/`except` keywords, let's make use of it to build
    a simple application that connects to the Internet. We will write a simple application
    that retrieves the current time from the Internet. We will be making use of the
    `requests` library for Python ([http://requests.readthedocs.io/en/master/#](http://requests.readthedocs.io/en/master/#)).
  prefs: []
  type: TYPE_NORMAL
- en: 'The `requests` module enables connecting to the Web and retrieving information.
    In order to do so, we need to make use of the `get()` method from the `requests`
    module to make a request:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE11]'
  prefs: []
  type: TYPE_PRE
- en: In the preceding code snippet, we are passing a URL as an argument to the `get()`
    method. In this case, it is the URL that returns the current time in the Unix
    format ([https://en.wikipedia.org/wiki/Unix_time](https://en.wikipedia.org/wiki/Unix_time)).
  prefs: []
  type: TYPE_NORMAL
- en: 'Let''s make use of the `try`/`except` keywords to make a request to get the
    current time:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE12]'
  prefs: []
  type: TYPE_PRE
- en: In the preceding example (available for download along with this chapter as
    `internet_access.py`), the request is made under the `try` block, and the response
    (returned by `response.text`) is printed to the screen.
  prefs: []
  type: TYPE_NORMAL
- en: 'If there is an error while executing the request to retrieve the current time,
    `ConnectionError` is raised ([http://requests.readthedocs.io/en/master/user/quickstart/#errors-and-exceptions](http://requests.readthedocs.io/en/master/user/quickstart/#errors-and-exceptions)).
    This error could either be caused by the lack of an Internet connection or an
    incorrect URL. This error is caught by the `except` block. Try running the example,
    and it should return the current time from `time.gov`:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE13]'
  prefs: []
  type: TYPE_PRE
- en: The application of requests – retrieving weather information
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: 'Let''s make use of the `requests` module to retrieve the weather information
    for the city of San Francisco. We will be making use of the **OpenWeatherMap**
    API ([openweathermap.org](http://openweathermap.org)) to retrieve the weather
    information:'
  prefs: []
  type: TYPE_NORMAL
- en: 'In order to make use of the API, sign up for an API account and get an API
    key (it is free of charge):'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '![](Images/e491b6d7-eedd-4706-a6c2-7ffe0ae779fb.png)An API key from openweathermap.org'
  prefs: []
  type: TYPE_NORMAL
- en: According to the API documentation ([openweathermap.org/current](http://openweathermap.org/current)),
    the weather information for a city can be retrieved using `http://api.openweathermap.org/data/2.5/weather?zip=SanFrancisco&appid=API_KEY&units=imperial`
    as the URL.
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: 'Substitute `API_KEY` with the key from your account and use it to retrieve
    the current weather information in a browser. You should be able to retrieve the
    weather information in the following format:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE14]'
  prefs: []
  type: TYPE_PRE
- en: The weather information (shown previously) is returned in the JSON format. **JavaScript
    Object Notation** (**JSON**) is a data format that is widely used to exchange
    data over the Web. The main advantage of JSON format is that it is in a readable
    format and many popular programming languages support encapsulating data in JSON
    format. As shown in the earlier snippet, JSON format enables exchanging information
    in readable name/value pairs.
  prefs: []
  type: TYPE_NORMAL
- en: 'Let''s review retrieving the weather using the `requests` module and parsing
    the JSON data:'
  prefs: []
  type: TYPE_NORMAL
- en: Substitute the URL in the previous example (`internet_access.py`) with the one
    discussed in this example. This should return the weather information in the JSON
    format.
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: 'The requests module provides a method to parse the JSON data. The response
    could be parsed as follows:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE15]'
  prefs: []
  type: TYPE_PRE
- en: The `json()` function parses the response from the OpenWeatherMap API and returns
    a dictionary of different weather parameters (`json_data`) and their values.
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: 'Since we know the response format from the API documentation, the current temperature
    could be retrieved from the parsed response as follows:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE16]'
  prefs: []
  type: TYPE_PRE
- en: 'Putting it all together, we have this:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE17]'
  prefs: []
  type: TYPE_PRE
- en: 'The preceding example is available for download along with this chapter as
    `weather_example.py`. The example should display the current temperature as follows:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE18]'
  prefs: []
  type: TYPE_PRE
- en: The application of requests – publishing events to the Internet
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: In the previous example, we retrieved information from the Internet. Let's consider
    an example where we have to publish a sensor event somewhere on the Internet.
    This could be either a cat door opening while you are away from home or someone
    at your doorstep stepping on the doormat. Because we discussed interfacing sensors
    to the Raspberry Pi Zero in the previous chapter, let's discuss a scenario where
    we could post these events to *Slack*—a workplace communication tool, Twitter,
    or cloud services such as **Phant** ([https://data.sparkfun.com/](https://data.sparkfun.com/)).
  prefs: []
  type: TYPE_NORMAL
- en: 'In this example, we will post these events to Slack using `requests`. Let''s
    send a direct message to ourselves on Slack whenever a sensor event such as a
    cat door opening occurs. We need a URL to post these sensor events to Slack. Let''s
    review generating a URL in order to post sensor events to Slack:'
  prefs: []
  type: TYPE_NORMAL
- en: The first step in generating a URL is creating an *incoming webhook*. A webhook
    is a type request that can post messages that are carried as a payload to applications
    such as Slack.
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: 'If you are a member of a Slack team named *TeamX*, launch your team''s application
    directory, namely `teamx.slack.com/apps` in a browser:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '![](Images/dea1e47a-e8f1-4848-b40e-1cdd2836fcbc.png)Launch your team''s app
    directory'
  prefs: []
  type: TYPE_NORMAL
- en: 'Search for `incoming webhooks` in your app directory and select the first option,
    Incoming WebHooks (as shown in the following screenshot):'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '![](Images/bb557455-62ba-4716-8699-695bbf6be867.png)Select incoming webhooks'
  prefs: []
  type: TYPE_NORMAL
- en: 'Click on Add Configuration:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '![](Images/2b0b1d70-c3f9-4f41-bbfb-ea0b0ed6c3a8.png)Add Configuration'
  prefs: []
  type: TYPE_NORMAL
- en: 'Let''s send a private message to ourselves when an event occurs. Select Privately
    to           (you) as the option and create a webhook by clicking on Add Incoming
    WebHooks integration:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '![](Images/e37bc0b4-1cce-4840-9313-f2bfe7d0b60e.png)Select Privately to you'
  prefs: []
  type: TYPE_NORMAL
- en: 'We have generated a URL to send direct messages about sensor events (URL partially
    concealed):'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '![](Images/21db2e44-ca8f-4a25-acd3-355752853efa.png)Generated URL'
  prefs: []
  type: TYPE_NORMAL
- en: Now, we can send direct message to ourselves on Slack using the previously-mentioned
    URL. The sensor event can be published to Slack as a JSON payload. Let's review
    posting a sensor event to Slack.
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: 'For example, let''s consider posting a message when a cat door opens. The first
    step is preparing the JSON payload for the message. According to the Slack API
    documentation ([https://api.slack.com/custom-integrations)](https://api.slack.com/custom-integrations)),
    the message payload needs to be in the following format:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE19]'
  prefs: []
  type: TYPE_PRE
- en: 'In order to publish this event, we will make use of the `post()` method from
    the `requests` module. The data payload needs to be encoded in JSON format while
    posting it:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE20]'
  prefs: []
  type: TYPE_PRE
- en: 'Putting it all together, we have this:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE21]'
  prefs: []
  type: TYPE_PRE
- en: On posting the message, the request returns `ok` as a response. This indicates
    that the post was successful.
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: 'Generate your own URL and execute the preceding example (available for download
    along with this chapter as `slack_post.py`). You will receive a direct message
    on Slack:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '![](Images/b593e295-094d-403e-a245-a79068060b26.png)Direct message on Slack'
  prefs: []
  type: TYPE_NORMAL
- en: Now, try interfacing a sensor to the Raspberry Pi Zero (discussed in previous
    chapters) and post the sensor events to Slack.
  prefs: []
  type: TYPE_NORMAL
- en: It is also possible to post sensor events to Twitter and have your Raspberry
    Pi Zero check for new e-mails and so on. Check this book's website for more examples.
  prefs: []
  type: TYPE_NORMAL
- en: Flask web framework
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: In our final section, we will discuss web frameworks in Python. We will discuss
    the Flask framework ([http://flask.pocoo.org/](http://flask.pocoo.org/)). Python-based
    frameworks enable interfacing sensors to a network using the Raspberry Pi Zero.
    This enables controlling appliances and reading data from sensors from anywhere
    within a network. Let's get started!
  prefs: []
  type: TYPE_NORMAL
- en: Installing Flask
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: 'The first step is installing the Flask framework. It can be done as follows:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE22]'
  prefs: []
  type: TYPE_PRE
- en: Building our first example
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: 'The Flask framework documentation explains building the first example. Modify
    the example from the documentation as follows:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE23]'
  prefs: []
  type: TYPE_PRE
- en: 'Launch this example (available for download along with this chapter as `flask_example.py`)
    and it should launch a server on the Raspberry Pi Zero visible to the network.
    On another computer, launch a browser and enter the IP address of the Raspberry
    Pi Zero along with port number, `5000`, as a suffix (as shown in the following
    snapshot). It should take you to the index page of the server that displays the
    message Hello World!:'
  prefs: []
  type: TYPE_NORMAL
- en: '![](Images/c515611e-7de9-40cc-a867-0fbc6cd43c88.png)The Flask framework-based
    web server on the Raspberry Pi Zero'
  prefs: []
  type: TYPE_NORMAL
- en: You can find the IP address of your Raspberry Pi Zero using the `ifconfig` command
    on the command-line terminal.
  prefs: []
  type: TYPE_NORMAL
- en: Controlling appliances using the Flask framework
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: 'Let''s try turning on/off appliances at home using the Flask framework. In
    previous chapters, we made use of *PowerSwitch Tail II* to control a table lamp
    using the Raspberry Pi Zero. Let''s try to control the same using the Flask framework.
    Connect PowerSwitch Tail, as shown in the following figure:'
  prefs: []
  type: TYPE_NORMAL
- en: '![](Images/587aacf5-ad6d-45f6-bc42-214248b72183.png)Controlling a table lamp
    using the Flask framework'
  prefs: []
  type: TYPE_NORMAL
- en: 'According to the Flask framework documentation, it is possible to route a URL
    to a specific function. For example, it is possible to bind `/lamp/<control>`
    using `route()` to the `control()` function:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE24]'
  prefs: []
  type: TYPE_PRE
- en: 'In the preceding code snippet, `<control>` is a variable that can be passed
    on as an argument to the binding function. This enables us to turn the lamp on/off.
    For example, `<IP address>:5000/lamp/on` turns on the lamp, and vice versa. Putting
    it all together, we have this:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE25]'
  prefs: []
  type: TYPE_PRE
- en: 'The preceding example is available for download along with this chapter as
    `appliance_control.py`. Launch the Flask-based web server and open a web server
    on another computer. In order to turn on the lamp, enter `<IP Address of the Raspberry
    Pi Zero>:5000/lamp/on` as URL:'
  prefs: []
  type: TYPE_NORMAL
- en: 'This should turn on the lamp:'
  prefs: []
  type: TYPE_NORMAL
- en: '![](Images/06292c52-263d-41b8-bf2c-9cb2503a77dd.png)'
  prefs: []
  type: TYPE_IMG
- en: Thus, we have built a simple framework that enables controlling appliances within
    the network. It is possible to include buttons to an HTML page and route them
    to a specific URL to perform a specific function. There are several other frameworks
    in Python that enable developing web applications. We have merely introduced you
    to different applications that are possible with Python. We recommend that you check
    out this book's website for more examples, such as controlling Halloween decorations
    and other holiday decorations using the Flask framework.
  prefs: []
  type: TYPE_NORMAL
- en: Summary
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: In this chapter, we discussed the `try`/`except` keywords in Python. We also
    discussed developing applications that retrieves information from the Internet,
    as well as publishing sensor events to the Internet. We also discussed the Flask
    web framework for Python and demonstrated the control of appliances within a network.
    In the next chapter, we will discuss some advanced topics in Python.
  prefs: []
  type: TYPE_NORMAL

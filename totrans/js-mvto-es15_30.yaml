- en: Chapter 2. Building a Coupon Site
  id: totrans-0
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 第2章。构建优惠券网站
- en: The best way to understand Seneca and microservices architecture is by building
    a server-side application that would benefit from the microservices architecture.
    In previous chapter, we saw how large and complex server-side application benefits
    from the microservices architecture and why enterprises use microservices architecture.
    In this chapter, we will build a coupon website to practically demonstrate the
    benefits of using microservices architecture and Seneca to create a server-side
    application. While building this coupon site, you will also learn how to design
    a server-side application using the microservices architecture from scratch, how
    to split the functionality of the application into services, how a client can
    directly communicate with the services, and many other things.
  id: totrans-1
  prefs: []
  type: TYPE_NORMAL
  zh: 了解Seneca和微服务架构的最佳方法是构建一个从微服务架构中受益的服务器端应用。在上一章中，我们看到了大型和复杂的服务器端应用如何从微服务架构中受益，以及为什么企业使用微服务架构。在本章中，我们将构建一个优惠券网站，以实际演示使用微服务架构和Seneca创建服务器端应用的好处。在构建这个优惠券网站的过程中，您还将学习如何从头开始设计一个使用微服务架构的服务器端应用，如何将应用的功能拆分为服务，客户端如何直接与服务通信，以及许多其他内容。
- en: 'Some of the things that we will cover in this chapter, apart from things related
    to Seneca and microservices architecture, are as follows:'
  id: totrans-2
  prefs: []
  type: TYPE_NORMAL
  zh: 除了与Seneca和微服务架构相关的内容外，本章还将涵盖以下内容：
- en: Using the `seneca-mongo-store` plugin to store data in MongoDB
  id: totrans-3
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 使用`seneca-mongo-store`插件在MongoDB中存储数据
- en: Creating a basic image storage server
  id: totrans-4
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 创建基本的图像存储服务器
- en: Discussing HTTP basic authentication using the basic-auth npm package
  id: totrans-5
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 讨论使用basic-auth npm包进行HTTP基本身份验证
- en: Using the connect-multiparty npm package to parse HTTP POST requests with the
    `multipart/form-data` content type
  id: totrans-6
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 使用connect-multiparty npm包来解析带有`multipart/form-data`内容类型的HTTP POST请求
- en: Moving, deleting, and renaming files in Node.js using the `fs` npm package
  id: totrans-7
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 在Node.js中使用`fs`npm包移动、删除和重命名文件
- en: Implementing pagination with MongoDB and Express
  id: totrans-8
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 使用MongoDB和Express实现分页
- en: Getting started
  id: totrans-9
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 入门
- en: The coupon site that we will build will allow users to submit coupons. For the
    coupon to be publicly visible, the administrator of the site should accept the
    coupon. Every coupon will have an image attached to it that will be stored and
    served by an image storage server.
  id: totrans-10
  prefs: []
  type: TYPE_NORMAL
  zh: 我们将构建的优惠券网站将允许用户提交优惠券。要使优惠券公开可见，网站管理员应接受优惠券。每张优惠券都附有一个图像，该图像将由图像存储服务器存储和提供。
- en: We will be using MongoDB to store the coupons. Before you continue further,
    make sure that you have MongoDB installed and running. I am assuming that you
    have basic knowledge of MongoDB.
  id: totrans-11
  prefs: []
  type: TYPE_NORMAL
  zh: 我们将使用MongoDB来存储优惠券。在继续之前，请确保您已安装并运行MongoDB。我假设您对MongoDB有基本的了解。
- en: 'The exercise files contain two directories: `Initial` and `Final`. Inside the
    `Final` directory, you will find the complete coupon site source code. In the
    `Initial` directory, you will find the HTML code and directories for the monolithic
    core, services, image storage server, and so on. You will put code related to
    them in their respective directories. The `Initial` directory will help you quickly
    get started with building the coupon site.'
  id: totrans-12
  prefs: []
  type: TYPE_NORMAL
  zh: 练习文件包含两个目录：`Initial`和`Final`。在`Final`目录中，您将找到完整的优惠券网站源代码。在`Initial`目录中，您将找到HTML代码和单体核心、服务、图像存储服务器等目录。您将把与它们相关的代码放在各自的目录中。`Initial`目录将帮助您快速开始构建优惠券网站。
- en: We won't get into designing the frontend of our coupon site. We will only be
    concentrating on building the architecture and functionalities of the site. Therefore,
    the HTML code is already included in the `Initial` directory.
  id: totrans-13
  prefs: []
  type: TYPE_NORMAL
  zh: 我们不会涉及设计我们优惠券网站的前端。我们只会集中在构建网站的架构和功能上。因此，HTML代码已经包含在`Initial`目录中。
- en: Architecture of our site
  id: totrans-14
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 我们网站的架构
- en: Our server-side application will be composed of a monolithic core, three services,
    MongoDB server, and image storage server.
  id: totrans-15
  prefs: []
  type: TYPE_NORMAL
  zh: 我们的服务器端应用将由单体核心、三项服务、MongoDB服务器和图像存储服务器组成。
- en: The monolithic core will serve pages to the site visitors and administrators.
  id: totrans-16
  prefs: []
  type: TYPE_NORMAL
  zh: 单体核心将为网站访问者和管理员提供页面。
- en: 'The three services are database service, URL configuration service, and upload
    service. The following is what each of these services do:'
  id: totrans-17
  prefs: []
  type: TYPE_NORMAL
  zh: 三项服务是数据库服务、URL配置服务和上传服务。以下是这些服务各自的功能：
- en: '**Database service**: Adding, retrieving, updating, and deleting coupons in
    MongoDB is done through database service. The monolithic core retrieves coupons
    from MongoDB through database service, and upload service stores coupons through
    database service.'
  id: totrans-18
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**数据库服务**：通过数据库服务在MongoDB中添加、检索、更新和删除优惠券。单体核心通过数据库服务从MongoDB检索优惠券，上传服务通过数据库服务存储优惠券。'
- en: '**Upload service**: When a user submits a coupon, the HTML form is submitted
    to the upload service. The upload service then sends the image to the image storage
    server and adds metadata about the coupon to the database using the database service.
    We moved these operations to a different service, because if we are resizing and
    converting the uploaded image, then it will consume more memory and CPU time and
    keep the port open for more time, which will flood the server and break the monolithic
    core in case there are a large number of submissions at a time, so moving these
    operations to a different service makes sure that if there is a rise in submissions,
    it doesn''t affect the site visitors who are looking for the coupons. We won''t
    be resizing and converting images, but if you want to add this functionality,
    you can add this by simply updating the upload service. While the upload service
    is being updated, the form submissions will not work, but everything else will
    work. Therefore, we can say that this functionality can be independently updated
    without affecting other functionalities.'
  id: totrans-19
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**URL config service**: The client communicates with the monolithic core, image
    storage server, and upload service. In a production site, these three servers
    will remain in three different physical computers with three different IP addresses.
    So, for the client to be able to communicate with them, these three need to be
    exposed via different domain names (that is the monolithic core can be pointed
    using the main domain and the other two using sub domains) or we can use a load
    balancer or reverse proxy that supports URL rerouting so that we can have a single
    domain name and route the requests to the respective server based on the path
    of the URL. The URL config service will serve the base URL to communicate with
    these three servers. To follow this chapter, you can simply run these servers
    in the same physical computer using different ports, and when you are ready to
    make the site live, you can change the base URLs in the URL config service, depending
    on what technique you used to make the client able to communicate with the servers.
    You don''t have to modify the source code of the servers directly, which is a
    cumbersome and risky task.'
  id: totrans-20
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: We will be creating our own image storage server. However, in a production site,
    I would recommend that you use Amazon S3 or something similar to store images,
    as it makes it easy to serve images via CDN. You don't have to worry about scaling
    and reliability, and it's low cost. The image storage server that we will be creating
    will be a basic one to just demonstrate how to store images in a separate server
    and serve from there.
  id: totrans-21
  prefs: []
  type: TYPE_NORMAL
- en: 'The following is the diagram that shows all the architecture''s looks and how
    the servers in the architecture communicate with each other:'
  id: totrans-22
  prefs: []
  type: TYPE_NORMAL
- en: '![Architecture of our site](img/00104.jpeg)'
  id: totrans-23
  prefs: []
  type: TYPE_IMG
- en: Creating the services
  id: totrans-24
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: Let's first build the services before building the image storage server and
    monolithic core.
  id: totrans-25
  prefs: []
  type: TYPE_NORMAL
- en: We will build the database service first, as it only depends on the MongoDB
    server, which is already running. The upload service and monolithic core depend
    on it, therefore it needs to be built before these.
  id: totrans-26
  prefs: []
  type: TYPE_NORMAL
- en: Database service
  id: totrans-27
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: The database service will provide actions to add coupons, list verified coupons,
    list unverified coupons, verify a coupon, and delete a coupon. These actions will
    be used by the upload service and monolithic core.
  id: totrans-28
  prefs: []
  type: TYPE_NORMAL
- en: Open the `Initial/database-service` directory. Inside the directory, you will
    find a `package.json` file and an `app.js` file. The `app.js` file is where you
    will write the code, and `package.json` lists the dependencies for the database
    service. The database service is dependent on the `seneca` and `seneca-mongo-store`
    plugins. Run the `npm install` command inside `Initial/database-service` to install
    the dependencies locally.
  id: totrans-29
  prefs: []
  type: TYPE_NORMAL
- en: 'Here is the code to import the `seneca` module, create the `seneca` instance,
    attach the `seneca-mongo-store` plugin, and initialize the plugin to connect to
    MongoDB:'
  id: totrans-30
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE0]'
  id: totrans-31
  prefs: []
  type: TYPE_PRE
  zh: '[PRE0]'
- en: Here we are using `gocoupons` as the database name. I am assuming that the MongoDB
    server is running locally on the default port `27017`.
  id: totrans-32
  prefs: []
  type: TYPE_NORMAL
- en: 'The following is the code to create an action that allows you to add a coupon:'
  id: totrans-33
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE1]'
  id: totrans-34
  prefs: []
  type: TYPE_PRE
  zh: '[PRE1]'
- en: We will store the coupons in a collection named `coupons`. Here we are setting
    the `verified` property of the document to `false`, that is, whenever a new coupon
    is submitted by a user, we will make it unverified so that the administrator can
    retrieve this newly submitted coupon and verify it manually.
  id: totrans-35
  prefs: []
  type: TYPE_NORMAL
- en: The `thumbnail_id` property doesn't hold the complete URL of the coupon thumbnail,
    instead it's just the filename.
  id: totrans-36
  prefs: []
  type: TYPE_NORMAL
- en: 'Here is the code to create an action to retrieve the verified coupons:'
  id: totrans-37
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE2]'
  id: totrans-38
  prefs: []
  type: TYPE_PRE
  zh: '[PRE2]'
- en: This action retrieves maximum 21 coupons and it takes a `skip` argument that
    is used to skip some documents, making it possible to implement pagination using
    this action.
  id: totrans-39
  prefs: []
  type: TYPE_NORMAL
- en: 'The following is the code to create an action to retrieve the unverified coupons:'
  id: totrans-40
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE3]'
  id: totrans-41
  prefs: []
  type: TYPE_PRE
  zh: '[PRE3]'
- en: This action will be used to retrieve coupons to display on the admin panel for
    the administrator to accept or reject a coupon.
  id: totrans-42
  prefs: []
  type: TYPE_NORMAL
- en: 'Here is the code to create an action to verify a coupon, that is, change the
    `verified` property from `false` to `true`:'
  id: totrans-43
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE4]'
  id: totrans-44
  prefs: []
  type: TYPE_PRE
  zh: '[PRE4]'
- en: This action will be invoked when the admin accepts a coupon to be displayed
    publicly.
  id: totrans-45
  prefs: []
  type: TYPE_NORMAL
- en: 'Here is the code to create an action to delete a coupon:'
  id: totrans-46
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE5]'
  id: totrans-47
  prefs: []
  type: TYPE_PRE
  zh: '[PRE5]'
- en: This action will be invoked when the admin rejects a coupon.
  id: totrans-48
  prefs: []
  type: TYPE_NORMAL
- en: 'Now that we have created all the actions for our database service, let''s expose
    these actions via the network so that the other servers can call them. Here is
    the code to do this:'
  id: totrans-49
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE6]'
  id: totrans-50
  prefs: []
  type: TYPE_PRE
  zh: '[PRE6]'
- en: Now go ahead and run the database service using the `node app.js` command.
  id: totrans-51
  prefs: []
  type: TYPE_NORMAL
- en: URL config service
  id: totrans-52
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: The upload services use the URL config service to find the base URL of the monolithic
    core so that it can redirect the user there once the coupon is submitted successfully.
    Also, the monolithic core uses this service to find the base URL of the image
    storage server and upload service so that it can include them in the HTML code.
  id: totrans-53
  prefs: []
  type: TYPE_NORMAL
- en: Open the `Initial/config-service` directory. Inside the directory, you will
    find a `package.json` file and an `app.js` file. The `app.js` file is where you
    will write the code and `package.json` lists the dependencies for the config service.
    URL config service is only dependent on seneca. Run the `npm install` command
    inside `Initial/config-service` to install the dependencies locally.
  id: totrans-54
  prefs: []
  type: TYPE_NORMAL
- en: 'The following is the code to import the `seneca` module and create actions
    to return the base URLs of the upload service, monolithic core, and image storage
    server:'
  id: totrans-55
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE7]'
  id: totrans-56
  prefs: []
  type: TYPE_PRE
  zh: '[PRE7]'
- en: Now go ahead and run the URL config service using the `node app.js` command.
  id: totrans-57
  prefs: []
  type: TYPE_NORMAL
- en: Upload service
  id: totrans-58
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: The upload service handles the new coupon form submission. The form consists
    of a coupon title, URL, description, price, discount price, and a thumbnail. The
    content type of form submission is `multipart/form-data`, as it is uploading an
    image file.
  id: totrans-59
  prefs: []
  type: TYPE_NORMAL
- en: Open the `Initial/upload-service` directory. Inside the directory, you will
    find a `package.json` file and an `app.js` file. The `app.js` file is where you
    will write the code and `package.json` lists the dependencies for the upload service.
    The upload service is dependent on `seneca`, `express`, `connect-multiparty`,
    `path`, `fs` and `request` packages. Run the `npm install` command inside `Initial/upload-service`
    to install the dependencies locally.
  id: totrans-60
  prefs: []
  type: TYPE_NORMAL
- en: 'The following is the code to import the modules:'
  id: totrans-61
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE8]'
  id: totrans-62
  prefs: []
  type: TYPE_PRE
  zh: '[PRE8]'
- en: 'There are chances that the users may upload images with the same name. We don''t
    want images with the same name to overwrite each other. Therefore, we need rename
    every image with a unique name. The following is the code for defining a function
    to generate a unique number, which will be used as an image name:'
  id: totrans-63
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE9]'
  id: totrans-64
  prefs: []
  type: TYPE_PRE
  zh: '[PRE9]'
- en: 'Now, for the upload service to be able to communicate with the database and
    URL config services, we need to add them to the upload service `seneca` instance.
    The following is the code to do this:'
  id: totrans-65
  prefs: []
  type: TYPE_NORMAL
  zh: 现在，为了使上传服务能够与数据库和URL配置服务进行通信，我们需要将它们添加到上传服务的`seneca`实例中。以下是执行此操作的代码：
- en: '[PRE10]'
  id: totrans-66
  prefs: []
  type: TYPE_PRE
  zh: '[PRE10]'
- en: 'Now we need to define an express route to handle POST requests submitted to
    the `/submit` path. Inside the route handler, we will rename the image, upload
    the image to image storage server, add the metadata of the coupon to MongoDB using
    the database service, and redirect to the monolithic core with the status stating
    that the form was submitted successfully. Here is the code to define the route:'
  id: totrans-67
  prefs: []
  type: TYPE_NORMAL
  zh: 现在我们需要定义一个express路由来处理提交到`/submit`路径的POST请求。在路由处理程序内部，我们将重命名图像，将图像上传到图像存储服务器，使用数据库服务添加优惠券的元数据到MongoDB，并重定向到单体核心，状态显示表单已成功提交。以下是定义路由的代码：
- en: '[PRE11]'
  id: totrans-68
  prefs: []
  type: TYPE_PRE
  zh: '[PRE11]'
- en: 'Here is how the preceding code works:'
  id: totrans-69
  prefs: []
  type: TYPE_NORMAL
  zh: 以下是前面的代码如何工作的：
- en: First we added a callback provided by the connect-multiparty module, which parses
    the `multipart/form-data` body and moves the files to a temporary location.
  id: totrans-70
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 首先，我们添加了由connect-multiparty模块提供的回调，该回调解析`multipart/form-data`主体并将文件移动到临时位置。
- en: In the second callback, we performed our custom operations. In the second callback,
    we first renamed the file so that every image file gets a unique name. Renaming
    is done using the `rename` method of the filesystem module.
  id: totrans-71
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 在第二个回调中，我们执行了自定义操作。在第二个回调中，我们首先重命名文件，以便每个图像文件都有一个唯一的名称。重命名是使用文件系统模块的`rename`方法完成的。
- en: Then we uploaded the image file to the image storage server using the `post`
    method of the request module.
  id: totrans-72
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 然后我们使用请求模块的`post`方法将图像文件上传到图像存储服务器。
- en: After this, we deleted the local version of the image file using the `unlink`
    method of the filesystem module.
  id: totrans-73
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 完成后，我们使用文件系统模块的`unlink`方法删除了图像文件的本地版本。
- en: If uploading the image to the image storage server failed for some reason, then
    we will return an HTTP internal server error to the client.
  id: totrans-74
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 如果由于某种原因将图像上传到图像存储服务器失败，我们将向客户端返回HTTP内部服务器错误。
- en: If the image got uploaded to the image storage server successfully, then we
    will add the coupon metadata to MongoDB via the database service.
  id: totrans-75
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 如果图像成功上传到图像存储服务器，那么我们将通过数据库服务将优惠券元数据添加到MongoDB中。
- en: If, for some reason, the metadata did not get added, we will delete the previously
    stored image in the image storage server and then return an HTTP internal server
    error to the client.
  id: totrans-76
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 如果由于某种原因未添加元数据，我们将删除图像存储服务器中先前存储的图像，然后向客户端返回HTTP内部服务器错误。
- en: If the coupon metadata got added successfully, we will retrieve the base URL
    of monolithic core from the URL config service and redirect there with a `/?status=submitted`
    query string, which indicates that the form was submitted successfully. When the
    monolithic core sees this query string, it displays a message saying that the
    coupon was submitted successfully.
  id: totrans-77
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 如果优惠券元数据成功添加，我们将从URL配置服务中检索单体核心的基本URL，并带有`/?status=submitted`查询字符串重定向到那里，表示表单已成功提交。当单体核心看到此查询字符串时，它会显示一条消息，说明优惠券已成功提交。
- en: In case the URL config service didn't respond for some reason, we will return
    an HTTP internal server error to the client.
  id: totrans-78
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 如果由于某种原因URL配置服务未响应，我们将向客户端返回HTTP内部服务器错误。
- en: So what you need to keep in mind while coding such services is that you need
    to handle all sorts of failures and also roll back changes if a failure occurs.
    Now, this also makes it easy to update and redeploy the database service, URL
    config service, and image storage server as the upload service handles the failure
    of these services and provides a feedback to the user.
  id: totrans-79
  prefs: []
  type: TYPE_NORMAL
  zh: 因此，在编写此类服务时，您需要牢记需要处理各种故障，并在发生故障时回滚更改。现在，这也使得更新和重新部署数据库服务、URL配置服务和图像存储服务器变得更容易，因为上传服务处理了这些服务的故障并向用户提供了反馈。
- en: 'Now we have defined our routes. Finally, we need to start the Express server.
    The following is the code to do so:'
  id: totrans-80
  prefs: []
  type: TYPE_NORMAL
  zh: 现在我们已经定义了我们的路由。最后，我们需要启动Express服务器。以下是启动服务器的代码：
- en: '[PRE12]'
  id: totrans-81
  prefs: []
  type: TYPE_PRE
  zh: '[PRE12]'
- en: Now go ahead and run the upload service using the `node app.js` command.
  id: totrans-82
  prefs: []
  type: TYPE_NORMAL
  zh: 现在继续使用`node app.js`命令运行上传服务。
- en: Creating the image upload server
  id: totrans-83
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 创建图像上传服务器
- en: We have finished building the services. Now let's build the image storage server.
    The image storage server defines the routes using which an image can be stored,
    deleted, or retrieved.
  id: totrans-84
  prefs: []
  type: TYPE_NORMAL
  zh: 我们已经完成了构建服务。现在让我们构建图像存储服务器。图像存储服务器定义了用于存储、删除或检索图像的路由。
- en: Open the `Initial/image-storage` directory. Inside the directory, you will find
    a `package.json` file and an `app.js` file. The `app.js` file is where you will
    write the code, and `package.json` lists the dependencies for the image storage
    server. The upload service is dependent on `express`, `connect-multiparty`, `path`,
    and `fs`. Run the `npm install` command inside `Initial/image-storage` to install
    the dependencies locally.
  id: totrans-85
  prefs: []
  type: TYPE_NORMAL
  zh: 打开`Initial/image-storage`目录。在目录中，您将找到一个`package.json`文件和一个`app.js`文件。`app.js`文件是您将编写代码的地方，`package.json`列出了图像存储服务器的依赖项。上传服务依赖于`express`、`connect-multiparty`、`path`和`fs`。在`Initial/image-storage`内运行`npm
    install`命令以在本地安装依赖项。
- en: 'The following is the code to import the modules:'
  id: totrans-86
  prefs: []
  type: TYPE_NORMAL
  zh: 以下是导入模块的代码：
- en: '[PRE13]'
  id: totrans-87
  prefs: []
  type: TYPE_PRE
  zh: '[PRE13]'
- en: 'Now let''s define the route using which the upload service can store images
    in the image storage server. The upload service makes the POST request to the
    `/store` URL path to store the image. Here is the code to define the route:'
  id: totrans-88
  prefs: []
  type: TYPE_NORMAL
  zh: 现在让我们定义路由，使用该路由，上传服务可以将图像存储在图像存储服务器中。上传服务通过POST请求将图像存储在`/store` URL路径中。以下是定义路由的代码：
- en: '[PRE14]'
  id: totrans-89
  prefs: []
  type: TYPE_PRE
  zh: '[PRE14]'
- en: Here, at first, we are adding the callback provided by the connect-multiparty
    module, which parses the `multipart/form-data` content type body and also moves
    the files to a temporary location.
  id: totrans-90
  prefs: []
  type: TYPE_NORMAL
  zh: 在这里，首先，我们添加了由connect-multiparty模块提供的回调，该回调解析`multipart/form-data`内容类型主体，并将文件移动到临时位置。
- en: Then, we are moving the file from temporary directory to another directory.
    The directory we are moving the file to is `public/images/`. We are moving the
    file using the `rename` method of the filesystem module. Finally, we are sending
    a `Done` string as the body of HTTP response to tell the upload service that the
    file is stored successfully.
  id: totrans-91
  prefs: []
  type: TYPE_NORMAL
- en: 'Now let''s define the route using which the upload service can delete an image
    stored in the image storage server. The upload service makes the GET request to
    the `/delete/:id` URL path, where the `id` parameter indicates the image name.
    The following is the code to define the route:'
  id: totrans-92
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE15]'
  id: totrans-93
  prefs: []
  type: TYPE_PRE
  zh: '[PRE15]'
- en: Here we are deleting the image file using the `unlink` method of the `fs` module.
  id: totrans-94
  prefs: []
  type: TYPE_NORMAL
- en: 'Finally, we need to serve images to the browser. Looking for static file in
    the `public/images/` directory can do this. The following is the code to do this:'
  id: totrans-95
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE16]'
  id: totrans-96
  prefs: []
  type: TYPE_PRE
  zh: '[PRE16]'
- en: Here we are using the static middleware that looks for static files in the directory
    provided by arguments and serves directly to the browser.
  id: totrans-97
  prefs: []
  type: TYPE_NORMAL
- en: 'Now we have defined our routes. Finally, we need to start the Express server.
    Here is the code to do so:'
  id: totrans-98
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE17]'
  id: totrans-99
  prefs: []
  type: TYPE_PRE
  zh: '[PRE17]'
- en: Now go ahead and run the image storage server using the `node app.js` command.
  id: totrans-100
  prefs: []
  type: TYPE_NORMAL
- en: Creating the monolithic core
  id: totrans-101
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: We have finished creating the services and image storage server. The users interact
    with the monolithic core to view coupons and the admin interacts with the monolithic
    core to view unverified coupons, and then it either rejects or accepts a coupon.
    Other than new coupon submission by the user, everything else by the user and
    admin is done in the monolithic core.
  id: totrans-102
  prefs: []
  type: TYPE_NORMAL
- en: Open the `Initial/monolithic` directory. Inside the directory, you will find
    a `package.json` file and an `app.js` file. The `app.js` file is where you will
    write the code, and `package.json` lists the dependencies for the monolithic core.
    The monolithic core is dependent on `express`, `seneca`, `request` and `basic-auth
    npm` packages. Run the `npm install` command inside `Initial/monolithic` to install
    the dependencies locally.
  id: totrans-103
  prefs: []
  type: TYPE_NORMAL
- en: We will use the `ejs` template engine with Express. Inside the `views` directory,
    you will find `ejs` files for home, new coupon submit forms, and admin pages.
    The files already contain the templates and HTML code. The site is designed using
    Bootstrap.
  id: totrans-104
  prefs: []
  type: TYPE_NORMAL
- en: 'The following is the code to import the modules:'
  id: totrans-105
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE18]'
  id: totrans-106
  prefs: []
  type: TYPE_PRE
  zh: '[PRE18]'
- en: 'Now, for the monolithic core to be able to communicate with the database and
    `url- config` services, we need to add them to the monolithic core `seneca` instance.
    The following is the code to do this:'
  id: totrans-107
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE19]'
  id: totrans-108
  prefs: []
  type: TYPE_PRE
  zh: '[PRE19]'
- en: 'Now we need to set `ejs` as the `view engine`. Here is the code to set `ejs`
    as the view engine:'
  id: totrans-109
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE20]'
  id: totrans-110
  prefs: []
  type: TYPE_PRE
  zh: '[PRE20]'
- en: 'All the static files such as CSS, JS, and fonts are kept on the `public` directory.
    We need to serve them to the client. Here is the code to serve the static files:'
  id: totrans-111
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE21]'
  id: totrans-112
  prefs: []
  type: TYPE_PRE
  zh: '[PRE21]'
- en: Here we are serving the static files in the same way as we served the static
    files (that is, images) in the image upload server.
  id: totrans-113
  prefs: []
  type: TYPE_NORMAL
- en: Now we need to add a route to the server of the home page of our website that
    displays the first 20 coupons. It also displays the **Next** and **Previous**
    buttons to navigate between the next or previous 20 buttons.
  id: totrans-114
  prefs: []
  type: TYPE_NORMAL
- en: 'The home page is accessed via the root URL. The following is the code to add
    a route to the server of the home page:'
  id: totrans-115
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE22]'
  id: totrans-116
  prefs: []
  type: TYPE_PRE
  zh: '[PRE22]'
- en: The `index.ejs` file is the view of the home page of our site. The preceding
    code renders this view to generate the final HTML code for the home page.
  id: totrans-117
  prefs: []
  type: TYPE_NORMAL
- en: The preceding code implements pagination by checking whether `prev` or `next`
    keys are present in the query string. If these keys are undefined, then it displays
    the first 20 coupons, otherwise it calculates the `skip` value argument by adding
    20 to the value of the `current` key in the query string.
  id: totrans-118
  prefs: []
  type: TYPE_NORMAL
- en: Then, the code checks whether the total number of coupons retrieved is 21 or
    less. If they are less than 21, then it doesn't display the **Next** button by
    assigning the `next` variable to `false`, otherwise it displays the **next** button
    by assigning the `next` variable to `true`. However, the total number of coupons
    it displays is `20`. We retrieved an extra coupon to just check whether we should
    display the **next** button or not. To find out whether we should display the
    **previous** button or not is fairly easy, that is, if the `next` key is `true`
    in the query string, then we must display the **previous** button.
  id: totrans-119
  prefs: []
  type: TYPE_NORMAL
- en: 'The preceding code also checks for the `status=submitted` query string that
    indicates the user was redirected back from the upload service. If it''s present,
    then it assigns the `submitted` local variable for the view to `true`. This is
    the `ejs` template present in the view that checks whether the `submitted` local
    variable is `true` or `undefined` and displays a successful form submission message:'
  id: totrans-120
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE23]'
  id: totrans-121
  prefs: []
  type: TYPE_PRE
  zh: '[PRE23]'
- en: 'Here is the `ejs` template present in the view that displays the coupons and
    the **next** and **previous** buttons:'
  id: totrans-122
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE24]'
  id: totrans-123
  prefs: []
  type: TYPE_PRE
  zh: '[PRE24]'
- en: 'We are done creating our home page. Now we need to create a route with the
    `/add` URL path that will display a form to submit a new coupon. The view for
    this coupon submission page is `add.ejs`. Here is the code to create the route:'
  id: totrans-124
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE25]'
  id: totrans-125
  prefs: []
  type: TYPE_PRE
  zh: '[PRE25]'
- en: Here we are retrieving the base URL of the upload service from the URL config
    service and assigning it to the `upload_service_url` local variable so that the
    form knows where to submit the POST request.
  id: totrans-126
  prefs: []
  type: TYPE_NORMAL
- en: 'The following is the template in the `add.ejs` view that displays the coupon
    submission form:'
  id: totrans-127
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE26]'
  id: totrans-128
  prefs: []
  type: TYPE_PRE
  zh: '[PRE26]'
- en: Now we need to provide a path for the site admin to access the admin panel.
    The path to access admin panel is going to be `/admin`. The admin panel will be
    protected using HTTP basic authentication.
  id: totrans-129
  prefs: []
  type: TYPE_NORMAL
- en: We will create two more routes that will be used by the admin to accept or reject
    a coupon. The routes are `/admin/accept` and `/admin/reject`.
  id: totrans-130
  prefs: []
  type: TYPE_NORMAL
- en: 'The following is the code to protect the admin panel using the HTTP basic authentication:'
  id: totrans-131
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE27]'
  id: totrans-132
  prefs: []
  type: TYPE_PRE
  zh: '[PRE27]'
- en: Here we are executing the `auth` callback for all the admin panel paths. The
    callback checks whether the user is logged in or not. If user is not logged in,
    we will ask the user to log in. If the user tries to log in, then we will check
    whether the username and password is correct. If the username and password are
    wrong, we will ask the user to log in again. We will parse the HTTP basic authentication
    based the headers using the `basic-auth` module, that is, we will pass the `req`
    object to the `basicAuth` function to parse it. Here we are hardcoding the username
    and password.
  id: totrans-133
  prefs: []
  type: TYPE_NORMAL
- en: 'Now we need to define the routes to access the admin panel. The `admin.ejs`
    file is the view for the admin panel. The following is the code to add the routes:'
  id: totrans-134
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE28]'
  id: totrans-135
  prefs: []
  type: TYPE_PRE
  zh: '[PRE28]'
- en: When the admin visits `/admin`, unverified coupons are displayed along with
    buttons to accept or reject a coupon. When the admin clicks on the **Accept**
    button, then a request is made to the `/admin/accept` path to mark the coupon
    as verified, and when the admin clicks on the **Reject** button, a request is
    made to the `/admin/reject` path to delete the coupon. After accepting or deleting
    a coupon, the admin is redirected to the `/admin` path.
  id: totrans-136
  prefs: []
  type: TYPE_NORMAL
- en: 'The following is the template that displays the **coupons** and **verification**
    buttons to the admin:'
  id: totrans-137
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE29]'
  id: totrans-138
  prefs: []
  type: TYPE_PRE
  zh: '[PRE29]'
- en: 'We have defined our routes. Finally, we need to start the Express server. Here
    is the code to do so:'
  id: totrans-139
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE30]'
  id: totrans-140
  prefs: []
  type: TYPE_PRE
  zh: '[PRE30]'
- en: Now go ahead and run the monolithic core server using the `node app.js` command.
  id: totrans-141
  prefs: []
  type: TYPE_NORMAL
- en: Website walkthrough
  id: totrans-142
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: We have completed creating our website. Now, let's walkthrough our site to see
    how it works overall. Before that, make sure that everything is running.
  id: totrans-143
  prefs: []
  type: TYPE_NORMAL
- en: 'You can visit the home page of the website using the `http://localhost:8080/`
    URL. The following is how the web page will look when you will visit it for the
    first time:'
  id: totrans-144
  prefs: []
  type: TYPE_NORMAL
- en: '![Website walkthrough](img/00105.jpeg)'
  id: totrans-145
  prefs: []
  type: TYPE_IMG
- en: 'Now to add a coupon, click on the **Submit Coupon** button. Now you will see
    a form. Fill in the form. Here is how it looks:'
  id: totrans-146
  prefs: []
  type: TYPE_NORMAL
  zh: 现在要添加优惠券，请单击**提交优惠券**按钮。现在您会看到一个表格。填写表格。外观如下：
- en: '![Website walkthrough](img/00106.jpeg)'
  id: totrans-147
  prefs: []
  type: TYPE_IMG
  zh: '![网站演示](img/00106.jpeg)'
- en: 'Now submit the form. After submitting the form, you will be redirected to the
    home page. The following is how the home page will look after redirect:'
  id: totrans-148
  prefs: []
  type: TYPE_NORMAL
  zh: 现在提交表单。提交表单后，您将被重定向到主页。重定向后的主页外观如下：
- en: '![Website walkthrough](img/00107.jpeg)'
  id: totrans-149
  prefs: []
  type: TYPE_IMG
  zh: '![网站演示](img/00107.jpeg)'
- en: 'Now click on the **Admin** button to visit the admin panel and accept the coupon.
    Here is how the admin panel will look:'
  id: totrans-150
  prefs: []
  type: TYPE_NORMAL
  zh: 现在单击**管理员**按钮访问管理员面板并接受优惠券。管理员面板的外观如下：
- en: '![Website walkthrough](img/00108.jpeg)'
  id: totrans-151
  prefs: []
  type: TYPE_IMG
  zh: '![网站演示](img/00108.jpeg)'
- en: 'Click on the **Accept** button to accept it. Now go back to the home page.
    This is how the home page will look now:'
  id: totrans-152
  prefs: []
  type: TYPE_NORMAL
  zh: 单击**接受**按钮以接受。现在返回到主页。现在主页的外观如下：
- en: '![Website walkthrough](img/00109.jpeg)'
  id: totrans-153
  prefs: []
  type: TYPE_IMG
  zh: '![网站演示](img/00109.jpeg)'
- en: In the preceding image, you can see that the product is listed.
  id: totrans-154
  prefs: []
  type: TYPE_NORMAL
  zh: 在上图中，您可以看到产品已列出。
- en: Further improvements to the site
  id: totrans-155
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 网站的进一步改进
- en: 'Here is a list of things we can do now to make the site architecture even better
    and add some extra features. You will also get some practice writing code involving
    the microservices architecture by performing the following actions:'
  id: totrans-156
  prefs: []
  type: TYPE_NORMAL
  zh: 以下是我们现在可以做的事情，以使网站架构变得更好并添加一些额外功能的列表。您还将通过执行以下操作来练习编写涉及微服务架构的代码：
- en: Create a separate service for the admin panel. The benefit of this is that you
    can update the admin panel without affecting the visitors, that is, while the
    admin panel is being updated, the users will still be able to visit and browse
    coupons. For this, you need to move the route of the admin panel to a new service.
  id: totrans-157
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 为管理员面板创建一个单独的服务。这样做的好处是您可以在不影响访问者的情况下更新管理员面板，也就是说，在更新管理员面板时，用户仍然可以访问和浏览优惠券。为此，您需要将管理员面板的路由移动到一个新的服务中。
- en: Fetch the username and password from the database. For this, you need to add
    some actions to the database service.
  id: totrans-158
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 从数据库中获取用户名和密码。为此，您需要向数据库服务添加一些操作。
- en: Resize or crop images to thumbnail size, as that's the size of an image being
    displayed on the frontend. This will save the disk space. This needs to be done
    with the help of the upload service.
  id: totrans-159
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 调整或裁剪图像至缩略图大小，因为这是前端显示的图像大小。这将节省磁盘空间。这需要借助上传服务来完成。
- en: You can create a mobile app for the website. For this, you need to create a
    service that provides APIs for the mobile app. New coupons can be submitted to
    the upload service by adding a query string, indicating that the request has arrived
    from the mobile app so that it won't redirect, instead send a response once coupon
    is submitted successfully.
  id: totrans-160
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 您可以为网站创建一个移动应用程序。为此，您需要创建一个为移动应用程序提供API的服务。新的优惠券可以通过添加查询字符串提交到上传服务，指示请求来自移动应用程序，以便它不会重定向，而是在成功提交优惠券后发送响应。
- en: These are just some ideas to make the site even better.
  id: totrans-161
  prefs: []
  type: TYPE_NORMAL
  zh: 这些只是一些使网站变得更好的想法。
- en: Summary
  id: totrans-162
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 总结
- en: In this chapter, we saw how to build a website using Seneca and microservices
    architecture from scratch. The website we built was simple in terms of features,
    but involved a lot of important techniques that are used while building sites
    using the microservices architecture. Now you are ready to choose the architecture
    that suits your site best. I also mentioned the things you can do to make the
    site even better.
  id: totrans-163
  prefs: []
  type: TYPE_NORMAL
  zh: 在本章中，我们看到了如何使用Seneca和微服务架构从头开始构建网站。我们构建的网站在功能上很简单，但涉及了许多在使用微服务架构构建网站时使用的重要技术。现在您已经准备好选择最适合您网站的架构。我还提到了您可以做些什么来使网站变得更好。
- en: In the next chapter, we will discuss real-time communication among browsers
    using WebRTC.
  id: totrans-164
  prefs: []
  type: TYPE_NORMAL
  zh: 在下一章中，我们将讨论使用WebRTC在浏览器之间进行实时通信。

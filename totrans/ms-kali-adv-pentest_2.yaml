- en: Part 1. *The Attacker's Kill Chain*
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: '*[Starting with Kali Linux](ch01.html "Chapter 1. Starting with Kali Linux")*'
  prefs: []
  type: TYPE_NORMAL
- en: '*[Identifying the Target – Passive Reconnaissance](ch02.html "Chapter 2. Identifying
    the Target – Passive Reconnaissance")*'
  prefs: []
  type: TYPE_NORMAL
- en: '*[Active Reconnaissance and Vulnerability Scanning](ch03.html "Chapter 3. Active
    Reconnaissance and Vulnerability Scanning")*'
  prefs: []
  type: TYPE_NORMAL
- en: '*[Exploit](ch04.html "Chapter 4. Exploit")*'
  prefs: []
  type: TYPE_NORMAL
- en: '*[Post Exploit – Action on the Objective](ch05.html "Chapter 5. Post Exploit
    – Action on the Objective")*'
  prefs: []
  type: TYPE_NORMAL
- en: '*[Post Exploit – Persistence](ch06.html "Chapter 6. Post Exploit – Persistence")*'
  prefs: []
  type: TYPE_NORMAL
- en: Chapter 1. Starting with Kali Linux
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: 'Kali Linux (Kali) is the successor to the BackTrack penetration testing platform
    which is generally regarded as the de facto standard package of tools used to
    facilitate penetration testing to secure data and voice networks. This chapter
    provides an introduction to Kali, and focuses on customizing Kali to support some
    advanced aspects of penetration testing. By the end of this chapter, you will
    have learned:'
  prefs: []
  type: TYPE_NORMAL
- en: An overview of Kali
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Configuring network services and secure communications
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Updating Kali
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Customizing Kali
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Extending Kali's functionality with third-party applications
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Effective management of penetration tests
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Kali Linux
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: '**BackTrack** (**BT**), ([www.offensive-security.com](http://www.offensive-security.com))
    was released to provide an extensive variety of penetration testing and defensive
    tools that were perfect for auditors and network administrators interested in
    assessing and securing their networks. The same tools were used by both authorized
    and unauthorized (hackers) penetration testers.'
  prefs: []
  type: TYPE_NORMAL
- en: The final version of BackTrack, BT 5r3, was released in August 2012\. Based
    on the Ubuntu Linux platform, it was widely adopted and supported by the security
    community. Unfortunately, its file architecture made it difficult to manage the
    array of tools and their accompanying dependencies.
  prefs: []
  type: TYPE_NORMAL
- en: In BackTrack, all of the tools used for penetration testing were placed in the
    `/pentest` directory. Subfolders such as `/web` or `/database` helped to further
    define the location of tools. Finding and executing tools within this hierarchy
    could be counterintuitive. For example, is sqlninja, which identifies an SQL injection,
    a web vulnerability assessment tool, a web exploit tool, or a database exploit
    tool?
  prefs: []
  type: TYPE_NORMAL
- en: In March 2013, BackTrack was superseded by Kali Linux, which uses a new platform
    architecture based on the Debian GNU/Linux operating system.
  prefs: []
  type: TYPE_NORMAL
- en: Debian adheres to the **Filesystem Hierarchy Standard** (**FHS**), which is
    a significant advantage over BackTrack. Instead of needing to navigate through
    the /pentest tree, you can call a tool from anywhere on the system because applications
    are included in the system path.
  prefs: []
  type: TYPE_NORMAL
- en: 'Other features of Kali include the following:'
  prefs: []
  type: TYPE_NORMAL
- en: Support for multiple desktop environments such as Gnome, KDE, LXDE, and XFCE,
    and provides multilingual support.
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Debian-compliant tools are synchronized with the Debian repositories at least
    four times daily, making it easier to update packages and apply security fixes.
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Support for ISO customizations, allowing users to build their own versions of
    Kali. The bootstrap function also performs enterprise-wide network installs that
    can be automated using pre-seed files.
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**ARMEL** and **ARMHF** support allows Kali to be installed on devices such
    as Raspberry Pi, ODROID-U2/-X2, and the Samsung Chromebook.'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Over 300 penetration testing data forensics and defensive tools are included.
    They provide extensive wireless support with kernel patches to permit the packet
    injection required by some wireless attacks.
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Kali remains an open source project that is free. Most importantly, it is well
    supported by an active online community.
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Throughout this book, we'll be using a VMware **virtual machine** (**VM**) of
    64-bit Kali (refer to [Appendix](apa.html "Appendix A. Installing Kali Linux"),
    *Installing Kali Linux* for instructions on installing Kali).
  prefs: []
  type: TYPE_NORMAL
- en: A VM is used because it makes it easy to rapidly execute certain applications
    in other operating systems, such as Microsoft Windows. In addition, a VM can be
    archived with the results from a penetration test, allowing the archive to be
    reviewed to determine if a particular vulnerability would have been detected with
    the toolset that was used for testing.
  prefs: []
  type: TYPE_NORMAL
- en: 'When Kali is launched, the user will be taken to the default desktop GUI with
    a menu bar at the top and a few simple icons. By selecting the menu item **Applications**,
    and then **Kali Linux**, the user will gain access to a menu system that contains
    the **Top 10 Security Tools** as well as a series of folders, organized in the
    general order that would be followed during a penetration test, as shown in the
    following screenshot:'
  prefs: []
  type: TYPE_NORMAL
- en: '![Kali Linux](img/3121OS_01_01.jpg)'
  prefs: []
  type: TYPE_IMG
- en: Note
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: The menu will be familiar to users of BT 5r3\. However, there are some changes,
    which include simplified access to network services and communications.
  prefs: []
  type: TYPE_NORMAL
- en: Configuring network services and secure communications
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: The first step in being able to use Kali is to ensure that it has connectivity
    to either a wired or wireless network to support updates and customization.
  prefs: []
  type: TYPE_NORMAL
- en: 'You may need to obtain an IP address by **DHCP** (**Dynamic Host Configuration
    Protocol**), or assign one statically. First, confirm your IP address using the
    `ifconfig` command from a terminal window, as shown in the following screenshot:'
  prefs: []
  type: TYPE_NORMAL
- en: '![Configuring network services and secure communications](img/3121OS_01_02_New.jpg)'
  prefs: []
  type: TYPE_IMG
- en: In this particular case, the VM has been assigned an IP address of `192.168.204.132`.
    If an IP address was not obtained, an address can be assigned by DHCP using the
    command `dhclient eth0` (or other available interfaces, which will depend on the
    specific configuration of the system being used).
  prefs: []
  type: TYPE_NORMAL
- en: 'If a static IP address is used, additional information may be required. For
    example, you can assign a static IP of `192.168.204.128` as follows:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE0]'
  prefs: []
  type: TYPE_PRE
- en: 'Enter a terminal window and enter the following command:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE1]'
  prefs: []
  type: TYPE_PRE
- en: 'Changes made to IP settings are nonpersistent, and will be lost when Kali is
    rebooted. To make the changes permanent, you will need to edit the `/etc/network/interfaces`
    file, as shown in the following screenshot:'
  prefs: []
  type: TYPE_NORMAL
- en: '![Configuring network services and secure communications](img/3121OS_01_03.jpg)'
  prefs: []
  type: TYPE_IMG
- en: 'By default, Kali does not start with the DHCP service enabled. Doing so announces
    the new IP address on the network, and this may alert administrators about the
    presence of the tester. For some test cases, this may not be an issue, and it
    may be advantageous to have certain services start automatically during boot up.
    This can be achieved by entering the following commands:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE2]'
  prefs: []
  type: TYPE_PRE
- en: Kali installs with network services that can be started or stopped as required,
    including DHCP, HTTP, SSH, TFTP, and the VNC server. These services are usually
    invoked from the command line, however, some are accessible from the Kali menu.
  prefs: []
  type: TYPE_NORMAL
- en: Adjusting network proxy settings
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: Users located behind an authenticated or unauthenticated proxy connection must
    modify `bash.bashrc` and `apt.conf`. Both files are located in the `/root/etc`
    directory.
  prefs: []
  type: TYPE_NORMAL
- en: 'Edit the `bash.bashrc` file, as shown in the following screenshot, use a text
    editor to add the following lines to the bottom of the `bash.bashrc` file:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE3]'
  prefs: []
  type: TYPE_PRE
- en: '![Adjusting network proxy settings](img/3121OS_01_05.jpg)'
  prefs: []
  type: TYPE_IMG
- en: Replace `proxyIP` and `port` with your proxy IP address and port number respectively,
    and replace the username and password with your authentication username and password.
    If there's no need to authenticate, write only the part following the `@` symbol.
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: In the same directory, create the `apt.conf` file and enter the following command
    lines, as shown in the following screenshot:![Adjusting network proxy settings](img/3121OS_01_06.jpg)
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Save and close the file. Log out and then log in to activate the new settings.
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Securing communications with Secure Shell
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: To minimize detection by a target network during testing, Kali does not enable
    any externally-listening network services. Some services, such as **Secure Shell**
    (**SSH**), are already installed. However, they must be enabled prior to use.
  prefs: []
  type: TYPE_NORMAL
- en: Kali comes preconfigured with default SSH keys. Before starting the SSH service,
    it's a good idea to disable the default keys and generate a unique keyset for
    use.
  prefs: []
  type: TYPE_NORMAL
- en: 'Move the default SSH keys to a backup folder, and then generate a new SSH keyset
    using the following command:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE4]'
  prefs: []
  type: TYPE_PRE
- en: The process of moving the original keys and generating the new keyset is shown
    in the following screenshot.
  prefs: []
  type: TYPE_NORMAL
- en: '![Securing communications with Secure Shell](img/3121OS_01_07.jpg)'
  prefs: []
  type: TYPE_IMG
- en: To verify that the newly generated keys are unique, calculate their `md5sum`
    hash values, and compare with the original keys as shown in the following screenshot.
  prefs: []
  type: TYPE_NORMAL
- en: '![Securing communications with Secure Shell](img/3121OS_01_08.jpg)'
  prefs: []
  type: TYPE_IMG
- en: To start the SSH service using the menu, select **Applications** | **Kali Linux**
    | **System Services** | **SSHD** | **SSHD Start**.
  prefs: []
  type: TYPE_NORMAL
- en: 'To start SSH from the command line, use the command line shown in the following
    screenshot:'
  prefs: []
  type: TYPE_NORMAL
- en: '![Securing communications with Secure Shell](img/3121OS_01_09.jpg)'
  prefs: []
  type: TYPE_IMG
- en: 'To verify that SSH is running, perform a `netstat` query, as shown in the following
    screenshot:'
  prefs: []
  type: TYPE_NORMAL
- en: '![Securing communications with Secure Shell](img/3121OS_01_10.jpg)'
  prefs: []
  type: TYPE_IMG
- en: 'The SSH daemon is listening on port 22 in the previous example. To stop SSH,
    use the following command:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE5]'
  prefs: []
  type: TYPE_PRE
- en: Updating Kali Linux
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: Kali must be patched regularly to ensure that the base operating system and
    applications are up-to-date and that security patches have been applied.
  prefs: []
  type: TYPE_NORMAL
- en: The Debian package management system
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: Debian's package management system relies on discrete bundled applications called
    **packages**. Packages can be installed or removed by the user to customize the
    environment, and support tasks such as penetration testing. They can also extend
    the functionality of Kali, supporting tasks, such as communications (Skype, instant
    messaging, and secure e-mails) or documentation (OpenOffice and Microsoft Office
    running under Wine).
  prefs: []
  type: TYPE_NORMAL
- en: Packages are stored in repositories and are downloaded to the system user to
    ensure the integrity of the package.
  prefs: []
  type: TYPE_NORMAL
- en: Packages and repositories
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: By default, Kali uses only the official Kali repositories. It is possible that
    an incomplete installation process may not add the repositories to the correct
    `sources.list` file, or that you may wish to extend the available repositories
    when new applications are added.
  prefs: []
  type: TYPE_NORMAL
- en: Updating the `source.list` file can be done from the command line (`echo deb
    http://http.kali.org/kiali kali main contrib non-free >> /etc/apt/sources.list`),
    or by using a text editor.
  prefs: []
  type: TYPE_NORMAL
- en: 'The default package repositories that should be present in `/etc/apt/sources.list`
    are listed as follows; if not present, edit the sources.list file to include them:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE6]'
  prefs: []
  type: TYPE_PRE
- en: 'Not every Kali tool is presently maintained in the official tool repositories.
    If you choose to update a tool manually, it is possible that you will overwrite
    existing packaged files and break dependencies. Therefore, some tools that have
    not been officially moved to Debian repositories, such as the `aircrack-ng`, `dnsrecon`,
    `sqlmap`, `beef-xss`, and Social Engineering Toolkit (se-toolkit), are maintained
    in the Bleeding Edge repository. This repository may also be added to `sources.list`
    using the following command line:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE7]'
  prefs: []
  type: TYPE_PRE
- en: Dpkg
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: Dpkg is Debian's package management system. This command-line application is
    used to install, remove, and query packages. In general, `dpkg` performs actions
    on individual packages.
  prefs: []
  type: TYPE_NORMAL
- en: Tip
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: '`dpkg` is particularly useful in compiling a list of installed applications
    in Kali using the command `dpkg -l > list.txt`. If you want to know if a specific
    tool is installed, use `dpkg -l | grep <tool name>`.'
  prefs: []
  type: TYPE_NORMAL
- en: The following screenshot shows an excerpt of the returned data when dpkg -l
    is invoked, providing a list of all applications installed on the Kali distribution;
    this is particularly useful in identifying applications that may only be accessible
    directly from the command line.
  prefs: []
  type: TYPE_NORMAL
- en: '![Dpkg](img/3121OS_01_11.jpg)'
  prefs: []
  type: TYPE_IMG
- en: Using Advanced Packaging Tools
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: '**Advanced Packaging Tools** (**APT**), extend the functionalities of `dkpg`
    by searching repositories and installing or upgrading packages along with all
    the required dependencies. The APT can also be used to upgrade a complete distribution.'
  prefs: []
  type: TYPE_NORMAL
- en: 'The most common `apt` commands are as follows:'
  prefs: []
  type: TYPE_NORMAL
- en: '`apt-get update`: This is used to resynchronize the local package index files
    with their source as defined in `/etc/apt/sources.list`. The `update` command
    should always be used first, before performing an `upgrade` or `dist-upgrade`.'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '`apt-get upgrade`: This is used to install the newest versions of all packages
    installed on the system using `/etc/apt/sources.list`. Packages that are installed
    on Kali with new versions available are upgraded. The upgrade command will not
    change or delete packages that are not being upgraded, and it will not install
    packages that are not already present.'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '`apt-get dist-upgrade`: This upgrades all packages currently installed on the
    system and their dependencies. It also removes obsolete packages from the system.'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: The `apt-get` command can also be used to show a full description of a package
    and identify its dependencies (`apt-cache show <package name>`) or remove a package
    (`apt-get remove <package name>`).
  prefs: []
  type: TYPE_NORMAL
- en: Note
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: 'Run the `apt-get update` command and the `upgrade` command at start-up to ensure
    your session is using the most up-to-date tools. The easiest way to do this is
    to create an `update.sh` script that includes the following command line:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE8]'
  prefs: []
  type: TYPE_PRE
- en: 'Some applications are not upgraded by the `apt-get` command. For example, the
    local copy of the `exploit-db` archive must be manually upgraded. Create a script
    named `update.sh` and add the following commands to it, to automate the update
    process:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE9]'
  prefs: []
  type: TYPE_PRE
- en: Configuring and customizing Kali Linux
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: Kali is a framework that is used to complete a penetration test. However, the
    tester should never feel tied to the tools that have been installed by default,
    or by the look and feel of the Kali desktop. By customizing BackTrack, a tester
    can increase the security of client data that is being collected, and make it
    easier to do a penetration test.
  prefs: []
  type: TYPE_NORMAL
- en: 'Common customizations made to Kali include:'
  prefs: []
  type: TYPE_NORMAL
- en: Resetting the root password
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Adding a non-root user
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Speeding up Kali operations
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Sharing folders with MS Windows
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Creating encrypted folders
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Resetting the root password
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'To change a user password, use the following command:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE10]'
  prefs: []
  type: TYPE_PRE
- en: 'You will then be prompted to enter a new password, as shown in the following
    screenshot:'
  prefs: []
  type: TYPE_NORMAL
- en: '![Resetting the root password](img/3121OS_01_12.jpg)'
  prefs: []
  type: TYPE_IMG
- en: Adding a non-root user
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: Many of the applications provided in Kali must run with root-level privileges
    in order to function. Root-level privileges do possess a certain amount of risk,
    for example, miskeying a command or using the wrong command can cause applications
    to fail or even damage the system being tested. In some cases, it is preferable
    to test with user-level privileges. In fact, some applications force the use of
    lower-privilege accounts.
  prefs: []
  type: TYPE_NORMAL
- en: 'To create a non-root user, you can simply use the command `adduser` from the
    terminal and follow the instructions that appear, as shown in the following screenshot:'
  prefs: []
  type: TYPE_NORMAL
- en: '![Adding a non-root user](img/3121OS_01_13.jpg)'
  prefs: []
  type: TYPE_IMG
- en: Speeding up Kali operations
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'Several tools can be used to optimize and speed up Kali operations:'
  prefs: []
  type: TYPE_NORMAL
- en: 'When using a virtual machine, install the VM''s software drive package: Guest
    Additions (VirtualBox) or VMware Tools (VMware).'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: When creating a virtual machine, select a fixed disk size instead of one that
    is dynamically allocated. It is faster to add files to a fixed disk, and there
    is less file fragmentation.
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: The preload application (`apt-get install preload`) identifies a user's most
    commonly used programs and preloads binaries and dependencies into memory to provide
    faster access. It works automatically after the first restart following installation.
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: BleachBit (`apt-get install bleachbit`) frees disk space and improves privacy
    by freeing the cache, deleting cookies, clearing Internet history, shredding temporary
    files, deleting logs, and discarding other unnecessary files. Advanced features
    include shredding files to prevent recovery and wiping free disk space to hide
    traces of files that have not been fully deleted.
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: By default, Kali does not show all applications that are present in the start-up
    menu. Each application that is installed during the boot-up process slows the
    system data, and may impact memory use and system performance. Install **Boot
    Up Manager** (**BUM**) to disable unnecessary services and applications that are
    enabled during the boot up (`apt-get install bum`), as shown in the following
    screenshot:![Speeding up Kali operations](img/3121OS_01_14.jpg)
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Add `gnome-do` (`apt-get install gnome-do`) to launch applications directly
    from the keyboard. To configure `gnome-do`, select it from the **Applications**
    | **Accessories** menu. Once launched, select the **Preferences** menu, activate
    the **Quiet Launch** function, and select a launch command (for example, *Ctrl*
    + *Shift*). Clear any existing commands, and then enter the command line to be
    executed when the launch keys are selected.
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Rather than launching directly from the keyboard, it is possible to write specific
    scripts that launch complex operations.
  prefs: []
  type: TYPE_NORMAL
- en: Sharing folders with Microsoft Windows
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: The Kali toolset has the flexibility to share results with applications residing
    on different operating systems, especially Microsoft Windows. The most effective
    way to share data is to create a folder that is accessible from the host operating
    system as well as the Kali Linux VM guest.
  prefs: []
  type: TYPE_NORMAL
- en: When data is placed in a shared folder from either the host or the VM, it is
    immediately available via the shared folder to all systems that access that shared
    folder.
  prefs: []
  type: TYPE_NORMAL
- en: 'To create a shared folder, perform the following steps:'
  prefs: []
  type: TYPE_NORMAL
- en: Create a folder on the host operating system. In this example, it will be called
    `Kali_Share`.
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Right-click on the folder and select the **Sharing** tab. From this menu, select
    **Share**.
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Ensure that the file is shared with **Everyone**, and that **Permission Level**
    for this share is set to **Read / Write**.
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: If you have not already done so, install the appropriate tools onto BackTrack.
    For example, when using VMware, install the VMware tools (refer to [Appendix](apa.html
    "Appendix A. Installing Kali Linux"), *Installing Kali Linux*).
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: When the installation is complete, go to the VMware menu and select **Virtual
    Machine Setting**. Find the menu that enables **Shared Folders** and select **Always
    Enabled**. Create a path to the shared folder that is present on the host operating
    system, as shown in the following screenshot:![Sharing folders with Microsoft
    Windows](img/3121OS_01_15.jpg)
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Note
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: Although VirtualBox uses different menu titles, the process is the same.
  prefs: []
  type: TYPE_NORMAL
- en: Open the file browser on the Kali desktop. The shared folder will be visible
    in the `mnt` folder (it might be placed in a sub-folder, `hgfs`).
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Drag the folder onto the Kali desktop to create a link to the real folder.
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Everything placed in the folder will be accessible in the folder of the same
    name on the host operating system, and vice versa.
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: The shared folder, which will contain sensitive data from a penetration test,
    must be encrypted to protect the client's network and reduce the tester's liability
    should the data ever be lost or stolen.
  prefs: []
  type: TYPE_NORMAL
- en: Creating an encrypted folder with TrueCrypt
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: During a penetration test, you will have access to sensitive client information,
    including exploitable vulnerabilities and copies of successfully breached data.
    It is the tester's legal and moral responsibility to ensure that this information
    in his care is secured at all times. The best means of meeting this responsibility
    is to ensure that all client information is encrypted during storage and transmission.
  prefs: []
  type: TYPE_NORMAL
- en: 'To install TrueCrypt on BackTrack, complete the following steps:'
  prefs: []
  type: TYPE_NORMAL
- en: In the **Applications** menu, select **Accessories** | **TrueCrypt**.
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: To create an encrypted folder, open the application. You will be presented with
    the main menu, as shown in the following screenshot:![Creating an encrypted folder
    with TrueCrypt](img/3121OS_01_16.jpg)
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: On the main menu, select the **Create** **Volume** button. This will launch
    the **TrueCrypt Volume** **Creation Wizard**, as shown in the following screenshot:![Creating
    an encrypted folder with TrueCrypt](img/3121OS_01_17.jpg)
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Select **Create an encrypted file container**, and then click on **Next**.
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: The next screen will prompt for **Volume Type**, select **Standard TrueCrypt
    volume**, and click on **Next**.
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: On the **Volume** **Location** screen, select **Select File**. You will be asked
    to **Specify a New TrueCrypt Volume** by providing a **Name**, and indicating
    that it will save in the folder specified, as shown in the following screenshot:![Creating
    an encrypted folder with TrueCrypt](img/3121OS_01_18.jpg)
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Chose a filename. Do not choose a filename related to the client being tested,
    or which indicates that sensitive material is present in the directory. Use a
    number or code word to represent the client, and a generic title for results.
    Save the file on the desktop, then click on **Next**.
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: The next screen will provide you with **Encryption Options**. Select **Encryption
    Algorithm** from the drop-down menu. There are several choices, but for regular
    purposes, **AES** (the default 256-bit key) will suffice. You will also select
    a **Hash Algorithm** from the drop-down menu (the default, **RIPEMD-160**, should
    be sufficient). After your choices are complete, click on the **Next** button,
    as shown in the following screenshot:![Creating an encrypted folder with TrueCrypt](img/3121OS_01_19.jpg)
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: You will now be prompted for **Volume Size**. You should have a minimum size
    of approximately 500 MB, but this may vary depending on the testing regime. Click
    on **Next**.
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: The **Volume Password** should be selected according to the rules provided for
    strong passwords. Select and confirm the password, then click on **Next**, as
    shown in the following screenshot:![Creating an encrypted folder with TrueCrypt](img/3121OS_01_20.jpg)
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: The next screen allows you to select **Format Options**. For **Filesystem Options**
    select **FAT** from the drop-down menu. Click on **Next**.
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: The next screen, **Volume** **Format**, creates a random key for the encrypted
    filesystem. The key is based on mouse movements, and you will be prompted to move
    the mouse over the window for a long period to ensure the randomness (cryptographic
    strength) of the encryption keys. When done, click on **Format** to create the
    TrueCrypt volume.
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: The final volume has been created. It will appear as an icon on the desktop.
    The volume is encrypted, and it can be copied to an external storage device or
    moved to the host system and remain encrypted.
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: 'To use the encrypted volume, you must first choose a **Slot** to manage the
    encrypted folder in the main **TrueCrypt** menu. When this is done, use the **Select
    File** button to select the name of the encrypted file. In this case, we''ll use
    a previously made file called `pentest` located on the desktop, as shown in the
    following screenshot:'
  prefs: []
  type: TYPE_NORMAL
- en: '![Creating an encrypted folder with TrueCrypt](img/3121OS_01_21.jpg)'
  prefs: []
  type: TYPE_IMG
- en: 'Click on the **Mount** button. At this point, you will be prompted for the
    password, as shown in the following screenshot:'
  prefs: []
  type: TYPE_NORMAL
- en: '![Creating an encrypted folder with TrueCrypt](img/3121OS_01_22.jpg)'
  prefs: []
  type: TYPE_IMG
- en: 'When the correct password is entered, you will see the **Slot 1** details change
    to reflect the encrypted folder''s properties, and a new icon called `truerypt1`
    will be displayed on the desktop, will be displayed on the desktop, as shown in
    the following screenshot:'
  prefs: []
  type: TYPE_NORMAL
- en: '![Creating an encrypted folder with TrueCrypt](img/3121OS_01_23.jpg)'
  prefs: []
  type: TYPE_IMG
- en: If you double-click on the **truecrypt1** icon, you will be taken to a **File
    Browser** view.
  prefs: []
  type: TYPE_NORMAL
- en: At this point, it will act as a regular directory, and you can use the folder
    to store all of the test-related information. When you work with the contents
    of the folder, and wish to ensure that all data is encrypted, select **Dismount**
    on the main menu. The folder will revert to an encrypted state.
  prefs: []
  type: TYPE_NORMAL
- en: Managing third-party applications
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: Although Kali comes preloaded with several hundred applications, it is likely
    that you will need to install additional applications to effectively test specific
    environments (such as industrial systems), add new cutting edge tools, or ensure
    that your *favorite* tools are installed. Kali makes it easy to locate, install,
    and manage these tools.
  prefs: []
  type: TYPE_NORMAL
- en: Installing third-party applications
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'There are multiple ways to install third party applications: using the `apt-get`
    command, accessing a GitHub repository, and directly installing the application.'
  prefs: []
  type: TYPE_NORMAL
- en: All tools should be installed from the Kali Linux repository using the `apt-get
    install` command. The `install` command can be executed from the command line
    in a terminal window, or the user may select a graphical package management tool.
  prefs: []
  type: TYPE_NORMAL
- en: 'Recommended third-party applications include:'
  prefs: []
  type: TYPE_NORMAL
- en: '`apt-file`: This is a command-line tool to search within packages of the APT
    packaging system. It allows you to list contents of a package without installing
    or fetching it.'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '`gnome-tweak-tool`: This allows users to change themes and rapidly configure
    desktop options.'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '`instanbul`: This is a desktop screen recorder that allows you to make a movie
    of desktop activities.'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '`openoffice`: This is an open source office productivity suite that assists
    in documentation.'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '`scrub`: This is a secure deletion (anti-forensic) tool that securely deletes
    data to comply with stringent government standards using various overwrite patterns.'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '`shutter`: This is a screenshot tool that captures images of a desktop, open
    window, or a selection.'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '`team viewer`: This supports remote access and remote administration. It also
    allows testers to place a pre-configured computer (a dropbox) on the target network
    and control testing from a remote location.'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '`terminator`: This is a replacement for the Linux terminal window that allows
    horizontal scrolling—no more wrapped text!'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Tools that are not present in a Debian repository and are accessible using `apt-get
    install` can still be installed on Kali. However, the user must accept that manual
    installs are not coordinated with repositories, and they may break dependencies
    causing applications to fail.
  prefs: []
  type: TYPE_NORMAL
- en: Some tools use the GitHub online repository for software development projects.
    Many developers favor this open repository due to the flexibility of the Git revision
    system as well as the social-media aspects of the software sites. One tool that
    we will be using is `recon-ng`, a web reconnaissance framework.
  prefs: []
  type: TYPE_NORMAL
- en: 'To clone the current version of `recon-ng` from the GitHub repository, use
    the following command line:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE11]'
  prefs: []
  type: TYPE_PRE
- en: 'Finally, some applications must be manually installed. For example, to restore
    the asynchronous port scanner Unicornscan, can back to Kali, you must:'
  prefs: []
  type: TYPE_NORMAL
- en: 'Ensure the dependencies are first present: `apt-get install flex`'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Download the latest version of Unicornscan ([www.unicornscan.org](http://www.unicornscan.org)
    – the current version is unicornscan-0.4.7-2)
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: 'Extract the contents of the file to a new directory: `tar jxf unicornscan-0.4.7-2.tar.bz2`'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: 'Change to the directory containing Unicornscan: `cd unicornscan-0.4.7/`'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: 'Compile the source code: `./configure CFLAGS=-D_GNU_SOURCE && make && make
    install`'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: The exact dependencies and make install process will vary for each application,
    so you will need to refer to the developer's `README` file to ensure correct installation
    and configuration of these applications.
  prefs: []
  type: TYPE_NORMAL
- en: Running third-party applications with non-root privileges
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: Kali Linux is intended to support penetration testing. Most of the tools require
    root-level access, which is why access to the toolset and data is protected with
    passwords and encryption.
  prefs: []
  type: TYPE_NORMAL
- en: However, some third-party tools are not meant to run with root-level privileges.
    Tools such as web browsers may be compromised, and giving an attacker access to
    root privileges can have a significant security impact.
  prefs: []
  type: TYPE_NORMAL
- en: If root access is not required, tools should follow the principle of least privilege
    and run as non-root users.
  prefs: []
  type: TYPE_NORMAL
- en: To run an application that normally runs as a non-root user, log on to Kali
    using a root account. Kali should be configured with a non-root account. In this
    example, we will use the `noroot` account previously created with the `adduser`
    command.
  prefs: []
  type: TYPE_NORMAL
- en: 'Perform the following steps to run the web browser Iceweasel as non-root:'
  prefs: []
  type: TYPE_NORMAL
- en: Create a non-root user account. In this example, we will use `noroot`.
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: We will use `sux`, which is a wrapper application that transfers credentials
    from a privileged user to a target non-root user. Download and install `sux` using
    the `apt-get install` command.
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Start the web browser, and then minimize it.
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: 'Enter the command line: `ps aux |grep iceweasel`. As you can see, Iceweasel
    is running with root privileges.'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Close Iceweasel, and relaunch using the command `sux - noroot iceweasel`, as
    shown in the following screenshot:![Running third-party applications with non-root
    privileges](img/3121OS_01_24.jpg)
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: If you examine the Iceweasel title bar, shown in the following screenshot, you
    will see that it was invoked as the user `noroot`, an account that did not have
    administrator privileges.
  prefs: []
  type: TYPE_NORMAL
- en: '![Running third-party applications with non-root privileges](img/3121OS_01_25.jpg)'
  prefs: []
  type: TYPE_IMG
- en: 'You can also confirm that Iceweasel is running under the `noroot` account by
    examining the open processes, as shown in the following screenshot:'
  prefs: []
  type: TYPE_NORMAL
- en: '![Running third-party applications with non-root privileges](img/3121OS_01_26.jpg)'
  prefs: []
  type: TYPE_IMG
- en: Effective management of penetration tests
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: One of the most difficult aspects of penetration testing is remembering to test
    all of the relevant parts of the network or system target, or trying to remember
    if the target was actually tested, after the testing has been completed.
  prefs: []
  type: TYPE_NORMAL
- en: BT 5r3 emphasized the use of management tools such as Draedis and MagicTree.
    These tools facilitate group testing by providing a central repository for test
    data. In addition, they usually provide some framework so that testers know where
    they are within a testing methodology, and what tests remain to be completed.
    Tools of this nature are excellent in coordinating defined group activities during
    a vulnerability assessment or penetration test.
  prefs: []
  type: TYPE_NORMAL
- en: These tools remain in the **Applications** | **Kali Linux** | **Reporting Tools**
    | **Evidence Management** menu.
  prefs: []
  type: TYPE_NORMAL
- en: But what about complex penetration tests where the methodology may be more fluid
    as it adapts to the network target?
  prefs: []
  type: TYPE_NORMAL
- en: Some testers use keyloggers or Wireshark during testing to record keystrokes
    and packet traffic generated during the test. This data can be especially useful
    if the testing is causing a network or application outage, because replaying and
    analyzing the packets sent can identify which packet tools impacted the network.
  prefs: []
  type: TYPE_NORMAL
- en: Kali Linux includes several tools that are more suited to making rapid notes
    and serving as a repository of rapidly added cut-and-paste data, including KeepNote
    and the Zim desktop wiki.
  prefs: []
  type: TYPE_NORMAL
- en: Testers not only need to perform tests and collect data, they also need to be
    able to provide their findings to the client. This can be difficult, as some results
    are transient—a test demonstrates a finding at one point in time, and then something
    is changed on the target system, and future testing fails to demonstrate the exploitable
    vulnerability, even though it's possible for it to re-emerge.
  prefs: []
  type: TYPE_NORMAL
- en: The other challenge with positive results is that they need to be demonstrated
    to a client in a way that's understandable.
  prefs: []
  type: TYPE_NORMAL
- en: The golden rule is to always grab a screenshot of any positive, or potential,
    finding. Use a tool such as Shutter to capture images from the desktop.
  prefs: []
  type: TYPE_NORMAL
- en: By default, Kali is configured with **CutyCapt**, which is a cross-platform
    command-line utility that captures a web page and creates a variety of image types,
    including PDF, PS, PNG, JPEG, TIFF, GIF, and BMP.
  prefs: []
  type: TYPE_NORMAL
- en: 'For example, to create an image of a specific size from the Google search page,
    enter the following from a command-line prompt:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE12]'
  prefs: []
  type: TYPE_PRE
- en: 'On execution, an image of the size specified in the previous command is displayed,
    as shown in the following screenshot:'
  prefs: []
  type: TYPE_NORMAL
- en: '![Effective management of penetration tests](img/3121OS_01_27.jpg)'
  prefs: []
  type: TYPE_IMG
- en: CutyCapt is especially useful when demonstrating the presence of web-based vulnerabilities
    such as cross-site scripting.
  prefs: []
  type: TYPE_NORMAL
- en: Static images can be very useful, however, a video of an exploit that compromises
    a target network and shows the actions of an attacker as they compromise sensitive
    data is a very compelling tool. The instanbul screen recorder creates a video
    of an "exploit in progress," which allows the exploit to be replayed for training
    purposes, or to demonstrate the vulnerability to the client.
  prefs: []
  type: TYPE_NORMAL
- en: Summary
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: In this chapter, we examined Kali, a collection of tools widely used by legitimate
    penetration testers and hackers to assess the security of data systems and networks.
    We emphasized Kali as a virtual machine, allowing both the host operating system
    and the VM guest to support testing.
  prefs: []
  type: TYPE_NORMAL
- en: Kali is a repository of tools, and one of the challenges in using it is ensuring
    that the tools are up-to-date. We reviewed the Debian packet management system,
    and how updates could be initiated from both the command line and from GUI applications.
    Most importantly, we learned how to customize Kali to increase the security of
    our tools and the data that they collect. We are working to achieve the goal of
    making tools support our process, instead of the other way around!
  prefs: []
  type: TYPE_NORMAL
- en: In the next chapter, we will learn how to effectively use **Open Source Intelligence**
    (**OSINT**) to identify the vulnerable attack surfaces of our target and create
    customized username:password lists to facilitate social engineering attacks and
    other exploits.
  prefs: []
  type: TYPE_NORMAL
- en: Chapter 2. Identifying the Target – Passive Reconnaissance
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: Reconnaissance is the first step of the kill chain when conducting a penetration
    test or an attack against a network or server target. An attacker will typically
    dedicate up to seventy-five percent of the overall work effort for a penetration
    test to reconnaissance, as it is this phase that allows the target to be defined,
    mapped, and explored for the vulnerabilities that will eventually lead to exploitation.
  prefs: []
  type: TYPE_NORMAL
- en: 'There are two types of reconnaissance: **passive reconnaissance**, and **active
    reconnaissance**.'
  prefs: []
  type: TYPE_NORMAL
- en: Generally, passive reconnaissance is concerned with analyzing information that
    is openly available, usually from the target itself or public sources online.
    On accessing this information, the tester or attacker does not interact with the
    target in an unusual manner—requests and activities will not be logged, or will
    not be traced directly to the tester. Therefore, passive reconnaissance is conducted
    first to minimize the direct contact that may signal an impending attack or to
    identify the attacker.
  prefs: []
  type: TYPE_NORMAL
- en: 'In this chapter, you will learn the principles and practices of passive reconnaissance,
    which include the following:'
  prefs: []
  type: TYPE_NORMAL
- en: Basic principles of reconnaissance
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Open-source intelligence** (**OSINT**)'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: DNS reconnaissance and route mapping, including issues with IPv4 and IPv6
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Obtaining user information
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Profiling users for password lists
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Active reconnaissance, which involves direct interaction with the target, will
    be covered in [Chapter 3](ch03.html "Chapter 3. Active Reconnaissance and Vulnerability
    Scanning"), *Active Reconnaissance and Vulnerability Scanning*.
  prefs: []
  type: TYPE_NORMAL
- en: Basic principles of reconnaissance
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: Reconnaissance, or recon, is the first step of the kill chain when conducting
    a penetration test or attack against a data target. This is conducted in before
    the actual test or attack of a target network. The findings will give a direction
    to where additional reconnaissance may be required, or the vulnerabilities to
    attack during the exploitation phase.
  prefs: []
  type: TYPE_NORMAL
- en: Reconnaissance activities are segmented on a gradient of interactivity with
    the target network or device.
  prefs: []
  type: TYPE_NORMAL
- en: '![Basic principles of reconnaissance](img/3121OS_02_01.jpg)'
  prefs: []
  type: TYPE_IMG
- en: Passive reconnaissance does not involve direct interaction with the target network.
    The attacker's source IP address and activities are not logged (for example, a
    Google search for the target's e-mail addresses). It is difficult, if not impossible,
    for the target to differentiate passive reconnaissance from normal business activities.
  prefs: []
  type: TYPE_NORMAL
- en: In general, passive reconnaissance focuses on the business and regulatory environment,
    the company, and the employees. Information of this type is available on the Internet
    or other public sources, and is sometimes referred to as open source intelligence,
    or OSINT.
  prefs: []
  type: TYPE_NORMAL
- en: Passive reconnaissance also involves the normal interactions that occur when
    an attacker interacts with the target in an expected manner. For example, an attacker
    will log on to the corporate website, view various pages, and download documents
    for further study. These interactions are expected user activities, and are rarely
    detected as a prelude to an attack on the target.
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Active reconnaissance involves direct queries or other interactions (for example,
    port scanning of the target network) that can trigger system alarms or allow the
    target to capture the attacker's IP address and activities. This information could
    be used to identify and arrest an attacker, or during legal proceedings. Because
    active reconnaissance requires additional techniques for the tester to remain
    undetected, it will be covered in [Chapter 3](ch03.html "Chapter 3. Active Reconnaissance
    and Vulnerability Scanning"), *Active Reconnaissance and Vulnerability Scanning*.
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Penetration testers or attackers generally follow a process of structured information
    gathering, moving from a broad scope (the business and regulatory environments)
    to the very specific (user account data).
  prefs: []
  type: TYPE_NORMAL
- en: To be effective, testers should know exactly what they are looking for and how
    the data will be used before collection starts. Using passive reconnaissance and
    limiting the amount of data collected minimizes the risks of being detected by
    the target.
  prefs: []
  type: TYPE_NORMAL
- en: Open Source intelligence
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: Generally, the first step in a penetration test or an attack is the collection
    of open-source intelligence, or OSINT.
  prefs: []
  type: TYPE_NORMAL
- en: OSINT is information collected from public sources, particularly the Internet.
    The amount of available information is considerable—most intelligence and military
    organizations are actively engaged in OSINT activities to collect information
    about their targets, and to guard against data leakage about them.
  prefs: []
  type: TYPE_NORMAL
- en: The process of OSINT collection and analysis is complex and could constitute
    its own book; therefore, we will cover only the essential highlights.
  prefs: []
  type: TYPE_NORMAL
- en: Tip
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: The US Army manual ATP 2-22.9 ([http://www.fas.org/irp/doddir/army/atp2-22-9.pdf](http://www.fas.org/irp/doddir/army/atp2-22-9.pdf))
    and the NATO OSINT manual ([http://information-retrieval.info/docs/NATO-OSINT.html](http://information-retrieval.info/docs/NATO-OSINT.html))
    are both available online, and provide excellent technical reviews of how to gather
    and assess OSINT.
  prefs: []
  type: TYPE_NORMAL
- en: The information that is targeted for collection is dependent on the initial
    goal of the penetration test. For example, if testers wants to access financial
    data, they will need the names and biographical information of relevant employees
    (CFO, accounts receivable and payable, and so on), their usernames, and passwords.
    If the route of an attack involves social engineering, they may supplement this
    information with details that give credibility to the requests for information.
  prefs: []
  type: TYPE_NORMAL
- en: 'OSINT gathering usually starts with a review of the target''s official online
    presence (website, blogs, social-media pages, and third-party data repositories
    such as public financial records). Information of interest includes the following:'
  prefs: []
  type: TYPE_NORMAL
- en: Geographical locations of offices, especially remote or satellite offices that
    share corporate information but may lack stringent security controls.
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: An overview of the parent company and any subsidiary companies, especially any
    new companies acquired by mergers or acquisitions (these companies are frequently
    not as secure as the parent company).
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Employee names and contact information, especially names, e-mail addresses,
    and phone numbers.
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Clues about the corporate culture and language; this will facilitate social
    engineering attacks.
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Business partners or vendors that may connect into the target's network.
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Technologies in use. For example, if the target issues a press release about
    adopting new devices or software, the attacker will review the vendor's website
    for bug reports, known or suspected vulnerabilities, and details that could be
    used to facilitate various attacks.
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: 'Other online information sources used by the attacker may include the following:'
  prefs: []
  type: TYPE_NORMAL
- en: Search engines such as Google and Bing. Historically, these searches are highly
    manual; the attacker enters search terms that are specific for information of
    interest; for example, the search term "company name" + password filetype:xls
    may identify an Excel spreadsheet that contains employee passwords. These search
    terms are referred to as **google dorks** ([www.exploit-db.com/google-dorks/](http://www.exploit-db.com/google-dorks/)).
    Most search engines have since released APIs to facilitate automated lookups,
    making tools such as **Maltego** particularly effective.
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Tip
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: One of the most effective search engines is **Yandex** ([www.yandex.com](http://www.yandex.com)).
    This Russian language search engine, the fourth-largest search engine in the world,
    allows users to search in several languages, including English. It also supports
    very granular search expressions, making it more effective than Google when searching
    for specific information.
  prefs: []
  type: TYPE_NORMAL
- en: 'Other online sources that should be searched include:'
  prefs: []
  type: TYPE_NORMAL
- en: Government, financial, or other regulatory sites that provide information on
    mergers and acquisitions, names of key persons, and supporting data
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Usenet newsgroups, particularly postings from the target's employees looking
    for help with particular technologies
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: LinkedIn, Jigsaw, and other websites that provide employee information
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Job search websites, especially ones for technical positions that provide a
    list of the technologies and services that must be supported by a successful applicant
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Historic or cached content, retrieved by search engines (cache:url in Google,
    or WayBack Machine at [www.archive.org](http://www.archive.org))
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Country- and language-specific social and business related sites (refer to [http://searchenginecolossus.com](http://searchenginecolossus.com))
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Sites that aggregate and compare results from multiple search engines, such
    as Zuula ([www.zuula.com](http://www.zuula.com))
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Corporate and employee blogs, as well as personal blogs of key employees
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Social networks (LinkedIn, Facebook, and Twitter)
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Sites that provide lookups of DNS, route, and server information, especially,
    DNSstuff ([www.dnsstuff.com](http://www.dnsstuff.com)), ServerSniff ([www.serversniff.net](http://www.serversniff.net)),
    Netcraft ([www.netcraft.com](http://www.netcraft.com)), and [myIPneighbors.com](http://myIPneighbors.com)
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Shodan ([www.shodanHQ.com](http://www.shodanHQ.com)), sometimes referred to
    as the "hacker's Google"; Shodan lists Internet-accessible devices and allows
    the tester to search for devices with known vulnerabilities
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Password dumpsites (pastebin, search using `site:pastebin.com "targetURL"`)
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Managing findings can be difficult; however, Kali comes with KeepNote, which
    supports the rapid import and management of different types of data.
  prefs: []
  type: TYPE_NORMAL
- en: DNS reconnaissance and route mapping
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: Once a tester has identified the targets that have an online presence and contain
    items of interest, the next step is to identify the IP addresses and routes to
    the target.
  prefs: []
  type: TYPE_NORMAL
- en: DNS reconnaissance is concerned with identifying who owns a particular domain
    or series of IP addresses (`whois`-type information), the DNS information defining
    the actual domain names and IP addresses assigned to the target, and the route
    between the penetration tester or the attacker and the final target.
  prefs: []
  type: TYPE_NORMAL
- en: This information gathering is semi-active—some of the information is available
    from freely available open sources, while other information is available from
    third parties such as DNS registrars. Although the registrar may collect IP addresses
    and data concerning requests made by the attacker, it is rarely provided to the
    end target. The information that could be directly monitored by the target, such
    as DNS server logs, is almost never reviewed or retained.
  prefs: []
  type: TYPE_NORMAL
- en: Because the information needed can be queried using a defined systematic and
    methodical approach, its collection can be automated.
  prefs: []
  type: TYPE_NORMAL
- en: Tip
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: Note that DNS information may contain stale or incorrect entries. To minimize
    inaccurate information, query different source servers and use different tools
    to cross-validate results. Review results, and manually verify any suspect findings.
    Use a script to automate the collection of this information. The script should
    create a folder for the penetration test, and then a series of folders for each
    application being run. After the script executes each command, pipe the results
    directly to the specific holding folder.
  prefs: []
  type: TYPE_NORMAL
- en: WHOIS
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: The first step in researching the IP address space is to identify the addresses
    that are assigned to the target site. This is usually accomplished by using the
    `whois` command, which allows people to query databases that store information
    on the registered users of an Internet resource, such as a domain name or IP address.
  prefs: []
  type: TYPE_NORMAL
- en: Depending on the database that is queried, the response to a `whois` request
    will provide names, physical addresses, phone numbers, and e-mail addresses (useful
    in facilitating social engineering attacks), as well as IP addresses and DNS server
    names.
  prefs: []
  type: TYPE_NORMAL
- en: 'An attacker can use information from a `whois` query to:'
  prefs: []
  type: TYPE_NORMAL
- en: Support a social engineering attack against the location or persons identified
    in the query
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Identify a location for a physical attack
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Identify phone numbers that can be used for a **war dialing** attack, or to
    conduct a social engineering attack
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Conduct recursive searches to locate other domains hosted on the same server
    as the target or operated by the same user; if they are insecure, an attacker
    can exploit them to gain administrative access to the server, and then compromise
    the target server
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: In cases where the domain is due to expire, an attacker can attempt to seize
    the domain, and create a look-alike website to compromise visitors who think they
    are on the original website
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: An attacker will use the authoritative DNS servers, which are the records for
    lookups of that domain, to facilitate DNS reconnaissance
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Note that there is an increase in the usage of third parties to shield this
    data, and some domains, such as `.gov` and `.mil`, may not be accessible to the
    public domain. Requests to these domains are usually logged. There are several
    online lists available that describe domains and IP addresses assigned for government
    use; most tools accept options for "no contact" addresses, and government domains
    should be entered into these fields to avoid the wrong type of attention!
  prefs: []
  type: TYPE_NORMAL
- en: 'The easiest way to issue a `whois` query is from the command line. The following
    screenshot shows the `whois` command run against the domain of Digital Defence:'
  prefs: []
  type: TYPE_NORMAL
- en: '![WHOIS](img/3121OS_02_02.jpg)'
  prefs: []
  type: TYPE_IMG
- en: The returned `whois` record contains geographical information, names, and contact
    information—all of which can be used to facilitate a social engineering attack.
  prefs: []
  type: TYPE_NORMAL
- en: There are several websites that automate `whois` lookup enquiries, and attackers
    can use these sites to insert a step between the target and themselves; however,
    the site doing the lookup may log the requester's IP address.
  prefs: []
  type: TYPE_NORMAL
- en: DNS reconnaissance
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: The **Domain Name System** (**DNS**), is a distributed database that resolves
    names ([www.digitaldefence.ca](http://www.digitaldefence.ca)) to its IP addresses
    (`192.150.2.140`).
  prefs: []
  type: TYPE_NORMAL
- en: 'Attackers use the DNS information in the following ways:'
  prefs: []
  type: TYPE_NORMAL
- en: Using brute-force attacks, allows attackers to identify new domain names associated
    with the target.
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: If the DNS server is configured to permit a zone transfer to any requester,
    it will provide hostnames and IP addresses of Internet-accessible systems, making
    it easier to identify potential targets. If the target does not segregate public
    (external) DNS information from private (internal) DNS information, a zone transfer
    might disclose the hostnames and IP addresses of internal devices. (Note that
    most IDS and IPS systems will trigger an alarm if a zone transfer request is triggered).
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Finding services that may be vulnerable (for example, FTP) or are otherwise
    interesting (remote administration panels and remote access).
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Finding misconfigured and/or unpatched servers (`dbase.test.target.com`).
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Service records** (**SRV**), provide information on service, transport, port,
    and order of importance for services. This can allow an attacker to deduce the
    software.'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**DomainKeys Identified Mail** (**DKIM**) and **Sender Policy Framework** (**SPF**)
    records are used to control spam e-mails. If these records are identified, the
    attacker knows that:'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: They are more security conscious than most organizations.
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: This may impact phishing and other social engineering attacks.
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Both Windows and Unix support basic command-line tools such as **nslookup**,
    and Unix systems support additional command-line options such as `dig`. Unfortunately,
    these commands usually interrogate one server at a time, and require interactive
    responses to be effective.
  prefs: []
  type: TYPE_NORMAL
- en: Kali features several tools designed to iteratively query DNS information for
    a particular target. The selected tool must accommodate the Internet Protocol
    version that is used for communications with the target—IPv4 or IPv6.
  prefs: []
  type: TYPE_NORMAL
- en: IPv4
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: 'The IP, or Internet Protocol address, is a unique number used to identify devices
    that are connected to a private network or the public Internet. Today, the Internet
    is largely based on version 4, IPv4\. Kali includes several tools to facilitate
    DNS reconnaissance, as given in the following table:'
  prefs: []
  type: TYPE_NORMAL
- en: '| Application | Description |'
  prefs: []
  type: TYPE_TB
- en: '| --- | --- |'
  prefs: []
  type: TYPE_TB
- en: '| `dnsenum`, `dnsmap`, and `dnsrecon` | These are comprehensive DNS scanners—DNS
    record enumeration (A, MX, TXT, SOA, wildcard, and so on), subdomain brute-force
    attacks, Google lookup, reverse lookup, zone transfer, and zone walking. `dsnrecon`
    is usually the first choice—it is highly reliable, results are well parsed, and
    data can be directly imported into the Metasploit Framework. |'
  prefs: []
  type: TYPE_TB
- en: '| `dnstracer` | This determines where a given Domain Name System gets its information
    from, and follows the chain of DNS servers back to the servers which know the
    data. |'
  prefs: []
  type: TYPE_TB
- en: '| `dnswalk` | This DNS debugger checks specified domains for internal consistency
    and accuracy. |'
  prefs: []
  type: TYPE_TB
- en: '| `fierce` | This locates non-contiguous IP space and hostnames against specified
    domains by attempting zone transfers, and then attempting brute-force attacks
    to gain DNS information. |'
  prefs: []
  type: TYPE_TB
- en: During testing, most investigators run `fierce` to confirm that all possible
    targets have been identified, and then run at least two comprehensive tools (for
    example, `dnsenum` and `dnsrecon`) to generate the maximum amount of data and
    provide a degree of cross validation.
  prefs: []
  type: TYPE_NORMAL
- en: In the following screenshot, `dnsrecon` is used to generate a standard DNS record
    search, and a search that is specific for SRV records. An excerpt of the results
    is shown for each case.
  prefs: []
  type: TYPE_NORMAL
- en: '![IPv4](img/3121OS_02_03.jpg)'
  prefs: []
  type: TYPE_IMG
- en: '`DNSrecon` allows the penetration tester to obtain the SOA record, **name servers**
    (**NS**), **mail exchanger** (MX) hosts, servers sending e-mails using **Sender
    Policy Framework** (SPF), and the IP address ranges in use.'
  prefs: []
  type: TYPE_NORMAL
- en: IPv6
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: Although IPv4 seems to permit a large address space, freely available IP addresses
    were exhausted several years ago, forcing the employment of NAT and DHCP to increase
    the number of available addresses. A more permanent solution has been found in
    the adoption of an improved IP addressing scheme, IPv6\. Although it constitutes
    less than five percent of Internet addresses, its usage is increasing, and penetration
    testers must be prepared to address the differences between IPv4 and IPv6.
  prefs: []
  type: TYPE_NORMAL
- en: In IPv6, the source and destination addresses are 128 bits in length, yielding
    2128 possible addresses, that is, 340 undecillion addresses!
  prefs: []
  type: TYPE_NORMAL
- en: The increased size of the addressable address space presents some problems to
    penetration testers, particularly when using scanners that step through the available
    address space looking for live servers. However, some features of the IPv6 protocol
    have simplified discovery, especially the use of ICMPv6 to identify active link-local
    addresses.
  prefs: []
  type: TYPE_NORMAL
- en: 'It is important to consider IPv6 when conducting initial scans for the following
    reasons:'
  prefs: []
  type: TYPE_NORMAL
- en: There is uneven support for IPv6 functionality in testing tools, so the tester
    must ensure that each tool is validated to determine its performance and accuracy
    in IPv4, IPv6, and mixed networks.
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Because IPv6 is a relatively new protocol, the target network may contain misconfigurations
    that leak important data; the tester must be prepared to recognize and use this
    information.
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Older network controls (firewalls, IDS, and IPS) may not detect IPv6\. In such
    cases, penetration testers can use IPv6 tunnels to maintain covert communications
    with the network, and exfiltrate the data undetected.
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Kali includes several tools developed to take advantage of IPv6 (most comprehensive
    scanners, such as `nmap`, now support IPv6), some of which are as follows; tools
    that are particular to IPv6 were largely derived from the THC-IPv6 Attack Toolkit.
  prefs: []
  type: TYPE_NORMAL
- en: '| Application | Description |'
  prefs: []
  type: TYPE_TB
- en: '| --- | --- |'
  prefs: []
  type: TYPE_TB
- en: '| `dnsdict6` | Enumerates subdomains to obtain IPv4 and IPv6 addresses (if
    present) using a brute force search based on a supplied dictionary file or its
    own internal list. |'
  prefs: []
  type: TYPE_TB
- en: '| `dnsrevenum6` | Performs reverse DNS enumeration given an IPv6 address. |'
  prefs: []
  type: TYPE_TB
- en: 'The execution of the `dnsdict6` command is shown in the following screenshot:'
  prefs: []
  type: TYPE_NORMAL
- en: '![IPv6](img/3121OS_02_04.jpg)'
  prefs: []
  type: TYPE_IMG
- en: Mapping the route to the target
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: Route mapping was originally used as a diagnostic tool that allows you to view
    the route that an IP packet follows from one host to the next. Using the **time
    to live** (**TTL**) field in an IP packet, each *hop* from one point to the next
    elicits an **ICMP TIME_EXCEEDED** message from the receiving router, decrementing
    the value in the TTL field by 1\. The packets count the number of hops and the
    route taken.
  prefs: []
  type: TYPE_NORMAL
- en: 'From an attacker''s, or penetration tester''s perspective, the `traceroute`
    data yields the following important data:'
  prefs: []
  type: TYPE_NORMAL
- en: The exact path between the attacker and the target
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Hints pertaining to the network's external topology
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Identification of accessing control devices (firewalls and packet-filtering
    routers) that may be filtering attack traffic
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: If the network is misconfigured, it may be possible to identify internal addressing
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Tip
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: Using a web-based `traceroute` ([www.traceroute.org](http://www.traceroute.org)),
    it is possible to trace various geographic origin sites to the target network.
    These types of scans will frequently identify more than one different network
    connecting to the target, which is information that could be missed by conducting
    only a single `traceroute` from a location close to the target. Web-based `traceroute`
    may also identify multihomed hosts which connect two or more networks together.
    These hosts are an important target for attackers, because they drastically increase
    the attack surface leading to the target.
  prefs: []
  type: TYPE_NORMAL
- en: In Kali, `traceroute` is a command-line program that uses ICMP packets to map
    the route; in Windows, the program is `tracert`.
  prefs: []
  type: TYPE_NORMAL
- en: 'If you launch `traceroute` from Kali, it is likely that you will see most hops
    filtered (data is shown as * * *). For example, `traceroute` from the author''s
    present location to [www.google.com](http://www.google.com) would yield the following:'
  prefs: []
  type: TYPE_NORMAL
- en: '![Mapping the route to the target](img/3121OS_02_05.jpg)'
  prefs: []
  type: TYPE_IMG
- en: 'However, if the same request was run using `tracert` from the Windows command
    line, we would see the following:'
  prefs: []
  type: TYPE_NORMAL
- en: '![Mapping the route to the target](img/3121OS_02_06.jpg)'
  prefs: []
  type: TYPE_IMG
- en: Not only do we get the complete path, but we can also see that [www.google.com](http://www.google.com)
    is resolving to a slightly different IP address, indicating that load balancers
    are in effect (you can confirm this using Kali's `lbd` script; however, this activity
    may be logged by the target site).
  prefs: []
  type: TYPE_NORMAL
- en: The reason for the different path data is that, by default, `traceroute` used
    UDP datagrams while Windows `tracert` uses ICMP echo request (ICMP type 8). Therefore,
    when completing a `traceroute` using Kali tools, it is important to use multiple
    protocols in order to obtain the most complete path, and to bypass packet-filtering
    devices.
  prefs: []
  type: TYPE_NORMAL
- en: 'Kali provides the following tools for completing route traces:'
  prefs: []
  type: TYPE_NORMAL
- en: '| Application | Description |'
  prefs: []
  type: TYPE_TB
- en: '| --- | --- |'
  prefs: []
  type: TYPE_TB
- en: '| `hping3` | This is a TCP/IP packet assembler and analyzer. This supports
    TCP, UDP, ICMP, and raw-IP and uses a ping-like interface. |'
  prefs: []
  type: TYPE_TB
- en: '| `intrace` | This enables users to enumerate IP hops by exploiting existing
    TCP connections, both initiated from the local system or network, or from local
    hosts. This makes it very useful for bypassing external filters such as firewalls.
    `intrace` is a replacement for the less reliable 0trace program. |'
  prefs: []
  type: TYPE_TB
- en: '| `trace6` | This is a `traceroute` program that uses ICMP6. |'
  prefs: []
  type: TYPE_TB
- en: '`hping3` is one of the most useful tools due to the control it gives over packet
    type, source packet, and destination packet. For example, Google does not allow
    ping requests. However, it is possible to ping the server if you send the packet
    as a TCP SYN request.'
  prefs: []
  type: TYPE_NORMAL
- en: 'In the following example, the tester attempts to ping Google from the command
    line. The returned data identifies that [www.google.com](http://www.google.com)
    is an unknown host; Google is clearly blocking ICMP-based ping commands. However,
    the next command invokes `hping3`, instructing it to do the following:'
  prefs: []
  type: TYPE_NORMAL
- en: Send a ping-like command to Google using TCP with the SYN flag set (`-S`).
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Direct the packet to port 80; legitimate requests of this type are rarely blocked
    (`- p 80`).
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Set a count of sending three packets to the target (`-c 3`).
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: 'To execute the previous steps, use the commands as shown in the following screenshot:'
  prefs: []
  type: TYPE_NORMAL
- en: '![Mapping the route to the target](img/3121OS_02_07.jpg)'
  prefs: []
  type: TYPE_IMG
- en: The `hping3` command successfully identifies that the target is online, and
    provides some basic routing information.
  prefs: []
  type: TYPE_NORMAL
- en: Obtaining user information
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: Many penetration testers gather user names and e-mail addresses, as this information
    is frequently used to log on to targeted systems.
  prefs: []
  type: TYPE_NORMAL
- en: The most commonly employed tool is the web browser, which is used to manually
    search the target organization's website as well as third-party sites such as
    LinkedIn or Jigsaw.
  prefs: []
  type: TYPE_NORMAL
- en: Some automated tools included with Kali can supplement the manual searches.
  prefs: []
  type: TYPE_NORMAL
- en: Tip
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: E-mail addresses of former employees can still be of use. When conducting social
    engineering attacks, directing information requests to a former employee usually
    results in a redirect that gives the attacker the "credibility" of having dealt
    with the previous employee. In addition, many organizations do not properly terminate
    employee accounts, and it is possible that these credentials may still give access
    to the target system.
  prefs: []
  type: TYPE_NORMAL
- en: Gathering names and e-mail addresses
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: The `theharvester` tool is a Python script that searches through popular search
    engines and other sites for e-mail addresses, hosts, and subdomains.
  prefs: []
  type: TYPE_NORMAL
- en: 'Using `theharvester` is relatively simple as there are only a few command switches
    to set. The options available are:'
  prefs: []
  type: TYPE_NORMAL
- en: '`-d`: This identifies the domain to be searched; usually the domain or target''s
    website.'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '`- b`: This identifies the source for extracting the data; it must be one of
    the following:'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Bing, BingAPI, Google, Google-Profiles, Jigsaw, LinkedIn, People123, PGP, or
    All
  prefs: []
  type: TYPE_NORMAL
- en: '`- l`: This limit option instructs `theharvester` to only harvest data from
    a specified number of returned search results.'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '`-f`: This option is used to save the final results to an HTML and an XML file.
    If this option is omitted, the results will be displayed on the screen and not
    saved.'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: 'The following screenshot shows the results of a simple search of the Google
    indexes for the domain [digitaldefence.ca](http://digitaldefence.ca):'
  prefs: []
  type: TYPE_NORMAL
- en: '![Gathering names and e-mail addresses](img/3121OS_02_08.jpg)'
  prefs: []
  type: TYPE_IMG
- en: Gathering document metadata
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'Document metadata refers to the information that is appended to documents so
    that applications can manage them during the creation and storage processes. Examples
    of metadata typically attached to documents include the following:'
  prefs: []
  type: TYPE_NORMAL
- en: The company or person who owns the application used to create the document
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: The name of the document's author
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: The time and date that the document was created
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: The date when the file was last printed or modified; in some cases, it will
    identify who made the modifications
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: The location on the computer network where the document was created
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Some files, especially those created by cameras or mobile devices, may include
    geographic tags that identify where the image was created
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Metadata is not immediately visible to the end user, so most documents are published
    with the metadata intact. Unfortunately, this data leakage can reveal information
    that can be used by a tester or attacker to facilitate an attack. At a minimum,
    testers and attackers can harvest user names by comparing them to data in documents;
    they can identify persons associated with particular data types, such as annual
    financial reports or strategic planning.
  prefs: []
  type: TYPE_NORMAL
- en: As mobile devices become more common, the risks associated with geographical
    metadata have increased. Attackers look for locations (cottages, hotels, and restaurants
    that are frequently visited) as sites that may allow them to launch attacks against
    users who have let their guard down outside the corporate perimeter. For example,
    if an employee of the target organization regularly posts pictures to a social
    media website while waiting for a commuter train, an attacker may target that
    employee for a physical attack (theft of the mobile device), wireless attack,
    or even peek over the victim's shoulder to note the username and password.
  prefs: []
  type: TYPE_NORMAL
- en: 'On Kali, the tool `Metagoofil` performs a Google search to identify and download
    a target website''s documents (doc, docx, pdf, pptx, xls, and xlsx) and extract
    usernames, a software version, path storage names, and a server, or workstation
    names, as shown in the following screenshot:'
  prefs: []
  type: TYPE_NORMAL
- en: '![Gathering document metadata](img/3121OS_02_11.jpg)'
  prefs: []
  type: TYPE_IMG
- en: '`Metagoofil` downloads the specified number of documents to a temporary folder,
    and extracts and organizes the relevant metadata. It also performs this function
    against files that have previously been downloaded and are now stored locally.'
  prefs: []
  type: TYPE_NORMAL
- en: 'One of the first returns of `Metagoofil` is a list of the users that are found.
    The following is a screenshot of a truncated list:'
  prefs: []
  type: TYPE_NORMAL
- en: '![Gathering document metadata](img/3121OS_02_12.jpg)'
  prefs: []
  type: TYPE_IMG
- en: '`Metagoofil` also identifies servers and pathnames of the documents. If certain
    documents of interest are localized with a particular user (for example, drafts
    of financial reports found on an administrative assistant''s workstation), that
    system can be targeted later during testing, as shown in the following screenshot:'
  prefs: []
  type: TYPE_NORMAL
- en: '![Gathering document metadata](img/3121OS_02_13.jpg)'
  prefs: []
  type: TYPE_IMG
- en: Profiling users for password lists
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: So far, you have learned to use passive reconnaissance to collect names and
    biographical information for users of the target being tested; this is the same
    process used by hackers. The next step is to use this information to create password
    lists specific to the users and the target.
  prefs: []
  type: TYPE_NORMAL
- en: Lists of commonly used passwords are available for download, and are stored
    locally on Kali in the `/usr/share/wordlists` directory. These lists reflect the
    choices of a large population of users, and it can be time consuming for an application
    to attempt to use each possible password before moving on to the next password
    in the queue.
  prefs: []
  type: TYPE_NORMAL
- en: 'Fortunately, **Common User Password Profiler** (**CUPP**) allows the tester
    to generate a `wordlist` that is specific to a particular user. CUPP was present
    on Backtrack 5r3; however, it will have to be downloaded for use on Kali. To obtain
    CUPP, enter the following command:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE13]'
  prefs: []
  type: TYPE_PRE
- en: This will download CUPP to the local directory.
  prefs: []
  type: TYPE_NORMAL
- en: 'CUPP is a Python script, and can be simply invoked from the CUPP directory
    by entering the following command:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE14]'
  prefs: []
  type: TYPE_PRE
- en: 'This will launch CUPP in the interactive mode, which prompts the user for specific
    elements of information to use in creating `wordlist`. An example is shown in
    the following screenshot:'
  prefs: []
  type: TYPE_NORMAL
- en: '![Profiling users for password lists](img/3121OS_02_14.jpg)'
  prefs: []
  type: TYPE_IMG
- en: When the interactive mode has completed creating `wordlist`, it is placed in
    the CUPP directory.
  prefs: []
  type: TYPE_NORMAL
- en: Summary
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: The first real step in the attack process or kill chain is to conduct reconnaissance
    to identify the target and potential attack routes. Passive reconnaissance assesses
    data that is publicly available. This is a stealthy assessment—the IP address
    or activities of the attacker are almost indistinguishable from normal access.
    Nevertheless, this information can be critical when conducting social engineering
    attacks, or facilitating other attack types.
  prefs: []
  type: TYPE_NORMAL
- en: In the next chapter, we will assess the types of reconnaissance that are more
    active. Although these techniques produce more information, there is an increased
    risk of detection. Therefore, the emphasis will be on advanced stealth techniques.
  prefs: []
  type: TYPE_NORMAL
- en: Chapter 3. Active Reconnaissance and Vulnerability Scanning
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: The objective of the reconnaissance phase is to gather as much information about
    the target as possible in order to facilitate the exploitation phase of the kill
    chain.
  prefs: []
  type: TYPE_NORMAL
- en: We have seen how passive reconnaissance, which is almost undetectable, can yield
    a significant amount of information about the target organization and its users.
  prefs: []
  type: TYPE_NORMAL
- en: Active reconnaissance builds on the results of open-source intelligence and
    passive reconnaissance, and focuses on using probes to identify the path to the
    target and the exposed *attack surface* of the target. In general, complex systems
    have a greater attack surface, and each surface may be exploited and then leveraged
    to support additional attacks.
  prefs: []
  type: TYPE_NORMAL
- en: 'Although active reconnaissance produces more information, and more useful information,
    interactions with the target system may be logged, triggering alarms by protective
    devices, such as firewalls and intrusion detection systems. As the usefulness
    of the data to the attacker increases, so does the risk of detection; this is
    shown in the following diagram:'
  prefs: []
  type: TYPE_NORMAL
- en: '![Active Reconnaissance and Vulnerability Scanning](img/3121OS_03_01.jpg)'
  prefs: []
  type: TYPE_IMG
- en: To improve the effectiveness of active reconnaissance in providing detailed
    information, our focus will be on using stealthy, or difficult to detect, techniques.
  prefs: []
  type: TYPE_NORMAL
- en: 'In this chapter, you will learn:'
  prefs: []
  type: TYPE_NORMAL
- en: Stealth scanning strategies
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Network infrastructure, host discovery, and enumeration
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Comprehensive reconnaissance applications, especially `recon-ng`
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Targeted vulnerability scanning
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Stealth scanning strategies
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: The greatest risk of active reconnaissance is the discovery by the target. Using
    the tester's time and data stamps, the source IP address, and additional information,
    the target can identify the source of the incoming reconnaissance. Therefore,
    stealth techniques are employed to minimize the chances of detection.
  prefs: []
  type: TYPE_NORMAL
- en: 'When employing stealth to support reconnaissance, a tester mimicking the actions
    of a hacker will do the following:'
  prefs: []
  type: TYPE_NORMAL
- en: Camouflage tool signatures to avoid detection and triggering an alarm
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Hide the attack within legitimate traffic
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Modify the attack to hide the source and type of traffic
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Make the attack invisible using nonstandard traffic types or encryption
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: 'Stealth scanning techniques can include some or all of the following:'
  prefs: []
  type: TYPE_NORMAL
- en: Adjusting source IP stack and tool identification settings
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Modifying packet parameters (`nmap`)
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Using proxies with anonymity networks (ProxyChains and Tor network)
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Adjusting source IP stack and tool identification settings
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: Before the penetration tester (or the attacker) begins testing, it must ensure
    that all unnecessary services on Kali are disabled or turned off.
  prefs: []
  type: TYPE_NORMAL
- en: For example, if the local DHCP daemon is enabled and is not required, it is
    possible for the DHCP to interact with the target system, which could be logged
    and send alarms to the target's administrators.
  prefs: []
  type: TYPE_NORMAL
- en: 'Most testers also disable IPv6 from running on the testing system. This will
    stop IPv6 from announcing your presence on the target network and ensure that
    all traffic is first routed through an IPv4 socks proxy. Disabling IPv6 can be
    accomplished by editing the `/etc/sysctl.conf` file to include the following lines:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE15]'
  prefs: []
  type: TYPE_PRE
- en: Some commercial and open source tools (for example, the Metasploit Framework)
    tag their packets with an identifying sequence. Although this can be useful in
    post-test analysis of a system's event logs (where events initiated by a particular
    testing tool can be directly compared to a system's event logs to determine how
    the network detected and responded to the attack), it can also trigger certain
    intrusion detection systems. Test your tools against a lab system to determine
    the packets that are tagged, and either change the tag, or use the tool with caution.
  prefs: []
  type: TYPE_NORMAL
- en: The easiest way to identify tagging is to apply the tool against a newly-created
    virtual image as the target, and review system logs for the tool's name. In addition,
    use Wireshark to capture traffic between the attacker and target virtual machines,
    and then search the **packet capture** (**pcap**) files for the any keywords that
    can be attributed to the testing tool (name of the tool, vendor, license number,
    and so on).
  prefs: []
  type: TYPE_NORMAL
- en: 'The `UserAgent` in the Metasploit Framework can be changed by modifying the
    `http_form_field` option. From the msfconsole prompt, select the option to use
    `auxiliary/fuzzers/http/http_form_field`, and then set a new useragent, as shown
    in the following screenshot:'
  prefs: []
  type: TYPE_NORMAL
- en: '![Adjusting source IP stack and tool identification settings](img/3121OS_03_02.jpg)'
  prefs: []
  type: TYPE_IMG
- en: In this example, `UserAgent` was set to be Google's indexing spider, the Googlebot.
    This is a common automated application that visits and indexes websites, and rarely
    attracts attention by the website's owner.
  prefs: []
  type: TYPE_NORMAL
- en: Note
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: To identify legitimate `UserAgents`, refer to the examples at [www.useragentstring.com](http://www.useragentstring.com).
  prefs: []
  type: TYPE_NORMAL
- en: Modifying packet parameters
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: The most common approach to active reconnaissance is to conduct a scan against
    the target—send defined packets to the target, and then use the returned packets
    to gain information. The most popular tool of this type is **Network Mapper**
    (**n** **map**).
  prefs: []
  type: TYPE_NORMAL
- en: To use `nmap` effectively, it must be run with root-level privileges. This is
    typical of applications that manipulate packets, which is why Kali defaults to
    root at the time of startup.
  prefs: []
  type: TYPE_NORMAL
- en: 'When attempting to minimize detection, some stealth techniques to avoid detection
    and subsequent alarms include the following:'
  prefs: []
  type: TYPE_NORMAL
- en: Identify the goal of the scan before testing and send the minimum number of
    packets needed to determine the objective. For example, if you wish to confirm
    the presence of a web host, you first need to determine if `port 80` , the default
    port for web-based services, is open.
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Avoid scans that may connect with the target system and leak data. Do not ping
    the target or use synchronize (SYN) and nonconventional packet scans, such as
    acknowledge (ACK), finished (FIN), and reset (RST) packets.
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Randomize or spoof packet settings, such as the source IP and port address,
    and the MAC address.
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Adjust the timing to slow the arrival of packets at the target site.
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Change the packet size by fragmenting packets or appending random data to confuse
    packet inspection devices.
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: 'For example, if you want to conduct a stealthy scan and minimize detection,
    the following `nmap` command could be used:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE16]'
  prefs: []
  type: TYPE_PRE
- en: 'The following table explains the previous command in detail:'
  prefs: []
  type: TYPE_NORMAL
- en: '| Command | Rationale |'
  prefs: []
  type: TYPE_TB
- en: '| --- | --- |'
  prefs: []
  type: TYPE_TB
- en: '| `--spoof-mac-Cisco` | Spoofs the MAC address to match a Cisco product. Replacing
    `Cisco` with `0` will create a completely random MAC address. |'
  prefs: []
  type: TYPE_TB
- en: '| `--data-length 24` | Appends twenty-four random bytes to most packets that
    are sent. |'
  prefs: []
  type: TYPE_TB
- en: '| `-T paranoid` | Sets the time to the slowest setting—`paranoid`. |'
  prefs: []
  type: TYPE_TB
- en: '| `-- max-hostgroup` | Limits the hosts that are scanned at a time. |'
  prefs: []
  type: TYPE_TB
- en: '| `-- max-parallelism` | Limits the number of outstanding probes that are sent
    out. You can also use the `--scan-delay` option to set a pause between the probes;
    however, this option is not compatible with the `--max_parallelism` option. |'
  prefs: []
  type: TYPE_TB
- en: '| `-PN` | Does not ping to identify active systems (this can leak data). |'
  prefs: []
  type: TYPE_TB
- en: '| `-f` | Fragments the packets; this will frequently fool low-end and improperly
    configured IDs. |'
  prefs: []
  type: TYPE_TB
- en: '| `-D 10.1.20.5, RND:5,ME` | Creates decoy scans to run simultaneously with
    the attacker''s scans; hides the actual attack. |'
  prefs: []
  type: TYPE_TB
- en: '| `-n` | No DNS resolution; internal or external DNS servers are not actively
    queried by nmap for DNS information. Such queries are frequently logged, so the
    query function should be disabled. |'
  prefs: []
  type: TYPE_TB
- en: '| `-sS` | Conducts a stealth TCP SYN scan, which does not complete the TCP
    handshake. Other scan types (for example, Null scans) can also be used; however,
    most of these will trigger detection devices. |'
  prefs: []
  type: TYPE_TB
- en: '| `-sV` | Enables version detection. |'
  prefs: []
  type: TYPE_TB
- en: '| `-oA /desktop/pentest/nmap` | Outputs the results to all formats (normal,
    greppable, and XML). |'
  prefs: []
  type: TYPE_TB
- en: '| `-p T:1-1024` | Specifies the TCP ports to be scanned. |'
  prefs: []
  type: TYPE_TB
- en: '| `-- random-hosts` | Randomizes the target host order. |'
  prefs: []
  type: TYPE_TB
- en: Together, these options will create a very slow scan that hides the true identity
    of the source. However, if the packets are too unusual, complex modification may
    actually attract the attention of the target; therefore, many testers and attackers
    use anonymity networks to minimize detection.
  prefs: []
  type: TYPE_NORMAL
- en: Using proxies with anonymity networks (Tor and Privoxy)
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: '**Tor** ([www.torproject.org](http://www.torproject.org)) is an open source
    implementation of the third generation onion routing that provides free access
    to an anonymous proxy network. Onion routing enables online anonymity by encrypting
    user traffic and then transmitting it through a series of onion routers. At each
    router, a layer of encryption is removed to obtain routing information, and the
    message is then transmitted to the next node. It has been likened to the process
    of gradually peeling an onion, hence the name. It protects against traffic analysis
    attacks by guarding the source and destination of a user''s IP traffic.'
  prefs: []
  type: TYPE_NORMAL
- en: In this example, Tor will be used with Privoxy, a noncaching web proxy that
    *sits* in the middle of an application that communicates with the Internet, and
    uses advanced filtering to ensure privacy and remove ads and potentially hostile
    data being sent to the tester.
  prefs: []
  type: TYPE_NORMAL
- en: 'To install Tor, perform the following steps:'
  prefs: []
  type: TYPE_NORMAL
- en: 'Issue the `apt-get update` and `apt-get upgrade` commands, and then use the
    following command:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE17]'
  prefs: []
  type: TYPE_PRE
- en: Once Tor is installed, edit the `Proxychains.conf` file located in the `/etc`
    directory.
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: 'This file dictates the number and order of proxies that the test system will
    use on the way to the Tor network. proxy servers may be down, or they may be experiencing
    a heavy load (causing slow or latent connections); if this occurs, a defined or
    strict proxychain will fail because an expected link is missing. Therefore, disable
    the use of `strict_chains` and enable `dynamic_chains`, which ensures that the
    connection will be routed, as shown in the following screenshot:'
  prefs: []
  type: TYPE_NORMAL
- en: '![Using proxies with anonymity networks (Tor and Privoxy)](img/3121OS_03_03.jpg)'
  prefs: []
  type: TYPE_IMG
- en: Next, edit the `[ProxyList]` section to ensure that the `socks5` proxy is present,
    as shown in the following screenshot:![Using proxies with anonymity networks (Tor
    and Privoxy)](img/3121OS_03_04.jpg)
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Open proxies can be easily found online and added to the `proxychains` file.
    Testers can take advantage of this to further obfuscate their identity. For example,
    if there are reports that a certain country or block of IP addresses has been
    responsible for recent online attacks, look for open proxies from that location
    and add them to your list, or a separate configuration file.
  prefs: []
  type: TYPE_NORMAL
- en: 'To start the Tor service from a terminal window, enter the following command:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE18]'
  prefs: []
  type: TYPE_PRE
- en: 'Verify that Tor has started by using the following command:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE19]'
  prefs: []
  type: TYPE_PRE
- en: 'It is important to verify that the Tor network is working and providing anonymous
    connectivity. Verify your source IP address first. From a terminal, enter the
    following command:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE20]'
  prefs: []
  type: TYPE_PRE
- en: 'This will start the Iceweasel browser and open it to a site that provides the
    source IP address connected with that web page. Note the IP address, and then
    invoke Tor routing using the following `proxychains` command:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE21]'
  prefs: []
  type: TYPE_PRE
- en: 'In this particular instance, the IP address was identified as `96.47.226.60`.
    A `whois` lookup of that IP address from a terminal window indicates that the
    transmission is now exiting from a Tor exit node, as shown in the following screenshot:'
  prefs: []
  type: TYPE_NORMAL
- en: '![Using proxies with anonymity networks (Tor and Privoxy)](img/3121OS_03_05.jpg)'
  prefs: []
  type: TYPE_IMG
- en: You can also verify that Tor is functioning properly by accessing [https://check.torproject.org](https://check.torproject.org).
  prefs: []
  type: TYPE_NORMAL
- en: Although communications are now protected using the Tor network, it is possible
    for a DNS leak, which occurs when your system makes a DNS request to provide your
    identity to an ISP. You can check for DNS leaks at [www.dnsleaktest.com](http://www.dnsleaktest.com).
  prefs: []
  type: TYPE_NORMAL
- en: When you test for a DNS leak, Kali's configuration of proxychains responds with
    a default source IP address of a **Level 3 Communications** server located in
    the **United States**, as shown in the following screenshot. This provides additional
    protection for the tester's identity.
  prefs: []
  type: TYPE_NORMAL
- en: '![Using proxies with anonymity networks (Tor and Privoxy)](img/3121OS_03_06.jpg)'
  prefs: []
  type: TYPE_IMG
- en: Most command lines can be run from the console using `proxychains` to access
    the Tor network.
  prefs: []
  type: TYPE_NORMAL
- en: 'When using Tor, some considerations to be kept in mind are as follows:'
  prefs: []
  type: TYPE_NORMAL
- en: Tor provides an anonymizing service, but it does not guarantee privacy. Owners
    of the exit nodes are able to sniff traffic, and reportedly may be able to access
    user credentials.
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Vulnerabilities in the Tor Browser Bundle have reportedly been used by law enforcement
    to exploit systems and gain user information.
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: ProxyChains does not handle UDP traffic.
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Some applications and services cannot run over this environment—in particular,
    Metasploit and `nmap` may break. The stealth SYN scan of `nmap` breaks out of
    proxychains and the connect scan is invoked instead; this can leak information
    to the target.
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Some browser applications (ActiveX, Adobe's PDF applications, Flash, Java, RealPlay,
    and QuickTime) can be used to obtain your IP address.
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Ensure that you clear and block cookies before browsing.
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Tip
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: The Tor-Buddy script allows you to control how frequently the Tor IP address
    is refreshed, automatically making it more difficult to identify the user's information
    ([http://sourceforge.net/projects/linuxscripts/files/Tor-Buddy/](http://sourceforge.net/projects/linuxscripts/files/Tor-Buddy/)).
  prefs: []
  type: TYPE_NORMAL
- en: Identifying the network infrastructure
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: Once the tester's identity is protected, identifying the devices on the Internet-accessible
    portion of the network is the next critical first step in scanning a network.
  prefs: []
  type: TYPE_NORMAL
- en: 'Attackers and penetration testers use this information to do the following:'
  prefs: []
  type: TYPE_NORMAL
- en: Identify devices that may confuse (load balancers) or eliminate (firewalls and
    packet inspection devices) test results
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Identify devices with known vulnerabilities
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Identify the requirement for continuing to implement *stealthy* scans
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Gain an understanding of the target's focus on secure architecture and on security
    in general
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '`traceroute` provides basic information on packet filtering abilities; some
    other applications on Kali include the following:'
  prefs: []
  type: TYPE_NORMAL
- en: '| Application | Description |'
  prefs: []
  type: TYPE_TB
- en: '| --- | --- |'
  prefs: []
  type: TYPE_TB
- en: '| lbd | Uses two DNS- and HTTP-based techniques to detect load balancers (shown
    in the following screenshot) |'
  prefs: []
  type: TYPE_TB
- en: '| miranda.py | Identifies universal plug-and-play and UPNP devices |'
  prefs: []
  type: TYPE_TB
- en: '| `nmap` | Detects devices and determines the operating systems and their version
    |'
  prefs: []
  type: TYPE_TB
- en: '| SHODAN | Web-based search engine that identifies devices connected to the
    Internet, including those with default passwords, known misconfigurations, and
    vulnerabilities |'
  prefs: []
  type: TYPE_TB
- en: The following screenshot shows the results obtained on running the `lbd` script
    against Google; as you can see, Google uses both `DNS-Loadbalancing` as well as
    `HTTP-Loadbalancing` on its site. From a penetration tester's perspective, this
    information could be used to explain why spurious results are obtained, as the
    load balancer shifts a particular tool's activity from one server to another.
  prefs: []
  type: TYPE_NORMAL
- en: '![Identifying the network infrastructure](img/3121OS_03_07.jpg)'
  prefs: []
  type: TYPE_IMG
- en: Enumerating hosts
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: Host enumeration is the process of gaining specific particulars regarding a
    defined host. It is not enough to know that a server or wireless access point
    is present; instead, we need to expand the attack surface by identifying open
    ports, the base operating system, services that are running, and supporting applications.
  prefs: []
  type: TYPE_NORMAL
- en: This is highly intrusive and unless care is taken, the active reconnaissance
    will be detected and logged by the target organization.
  prefs: []
  type: TYPE_NORMAL
- en: Live host discovery
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: The first step is to run network ping sweeps against a target address space
    and look for responses that indicate that a particular target is live and capable
    of responding. Historically, pinging referred to the use of ICMP; however, TCP,
    UDP, ICMP, and ARP traffic can also be used to identify live hosts.
  prefs: []
  type: TYPE_NORMAL
- en: 'Various scanners can be run from remote locations across the Internet to identify
    live hosts. Although the primary scanner is `nmap`, Kali provides several other
    applications that are also useful, as shown in the following table:'
  prefs: []
  type: TYPE_NORMAL
- en: '| Application | Description |'
  prefs: []
  type: TYPE_TB
- en: '| --- | --- |'
  prefs: []
  type: TYPE_TB
- en: '| `alive6` and `detect-new-ip6` | IPv6 host detection. `detect-new-ip6` runs
    on a scripted basis and identifies new IPv6 devices when added. |'
  prefs: []
  type: TYPE_TB
- en: '| `dnmap` and `nmap` | `nmap` is the standard network enumeration tool.`dnmap`
    is a distributed client-server implementation of the `nmap` scanner.PBNJ stores
    `nmap` results in a database, and then conducts historical analyses to identify
    new hosts. |'
  prefs: []
  type: TYPE_TB
- en: '| `fping`, `hping2`, `hping3`, and `nping` | Packet crafters that respond to
    targets in various ways to identify live hosts |'
  prefs: []
  type: TYPE_TB
- en: To the penetration tester or attacker, the data returned from live host discovery
    will identify the targets for attack.
  prefs: []
  type: TYPE_NORMAL
- en: Tip
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: Run multiple host discovery scans while conducting a penetration test. Certain
    devices may be time dependent. During one penetration test, it was discovered
    that the system administrator set up a game server after regular business hours.
    Because it was not an approved business system, the administrator did not follow
    the normal process for securing the server; multiple vulnerable services were
    present, and it had not received necessary security patches. Testers were able
    to compromise the game server and gain access to the underlying corporate network
    using vulnerabilities in the administrator's game server.
  prefs: []
  type: TYPE_NORMAL
- en: Port, operating system, and service discovery
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: Kali provides several different tools useful for identifying open ports, operating
    systems, and installed services on remote hosts. The majority of these functions
    can be completed using `nmap`. Although we will focus on examples using `nmap`,
    the underlying principles apply to the other tools as well.
  prefs: []
  type: TYPE_NORMAL
- en: Port scanning
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: Port scanning is the process of connecting to TCP and UDP ports to determine
    what services and applications are running on the target device. There are 65,535
    ports each for both TCP and UDP on each system. Some ports are known to be associated
    with particular services (TCP 20 and 21 are the usual ports for the **file transfer
    protocol** service (**FTP**)). The first 1,024 are the well-known ports, and most
    defined services run over ports in this range; accepted services and ports are
    maintained by IANA ([http://www.iana.org/assignments/service-names-port-numbers/service-names-port-numbers.xhtml](http://www.iana.org/assignments/service-names-port-numbers/service-names-port-numbers.xhtml)).
  prefs: []
  type: TYPE_NORMAL
- en: Tip
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: Although there are accepted ports for particular services, such as port 80 for
    web-based traffic, services can be directed to use *any* port. This option is
    frequently used to hide particular services, particularly if the service is known
    to be vulnerable to attack. However, if attackers complete a port scan and do
    not find an expected service, or find it using an unusual port, they will be prompted
    to investigate further.
  prefs: []
  type: TYPE_NORMAL
- en: The universal port mapping tool, `nmap`, relies on active stack fingerprinting.
    Specially crafted packets are sent to the target system, and the response of the
    OS to those packets allows `nmap` to identify the OS. In order for `nmap` to work,
    at least one listening port must be open, and the operating system must be known
    and fingerprinted, with a copy of that fingerprint in the local database.
  prefs: []
  type: TYPE_NORMAL
- en: 'Using `nmap` for port discovery is very *noisy*—it will be detected and logged
    by network security devices. Some points to remember are as follows:'
  prefs: []
  type: TYPE_NORMAL
- en: Attackers and penetration testers focused on stealth will test only the ports
    that impact the kill chain they are following to their specific target. If they
    are launching an attack that exploits vulnerabilities in a web server, they will
    search for targets with `port 80` or `port 8080` accessible.
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Most port scanners have default lists of ports that are scanned—ensure that
    you know what is on that list and what has been omitted. Consider both TCP and
    UDP ports.
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Successful scanning requires a deep knowledge of TCP/IP and related protocols,
    networking, and how particular tools work. For example, SCTP is an increasingly
    common protocol on networks, but it is rarely tested on corporate networks.
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Port scanning, even when done slowly, can impact a network. Some older network
    equipment and equipment from specific vendors will lock when receiving or transmitting
    a port scan, thus turning a scan into a denial of service attack.
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Tools used to scan a port, particularly `nmap`, are being extended with regards
    to functionalities. They can also be used to detect vulnerabilities and exploit
    simple security holes.
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Fingerprinting the operating system
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'Determining the operating system of a remote system is conducted using two
    types of scans:'
  prefs: []
  type: TYPE_NORMAL
- en: '**Active fingerprinting**: The attacker sends normal and malformed packets
    to the target and records its response pattern, referred to as the *fingerprint*.
    By comparing the fingerprint to a local database, the operating system can be
    determined.'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Passive fingerprinting**: The attacker *sniffs*, or records and analyses
    the packet stream to determine the characteristics of the packets.'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Active fingerprinting is faster and more accurate than passive fingerprinting.
    In Kali, the two primary active tools are `nmap` and `xprobe2`.
  prefs: []
  type: TYPE_NORMAL
- en: The `nmap` tool injects packets into the target network and analyses the response
    that it receives. In the following screenshot, the `-O` flag commands `nmap` to
    determine the operating system. Because it injects the packet into the target,
    the accuracy of the determination of the operating system by `nmap` is based on
    the number of open ports. It is usually effective at differentiating Windows from
    Unix systems, but it may not provide very specific information, such as differentiating
    between various Unix kernels. The following screenshot shows results from an `nmap`
    scan of a Windows system. Only a few ports on the target system are available
    for testing, so it cannot differentiate between Windows 7 enterprise and Windows
    XP sp3
  prefs: []
  type: TYPE_NORMAL
- en: '![Fingerprinting the operating system](img/3121OS_03_08.jpg)'
  prefs: []
  type: TYPE_IMG
- en: A related program, `xprobe2`, uses different TCP, UDP, and ICMP packets to bypass
    firewalls and avoid detection by IDS/IPS systems. `xprobe2` also uses fuzzy pattern
    matching—the operating system is not identified as definitely being one type;
    instead, it is assigned the probability of being one of several possible variants.
    As you can see in the following screenshot, this allows the tester to test vulnerabilities
    that are specific to the operating system variants; this specificity increases
    the chances of success and minimizes the risks that can occur when an exploit
    is attempted with the wrong tool.
  prefs: []
  type: TYPE_NORMAL
- en: '![Fingerprinting the operating system](img/3121OS_03_09.jpg)'
  prefs: []
  type: TYPE_IMG
- en: Note that it is simple for the target system to hide the true operating system.
    Since fingerprinting software relies on packet setting, such as time-to-live or
    the initial windows size, changes to these values or other user-configurable settings
    can change the tool results. Some organizations actively change these values to
    make the final stages of reconnaissance more difficult.
  prefs: []
  type: TYPE_NORMAL
- en: Determining active services
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: The final goal of the enumeration portion of reconnaissance is to identify the
    services and applications that are operational on the target system. If possible,
    the attacker would want to know the service type, vendor, and version to facilitate
    the identification of any vulnerability.
  prefs: []
  type: TYPE_NORMAL
- en: 'The following are some of the several techniques used to determine active services:'
  prefs: []
  type: TYPE_NORMAL
- en: '**Identify default ports and services**: If the remote system is identified
    as having a Microsoft operating system with `port 80` open (the WWW service),
    an attacker may assume that a default installation of Microsoft IIS is installed.
    Additional testing will be used to verify this assumption (`nmap`).'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Banner grabbing**: This is done using tools such as amap, netcat, `nmap`,
    and Telnet.'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Review default web pages**: Some applications install with default administration,
    error, or other pages. If attackers access these, they will provide guidance on
    installed applications that may be vulnerable to attack. In the following screenshot,
    the attacker can easily identify the version of Apache Tomcat that has been installed
    on the target system.![Determining active services](img/3121OS_03_10.jpg)'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Review source code**: Poorly configured web-based applications may respond
    to certain HTTP requests such as `HEAD` or `OPTIONS` with a response that includes
    the web server software version, and possibly, the base operating system or the
    scripting environment in use. In the following screenshot, netcat is launched
    from the command line and used to send raw `HEAD` packets to a particular website.
    This request generates an error message (**404 not found**); however, it also
    identifies that the server is running Microsoft IIS, Version 7.5.![Determining
    active services](img/3121OS_03_11.jpg)'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Employing comprehensive reconnaissance applications
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: Although Kali contains multiple tools to facilitate reconnaissance, many of
    the tools contain features that overlap, and importing data from one tool into
    another is usually a complex manual process. Most testers select a subset of tools
    and invoke them with a script.
  prefs: []
  type: TYPE_NORMAL
- en: Comprehensive tools focused on reconnaissance were originally command-line tools
    with a defined set of functions; one of the most commonly used was **Deepmagic
    Information Gathering Too**l (**DMitry**). DMitry could perform `whois` lookups,
    retrieve netcraft.com information, search for subdomains and e-mail addresses,
    and perform TCP scans. Unfortunately, it was not extensible beyond these functions.
  prefs: []
  type: TYPE_NORMAL
- en: Recent advances have created comprehensive framework applications that combine
    passive and active reconnaissance; we'll review `nmap`, `recon-ng`, and `maltego`.
  prefs: []
  type: TYPE_NORMAL
- en: nmap
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: Traditionally, `nmap` was perceived as a simple mapping tool that provided data
    on host and port availability, as well as some additional data such as the probable
    operating system of target devices.
  prefs: []
  type: TYPE_NORMAL
- en: The **Nmap Scripting Engine** (**NSE**) has transformed `nmap` into a tool that
    can conduct passive and active reconnaissance, and even perform basic vulnerability
    scanning (a full list of scripts is available at [http://nmap.org/nsedoc/](http://nmap.org/nsedoc/)).
  prefs: []
  type: TYPE_NORMAL
- en: 'Because scripts are written in the Lua scripting language, it is easy for the
    penetration testing community to modify and release scripts. Presently, scripted
    functions include the following:'
  prefs: []
  type: TYPE_NORMAL
- en: Reconnaissance of IPv4 and IPv6 DNS data
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Identifying the presence of web application firewalls, IDS, IPS, and other protective
    controls
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Testing the firewall rulesets (via firewalk) and attempting to bypass the firewall
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Harvesting user names from target and online sites
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Brute-force guessing of passwords against a variety of services and applications
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Crawling the target network to identify network shares
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Extracting of EXIF metadata from images in a defined website
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Geographical localization of IP addresses
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Conducting network attacks such as IPv6 packet flooding
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Vulnerability scanning, including fuzzing and SQL injection testing
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: As you can see, the ability to script `nmap` activities using an extensible
    language such as Lua has increased the importance of this tool.
  prefs: []
  type: TYPE_NORMAL
- en: A useful script is Marc Ruef's **vulscan** ([http://www.computec.ch/mruef/software/nmap_nse_vulscan-1.0.tar.gz](http://www.computec.ch/mruef/software/nmap_nse_vulscan-1.0.tar.gz)),
    which combines the fingerprinting feature of `nmap` (using the `–sV` flag) with
    lookups against major vulnerabilities, such as MITRE, OSVDB, and SecurityFocus.
  prefs: []
  type: TYPE_NORMAL
- en: Once you have downloaded the script package, untar the file and move the script
    files to `usr/share/nmap/scripts`.
  prefs: []
  type: TYPE_NORMAL
- en: 'To invoke one of the scripts from the command line, use the `--script` flag,
    and then identify the script name. One script that is frequently used is `nmap`''s
    general vulnerability scanner, launched using the following command:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE22]'
  prefs: []
  type: TYPE_PRE
- en: 'In this particular case, the vulnerability scan did not identify any vulnerabilities
    with known exploits, as shown in the following screenshot:'
  prefs: []
  type: TYPE_NORMAL
- en: '![nmap](img/3121OS_03_12.jpg)'
  prefs: []
  type: TYPE_IMG
- en: Tip
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: A must-have script is the SpiderLabs script to screenshot web services. It requires
    the **wkhtmltoimage** tool to be downloaded ([http://wkhtmltopdf.googlecode.com](http://wkhtmltopdf.googlecode.com))
    and placed in the `/usr/local/bin` folder. The screenshot script itself should
    then be downloaded ([https://github.com/SpiderLabs/Nmap-Tools/blob/master/NSE/http-screenshot.nse](https://github.com/SpiderLabs/Nmap-Tools/blob/master/NSE/http-screenshot.nse))
    and placed in `/usr/local/share/nmap/scripts`. When invoked, this script produces
    a visual record of all the identified web services, making it easier to select
    a target for testing later.
  prefs: []
  type: TYPE_NORMAL
- en: The recon-ng framework
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: The `recon-ng` framework is an open source framework for conducting reconnaissance
    (passive and active).
  prefs: []
  type: TYPE_NORMAL
- en: Like the Metasploit Framework and Social Engineer Toolkit, `recon-ng` uses a
    modular framework. Each module is a customized *cmd* interpreter, preconfigured
    to perform a specific task.
  prefs: []
  type: TYPE_NORMAL
- en: The `recon-ng` framework and its modules are written in Python, allowing penetration
    testers to easily build or alter modules to facilitate testing.
  prefs: []
  type: TYPE_NORMAL
- en: The `recon-ng` tool leverages third-party APIs to conduct some assessments;
    this additional flexibility means that some activities undertaken by `recon-ng`
    may be tracked by those parties. Users can specify a custom `UserAgent` string
    or proxy requests to minimize alerting the target network.
  prefs: []
  type: TYPE_NORMAL
- en: All data collected by `recon-ng` is placed in a database, allowing you to create
    various reports against the stored data. The user can select one of the report
    modules to automatically create either a CVS report, or an HTML report.
  prefs: []
  type: TYPE_NORMAL
- en: 'To use recon, perform the following steps:'
  prefs: []
  type: TYPE_NORMAL
- en: 'If `recon-ng` is not installed on your version of Kali, use the following command:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE23]'
  prefs: []
  type: TYPE_PRE
- en: To start the application, enter `recon-ng` at the prompt as shown in the following
    screenshot. The start screen will indicate the number of modules present, and
    the help command will show the commands available for navigation.![The recon-ng
    framework](img/3121OS_03_13.jpg)
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: To show the available modules, type `show` at the `recon-ng>` prompt. To load
    a specific module, type `load` followed by the name of the module. Hitting the
    tab key while typing will autocomplete the command. If the module has a unique
    name, you can type in the unique part of the name, and the module will be loaded
    without entering the full path.
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Entering `info`, as shown in the following screenshot, will provide you with
    information on how the module works, and where to obtain API keys if required.
  prefs: []
  type: TYPE_NORMAL
- en: '![The recon-ng framework](img/3121OS_03_14.jpg)'
  prefs: []
  type: TYPE_IMG
- en: Once the module is loaded, use the `set` command to set the options, and then
    enter `run` to execute, as shown in the following screenshot:![The recon-ng framework](img/3121OS_03_15.jpg)
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: 'In general, testers rely on `recon-ng` to do the following:'
  prefs: []
  type: TYPE_NORMAL
- en: Harvest contacts using `whois`, `jigsaw`, `linkedin`, and `twitter` (use the
    mangle module to extract and present e-mail data)
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Identify hosts
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Identify geographical locations of hosts and individuals using `hostop`, `ipinfodb`,
    `maxmind`, `uniapple`, and `wigle`
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Identify host information using netcraft and related modules
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Identify account and password information that has previously been compromised
    and leaked onto the Internet (the `pwnedlist` modules, `wascompanyhacked`, `xssed`,
    and `punkspider`)
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Maltego
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: '**Maltego** ([www.paterva.com](http://www.paterva.com)) is an open source intelligence
    and forensics application. The community version included with Kali sets limits
    on the size of searches; however, it is an excellent tool for visualizing relationships
    among data that use data mining and link analysis.'
  prefs: []
  type: TYPE_NORMAL
- en: Maltego allows you to enumerate personal information, linking a particular person
    with a company, e-mail addresses, websites, social networking groups, and phone
    numbers. It also facilitates passive and active reconnaissance of `whois` information,
    domain names, DNS information, IP addresses, and netblocks.
  prefs: []
  type: TYPE_NORMAL
- en: To open the application, enter `maltego` as a command prompt. The first time
    you open it, you will be required to register and verify your e-mail address with
    Paterva.
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Once you have completed registration and updating of transforms, you will be
    presented with a multipaned GUI that allows you to examine the connections between
    various data objects, as shown in the following screenshot:![Maltego](img/3121OS_03_16.jpg)
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Maltego relies on a series of transforms or modules that are stored in a palette
    on the left-hand side of the application. Transforms are selected by picking them
    from the column on the left and then dragging them into the centre of the application.
  prefs: []
  type: TYPE_NORMAL
- en: By default, the icon may be called **pantera.com** when initially selected;
    however, you can use the data manipulation areas in the right-hand column to rename
    and change data.
  prefs: []
  type: TYPE_NORMAL
- en: 'Several different transforms exist in the community edition; these are sorted
    into several groups such as **Devices**, **Infrastructure**, **Personal**, **Locations**,
    **Penetration Testing**, and **Social Network**, as shown in the following screenshot:'
  prefs: []
  type: TYPE_NORMAL
- en: '![Maltego](img/3121OS_03_17.jpg)'
  prefs: []
  type: TYPE_IMG
- en: Drag the appropriate transform onto the work sheet and right-click to reveal
    the transformations that will be completed against that transform's identity.
    Keep in mind that if you select the **All** option, processing will take a significant
    amount of time.
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: The ability to analyze relationships is particularly useful in performing social
    engineering attacks. For example, if the target's website contains multiple links
    to another website, an attacker could use this relationship for a phishing attack.
  prefs: []
  type: TYPE_NORMAL
- en: Vulnerability scanning
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: Vulnerability scanning employs automated processes and applications to identify
    vulnerabilities in a network, system, operating system, or application that may
    be exploitable.
  prefs: []
  type: TYPE_NORMAL
- en: When performed correctly, a vulnerability scan delivers an inventory of devices
    (both authorized and *rogue* devices), known vulnerabilities that have been actively
    scanned for, and usually a confirmation of how compliant the devices are with
    various policies and regulations.
  prefs: []
  type: TYPE_NORMAL
- en: 'Unfortunately, vulnerability scans are *loud*—they deliver multiple packets
    that are easily detected by most network controls and make stealth almost impossible
    to achieve. They also suffer from the following additional limitations:'
  prefs: []
  type: TYPE_NORMAL
- en: For the most part, vulnerability scanners are signature based—they can only
    detect known vulnerabilities, and only if there is an existing recognition signature
    that the scanner can apply to the target. To a penetration tester, the most effective
    scanners are open source and allow the tester to rapidly modify code to detect
    new vulnerabilities.
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Scanners produce large volumes of output, frequently containing false-positive
    results that can lead a tester astray; in particular, networks with different
    operating systems can produce false-positives with a rate as high as seventy percent.
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Scanners may have a negative impact on the network—they can create network latency
    or cause the failure of some devices (refer to the Network Scanning Watch List
    at [www.digininja.org](http://www.digininja.org), for devices known to fail as
    a result of vulnerability testing).
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: In certain jurisdictions, scanning is considered as *hacking*, and may constitute
    an illegal act.
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: There are multiple commercial and open source products that perform vulnerability
    scans. In Kali, scanning tools can be found in the **Vulnerability Analysis**
    submenu, as well as the **Web Vulnerability Scanners** menu; however, the primary
    vulnerability scanner is **Open Vulnerability Assessment System** (**OpenVAS**).
  prefs: []
  type: TYPE_NORMAL
- en: Kali supports the installation of additional scanners. If it is decided to sacrifice
    stealth for completeness during testing, always employ at least two different
    scanners to minimize false-positive results. Recommended scanners include Nexpose
    ([www.rapid7.com](http://www.rapid7.com)) and the venerable Nessus ([www.nessus.org](http://www.nessus.org)).
  prefs: []
  type: TYPE_NORMAL
- en: Summary
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: During active reconnaissance, the attackers face a very real chance of their
    activities being identified, putting them at risk. This must be balanced against
    the need to map a network, find open ports, and determine the operating system
    and applications that are installed.
  prefs: []
  type: TYPE_NORMAL
- en: To reduce risks, attackers must adopt stealthy scanning techniques. Manual approaches
    are used to create slow scans; however, this approach is not always effective.
    Therefore, attackers take advantage of tools such as the Tor network and various
    proxying applications to hide their identity.
  prefs: []
  type: TYPE_NORMAL
- en: In the next chapter, we will focus on analyzing the data from the reconnaissance
    stages and from other sources, and using it to plan and execute a remote exploit
    against a target network or system. We will review various attack techniques and
    tools and focus on how to ensure that the exploit cannot be detected by normal
    means. We will also examine remote exploitation as a continuous process—once you
    have compromised one target, how to leverage that success to pivot to new targets.
  prefs: []
  type: TYPE_NORMAL
- en: Chapter 4. Exploit
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: The goal of passive and active reconnaissance is to identify the exploitable
    security flaws that are most likely to support the tester's or attacker's objective
    (denial of service, theft, or modification of data). The exploit phase of the
    kill chain focuses on creating the access to achieve the objective—either stopping
    the access to a target by creating a denial of service or the more common approach
    of establishing persistent access to the target from the attacker.
  prefs: []
  type: TYPE_NORMAL
- en: 'The penetration tester must be concerned with the following aspects of the
    exploit phase:'
  prefs: []
  type: TYPE_NORMAL
- en: Was the target fully characterized? If the attacker does not understand the
    network and host architecture of the target, the attack will fail and there will
    be an increased risk of detection.
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Is the exploit well known, with defined actions on the target system? An uncharacterized
    exploit could have unintended consequences when employed and the resulting damage
    could have a negative impact on the testing process. Testers should validate all
    exploits in a known setting prior to use.
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Is the exploit being conducted from a remote location or is it local on the
    target system? A remote exploit is safer for the attacker because the chances
    of being positively identified are lesser; however, a local exploit gives the
    attacker more control over the exploit's action and reduces the possibility of
    detection.
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: What are the required post-exploit activities? If the attacker needs to exfiltrate
    data from the target, then the exploit must support establishing an interactive
    connection.
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Is persistent access to the compromised system required, or is the compromise
    going to be short term? This will drive the requirement for a stealthy approach.
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Thousands of exploitable vulnerabilities have been identified, and most are
    associated with at least one proof-of-concept code or technique to allow the system
    to be compromised. Nevertheless, the underlying principles that govern success
    are the same across networks, operating systems, and applications.
  prefs: []
  type: TYPE_NORMAL
- en: 'In this chapter you will learn:'
  prefs: []
  type: TYPE_NORMAL
- en: Threat modeling
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Using online and local vulnerability resources
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Exploiting a remote target using the Metasploit Framework
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Exploiting multiple targets with Armitage
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Bypassing IDs and antivirus detection
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Threat modeling
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: The passive and active reconnaissance phases map the target network and system
    and identify vulnerabilities that may be exploitable to achieve the attacker's
    objective. During this stage of the attacker's kill chain, there is a strong bias
    for action—testers want to immediately launch exploits and demonstrate that they
    can compromise the target. However, an unplanned attack may not be the most effective
    means of achieving the object, and it may sacrifice the stealth that is needed
    to achieve the objective of the attack.
  prefs: []
  type: TYPE_NORMAL
- en: Penetration testers have adopted (formally or informally) a process known as
    threat modeling, which was originally developed by network planners to develop
    defensive countermeasures against an attack.
  prefs: []
  type: TYPE_NORMAL
- en: 'Penetration testers and attackers have turned the defensive threat modeling
    methodology on its head to improve the success of an attack. Offensive threat
    modeling is a formal approach that combines the results of reconnaissance and
    research to develop an attack strategy. An attacker has to consider the available
    targets and identify the type of targets listed as follows:'
  prefs: []
  type: TYPE_NORMAL
- en: '**Primary targets**: These targets when compromised, these targets will immediately
    support the objective.'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Secondary targets**: These targets may provide information (security controls,
    password and logging policies, and local and domain administrator names and passwords)
    to support an attack or allow access to a primary target.'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Tertiary targets**: These targets may be unrelated to the testing or attack
    objective, but are relatively easy to compromise and may provide information or
    a distraction from the actual attack.'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: For each target type, the tester has to determine the approach to be used. A
    single vulnerability can be attacked using stealth techniques or multiple targets
    can be attacked using a volume of attacks in order to rapidly exploit a target.
    If a large-scale attack is implemented, the noise in the defender's control devices
    will frequently cause them to minimize logging on the router and firewall or even
    fully disable them.
  prefs: []
  type: TYPE_NORMAL
- en: 'The approach to be used will guide the selection of the exploit. Generally,
    attackers follow an attack tree methodology when creating a threat model, as shown
    in the following diagram:'
  prefs: []
  type: TYPE_NORMAL
- en: '![Threat modeling](img/3121OS_04_01.jpg)'
  prefs: []
  type: TYPE_IMG
- en: The attack tree approach allows the tester to easily visualize the attack options
    that are available and the alternative options that can be employed if a selected
    attack is not successful. Once an attack tree has been generated, the next step
    of the exploit phase is to identify the exploits that may be used to compromise
    vulnerabilities in the target.
  prefs: []
  type: TYPE_NORMAL
- en: Using online and local vulnerability resources
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: Together, passive and active reconnaissance identifies the *attack surface*
    of the target, that is, the total number of points that can be assessed for vulnerabilities.
    A server with just an operating system installed can only be exploited if there
    are vulnerabilities in that particular operating system; however, the number of
    potential vulnerabilities increases with each application that is installed.
  prefs: []
  type: TYPE_NORMAL
- en: Penetration testers and attackers must find the particular exploits that will
    compromise known and suspected vulnerabilities. The first place to start the search
    is at vendor sites; most hardware and application vendors release information
    about vulnerabilities when they release patches and upgrades. If an exploit for
    a particular weakness is known, most vendors will highlight this to their customers.
    Although their intent is to allow customers to test for the presence of the vulnerability
    themselves, attackers and penetration testers will take advantage of this information
    as well.
  prefs: []
  type: TYPE_NORMAL
- en: 'Other online sites that collect, analyze, and share information about vulnerabilities
    are as follows:'
  prefs: []
  type: TYPE_NORMAL
- en: The National Vulnerability Database that consolidates all public vulnerability
    data released by the US Government available at [http://web.nvd.nist.gov/view/vuln/search](http://web.nvd.nist.gov/view/vuln/search)
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Secunia available at [http://secunia.com/community/](http://secunia.com/community/)
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Open Source Vulnerability Database Project** (**OSVDP**) available at [http://www.osvdb.org/search/advsearch](http://www.osvdb.org/search/advsearch)'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Packetstorm security available at [http://packetstormsecurity.com/](http://packetstormsecurity.com/)
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: SecurityFocus available at [http://www.securityfocus.com/vulnerabilities](http://www.securityfocus.com/vulnerabilities)
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Inj3ct0r available at [http://1337day.com/](http://1337day.com/)
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: The Exploit Database maintained by Offensive Security available at [http://www.db-exploit.com](http://www.db-exploit.com)
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: 'The exploit database is also copied locally to Kali and it can be found in
    the `/usr/share/exploitdb` directory. Before using it, make sure that it has been
    updated using the following command:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE24]'
  prefs: []
  type: TYPE_PRE
- en: 'To search the local copy of `exploitdb`, open a terminal window and enter `searchsploit`
    and the desired search term(s) in the command prompt. This will invoke a script
    that searches a database file (`.csv`) that contains a list of all exploits. The
    search will return a description of known vulnerabilities as well as the path
    to a relevant exploit. The exploit can be extracted, compiled, and run against
    specific vulnerabilities. Take a look at the following screenshot, which shows
    the description of the vulnerabilities:'
  prefs: []
  type: TYPE_NORMAL
- en: '![Using online and local vulnerability resources](img/3121OS_04_02.jpg)'
  prefs: []
  type: TYPE_IMG
- en: Tip
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: The search script scans for each line in the CSV file from left to right, so
    the order of the search terms is important—a search for `oracle 10g` will return
    several exploits, but `10g oracle` will not return any. Also, the script is weirdly
    case sensitive; although you are instructed to use lower case characters in the
    search term, a search for `Bulletproof FTP` returns no hits, but `bulletproof
    FTP` returns seven hits, and `bulletproof ftp` returns no hits. More effective
    searches of the CSV file can be conducted using the `grep` command or a search
    tool such as KWrite (`apt-get install kwrite`).
  prefs: []
  type: TYPE_NORMAL
- en: A search of the local database may identify several possible exploits with a
    description and a path listing; however, these will have to be customized to your
    environment, and then compiled prior to use. Copy the exploit to the `/tmp` directory
    (the given path does not take into account that the `/windows/remote` directory
    resides in the `/platforms` directory).
  prefs: []
  type: TYPE_NORMAL
- en: 'Exploits presented as scripts such as Perl, Ruby, and PHP are relatively easy
    to implement. For example, if the target is a Microsoft II 6.0 server that may
    be vulnerable to a WebDAV remote authentication bypass, copy the exploit to the
    root directory and then execute as a standard Perl script, as shown in the following
    screenshot:'
  prefs: []
  type: TYPE_NORMAL
- en: '![Using online and local vulnerability resources](img/3121OS_04_03.jpg)'
  prefs: []
  type: TYPE_IMG
- en: 'Many of the exploits are available as source code that must be compiled before
    use. For example, a search for RPC-specific vulnerabilities identifies several
    possible exploits. An excerpt is shown in the following screenshot:'
  prefs: []
  type: TYPE_NORMAL
- en: '![Using online and local vulnerability resources](img/3121OS_04_04.jpg)'
  prefs: []
  type: TYPE_IMG
- en: 'The RPC DCOM vulnerability identified as `76.c` is known from practice to be
    relatively stable. So, we will use it as an example. To compile this exploit,
    copy it from the storage directory to the `/tmp` directory. In that location,
    compile using GCC with the command as follows:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE25]'
  prefs: []
  type: TYPE_PRE
- en: 'This will use the GNU Compiler Collection application to compile `76.c` to
    a file with the output (`-o`) name of `76.exe`, as shown in the following screenshot:'
  prefs: []
  type: TYPE_NORMAL
- en: '![Using online and local vulnerability resources](img/3121OS_04_05.jpg)'
  prefs: []
  type: TYPE_IMG
- en: 'When you invoke the application against the target, you must call the executable
    (which is not stored in the `/tmp` directory) using a symbolic link as follows:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE26]'
  prefs: []
  type: TYPE_PRE
- en: 'The source code for this exploit is well documented and the required parameters
    are clear at the execution, as shown in the following screenshot:'
  prefs: []
  type: TYPE_NORMAL
- en: '![Using online and local vulnerability resources](img/3121OS_04_06.jpg)'
  prefs: []
  type: TYPE_IMG
- en: 'Unfortunately, not all exploits from exploit database and other public sources
    compiled as readily as `76.c`. There are several issues that make the use of such
    exploits problematic, even dangerous, for penetration testers listed as follows:'
  prefs: []
  type: TYPE_NORMAL
- en: Deliberate errors or incomplete source code are commonly encountered as experienced
    developers attempt to keep exploits away from inexperienced users, especially
    beginners who are trying to compromise systems without knowing the risks that
    go with their actions.
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Exploits are not always sufficiently documented; after all, there is no standard
    that governs the creation and use of code intended to be used to compromise a
    data system. As a result, they can be difficult to use, particularly for testers
    who lack expertise in application development.
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Inconsistent behaviors due to changing environments (new patches applied to
    the target system and language variations in the target application) may require
    significant alterations to the source code; again, this may require a skilled
    developer.
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: There is always the risk of freely available code containing malicious functionalities.
    A penetration tester may think that he is conducting a **proof of concept** (**POC**)
    exercise and will be unaware that the exploit has also created a backdoor in the
    application being tested that could be used by the developer.
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: To ensure consistent results and create a community of coders who follow consistent
    practices, several exploit frameworks have been developed. The most popular exploitation
    framework is the Metasploit Framework.
  prefs: []
  type: TYPE_NORMAL
- en: The Metasploit Framework
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: The **Metasploit Framework** (**MSF**) is an open source tool designed to facilitate
    penetration testing. Written in the Ruby programming language, it uses a modular
    approach to facilitating exploits. This makes it easier to develop and code exploits,
    and it also allows for complex attacks to be easily implemented.
  prefs: []
  type: TYPE_NORMAL
- en: 'MSF can present multiple interfaces to the backend modules that control exploitation
    (console, CLI, and web). We will use the console interface for its speed, because
    it presents the attack commands, and it has the required configuration parameters
    in an easy-to-understand interface. To access this interface, enter `msfconsole`
    in a command prompt or select it from a drop-down menu such as **Top 10 Security
    Tools**. The following screenshot shows the splash screen when the application
    launches:'
  prefs: []
  type: TYPE_NORMAL
- en: '![The Metasploit Framework](img/3121OS_04_07.jpg)'
  prefs: []
  type: TYPE_IMG
- en: 'The MSF consists of modules that are combined to affect an exploit. The modules
    and their specific functions are as follows:'
  prefs: []
  type: TYPE_NORMAL
- en: '**Exploits**: The code fragments that target specific vulnerabilities. Active
    exploits will exploit a specific target, run until completed, and then exit (for
    example, a buffer overflow). Passive exploits wait for incoming hosts, such as
    web browsers or FTP clients, and exploit them when they connect.'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Payloads**: These are the malicious code that implement commands immediately
    following a successful exploitation.'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Auxiliary modules**: These modules do not establish or directly support access
    between the tester and the target system; instead, they perform related functions
    such as scanning, fuzzing, or sniffing that support the exploitation phase.'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Post modules**: Following a successful attack, these modules run on compromised
    targets to gather useful data and pivot the attacker deeper into the target network.
    We will learn more about the post modules in [Chapter 5](ch05.html "Chapter 5. Post
    Exploit – Action on the Objective"), *Post Exploit – Action on the Objective*.'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Encoders**: When exploits must bypass antivirus defenses, these modules encode
    the payload so that it cannot be detected using signature matching techniques.'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**No operations** (**NOPs**): These are used to facilitate buffer overflows
    during attacks.'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: 'These modules are used together to conduct reconnaissance and launch attacks
    against targets. The steps for exploiting a target system using MSF can be summarized
    as follows:'
  prefs: []
  type: TYPE_NORMAL
- en: Choose and configure an exploit (the code that compromises a specific vulnerability
    on the target system).
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Check the target system to determine if it is susceptible to attack by the exploit.
    This step is optional and is usually omitted to minimize the detection.
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Choose and configure the payload (the code that will be executed on the target
    system following a successful exploitation. For example, a reverse shell from
    the compromised system back to the source).
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Choose an encoding technique to bypass detection controls (IDs/IPs or antivirus
    software).
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Execute the exploit.
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: The next example represents a simple attack against the target Linux-based operating
    system Metasploitable2\. It is available online at [http://sourceforge.net/projects/metasploitable/files/Metasploitable2](http://sourceforge.net/projects/metasploitable/files/Metasploitable2).
    Metasploitable2 was designed to be vulnerable to attack, and it contains known
    and characterized vulnerabilities that provide a standard platform for training
    and for validating exploit tools.
  prefs: []
  type: TYPE_NORMAL
- en: 'When installed as a virtual machine (covered in [Appendix](apa.html "Appendix A. Installing
    Kali Linux"), *Installing Kali Linux*), Metasploitable can be scanned using `nmap`,
    which identifies open ports and associated applications. An excerpt of the `nmap`
    scan is shown in the following screenshot:'
  prefs: []
  type: TYPE_NORMAL
- en: '![The Metasploit Framework](img/3121OS_04_08.jpg)'
  prefs: []
  type: TYPE_IMG
- en: 'Several applications were identified by `nmap` in the preceding example. As
    a tester, we should investigate each one for any known vulnerabilities. One of
    the first places to start is, Metasploit''s own collection of exploits. This can
    be searched from the following command line using:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE27]'
  prefs: []
  type: TYPE_PRE
- en: 'The returned exploits for the samba service are listed and each of them is
    assigned a relative ranking of how successful they are at achieving an exploit.
    The following screenshot shows an excerpt of the available samba exploits:'
  prefs: []
  type: TYPE_NORMAL
- en: '![The Metasploit Framework](img/3121OS_04_09_New.jpg)'
  prefs: []
  type: TYPE_IMG
- en: The `exploit/multi/samba/usermap_script` exploit was selected for use in the
    remainder of this example because it is ranked as excellent. This ranking was
    determined by the Metasploit development team and identifies how reliably the
    exploit works for a skilled tester against a stable target system. In real life,
    multiple variables (tester skills, protective devices on the network, and modifications
    to the operating system and hosted applications) can work together to significantly
    alter the reliability of the exploit.
  prefs: []
  type: TYPE_NORMAL
- en: 'Additional information pertaining to that exploit was obtained using the following
    `info` command:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE28]'
  prefs: []
  type: TYPE_PRE
- en: 'The returned information includes references as well as the information shown
    in the following screenshot:'
  prefs: []
  type: TYPE_NORMAL
- en: '![The Metasploit Framework](img/3121OS_04_10.jpg)'
  prefs: []
  type: TYPE_IMG
- en: 'To instruct Metasploit that we will attack the target with this exploit, we
    issue the following command:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE29]'
  prefs: []
  type: TYPE_PRE
- en: Metasploit changes the command prompt from `msf>` to `msf exploit (usermap_script)
    >`.
  prefs: []
  type: TYPE_NORMAL
- en: 'Metasploit prompts the tester to select the payload (a reverse shell from the
    compromised system back to the attacker) and sets the other variables listed as
    follows:'
  prefs: []
  type: TYPE_NORMAL
- en: '**Remote host** (**RHOST**): This is the IP address of the system being attacked'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Remote port** (**RPORT**): This is the port number that is used for the exploit'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Local host** (**LHOST**): This is the IP address of the system used to launch
    the attack'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: The attack is launched by entering the `exploit` command at the prompt after
    all variables have been set. Metasploit initiates the attack and confirms that
    a reverse shell is present by indicating `command shell 1 opened` and giving the
    IP addresses that originate and terminate the reverse shell.
  prefs: []
  type: TYPE_NORMAL
- en: 'To verify that a shell is present, the tester can issue queries for the hostname,
    username (`uname -a`), and `whoami` to confirm that the results are specific to
    the target system that is located at a remote location. Take a look at the following
    screenshot:'
  prefs: []
  type: TYPE_NORMAL
- en: '![The Metasploit Framework](img/3121OS_04_11.jpg)'
  prefs: []
  type: TYPE_IMG
- en: When a system is compromised to this extent, it is ready for the post-exploitation
    activities ( see [Chapter 5](ch05.html "Chapter 5. Post Exploit – Action on the
    Objective"), *Post Exploit – Action on the Objective* and [Chapter 6](ch06.html
    "Chapter 6. Post Exploit – Persistence"), *Post Exploit – Persistence*). To add
    new exploits to Metasploit, in Ruby script (`.rb`) or Python (`.py`), place them
    in the hidden `.msf4` folder located in your home directory, and then reload `msfconsole`.
  prefs: []
  type: TYPE_NORMAL
- en: Exploiting a vulnerable application
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: The Metasploit Framework is equally effective against vulnerabilities in the
    operating system as well as third-party applications. In this example, we'll exploit
    a buffer overflow vulnerability that was identified in Chasys Draw IES (Version
    4.10.01). The vulnerability exists in the `ReadFile` function, which is used to
    store user-provided data in an insecure way. Exploitation results in arbitrary
    code execution under the context of the user.
  prefs: []
  type: TYPE_NORMAL
- en: To initiate the attack, the tester needs to generate a specially crafted BMP
    file and then get the victim to open that file in the Chasys application. When
    this occurs, it will compromise the base operating system (effective against Windows
    XP SP3 and Windows 7 SP1).
  prefs: []
  type: TYPE_NORMAL
- en: 'The first step is to open `msfconsole` and set Metasploit to use `exploit/windows/fileformat/chasys_draw_ies_bof`,
    as shown in the following screenshot:'
  prefs: []
  type: TYPE_NORMAL
- en: '![Exploiting a vulnerable application](img/3121OS_04_12.jpg)'
  prefs: []
  type: TYPE_IMG
- en: Again, the exploit is a relatively simple exploit. It requires the tester to
    set a reverse shell (`reverse_tcp`) from the compromised system back to the tester's
    system, the **Local Host** (**LHOST**).
  prefs: []
  type: TYPE_NORMAL
- en: When the exploit is completed, it creates the specially-crafted BMP file, which
    is stored with the default name of `msf.bmp`. To entice the target to open the
    file and avoid a default name that may be detected by some devices, it is best
    to change the filename to something that is more relevant to the intended target.
  prefs: []
  type: TYPE_NORMAL
- en: 'The next step is to open a new instance of `msfconsole`, and set up a *listener*
    for the incoming reverse TCP shell that will originate from the target when it
    is compromised. A simple listener is shown in the following screenshot:'
  prefs: []
  type: TYPE_NORMAL
- en: '![Exploiting a vulnerable application](img/3121OS_04_13.jpg)'
  prefs: []
  type: TYPE_IMG
- en: 'Once the victim opens the crafted BMP image file in the vulnerable application,
    a `meterpreter` session is opened between the two systems. The `msf` prompt is
    replaced by the `meterpreter` prompt and the tester can effectively access the
    remote system with a command shell. One of the first steps after the compromise
    is to verify that you are on the target system; as you can see in the following
    screenshot, the `sysinfo` command identifies the computer name and operating system,
    verifying a successful attack:'
  prefs: []
  type: TYPE_NORMAL
- en: '![Exploiting a vulnerable application](img/3121OS_04_14_New.jpg)'
  prefs: []
  type: TYPE_IMG
- en: Exploiting multiple targets with Armitage
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: Armitage is frequently overlooked by penetration testers who eschew its GUI
    interface in favor of the traditional command-line input of the Metasploit console.
    However, it possesses Metasploit's functionality while giving visibility to its
    many possible options, making it a good alternative in complex testing environments.
    Unlike Metasploit, it also allows you to test multiple targets at the same time—up
    to 512 targets at once.
  prefs: []
  type: TYPE_NORMAL
- en: 'To start Armitage, ensure that the database and Metasploit services are started
    using the following command:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE30]'
  prefs: []
  type: TYPE_PRE
- en: After that step, enter `armitage` over the command prompt to execute the command.
    Armitage does not always execute cleanly and it may require the launch steps to
    be repeated to ensure that it is functioning correctly.
  prefs: []
  type: TYPE_NORMAL
- en: To discover available targets, you can manually add a host by providing its
    IP address or select an `nmap` scan from the **Hosts** tab on the menu bar. Armitage
    can also enumerate targets using MSF auxiliary commands or DNS enumeration.
  prefs: []
  type: TYPE_NORMAL
- en: 'Armitage can also import host data from the following files: Acunetix, amap,
    AppScan, Burp proxy, Foundstone, Microsoft Baseline Security Analyzer, Nessus
    NBE and XML files, NetSparker, NeXpose, nmap, OpenVas, Qualys, and Retina. The
    initial Armitage start-screen is shown in the following screenshot:'
  prefs: []
  type: TYPE_NORMAL
- en: '![Exploiting multiple targets with Armitage](img/3121OS_04_15.jpg)'
  prefs: []
  type: TYPE_IMG
- en: 'Armitage allows you to set a host label by selecting a host using a right-click,
    and then going to the **Host** menu and selecting the **Set Label…** function.
    This allows you to flag a particular address or identify it by a common name,
    which is helpful when using team-based testing. This process is shown in the following
    screenshot:'
  prefs: []
  type: TYPE_NORMAL
- en: '![Exploiting multiple targets with Armitage](img/3121OS_04_16.jpg)'
  prefs: []
  type: TYPE_IMG
- en: Armitage also supports dynamic workspaces—a filtered view of the network based
    on network criteria, operating system, open ports and services, and labels. For
    example, you may test a network and identify several servers that do not appear
    to be patched to the extent of the remainder of the network. These can be highlighted
    by giving them a label and then placing them in a priority workspace.
  prefs: []
  type: TYPE_NORMAL
- en: Once you have identified the target systems that are present on a network, you
    can select specific modules to implement as part of the exploitation process.
    You can also use the **Attacks** option in the menu bar to find attacks.
  prefs: []
  type: TYPE_NORMAL
- en: To exploit a host, select it with a right-click, navigate to the **Attack**
    item, and choose an exploit (make sure that the operating system is set for the
    correct host; this does not always happen automatically).
  prefs: []
  type: TYPE_NORMAL
- en: One interesting option is **Hail Mary**, located under the **Attacks** option.
    By selecting this function, all identified systems are automatically subjected
    to exploits to achieve the greatest number of possible compromises. This is a
    very noisy attack and should therefore be used as a test choice of the last resort.
    It is also an excellent way to determine if an intrusion detection system is implemented
    and configured properly!
  prefs: []
  type: TYPE_NORMAL
- en: 'A system that is compromised shows up as an icon with a red border with electrical
    sparks. In the next screenshot, two test systems have been compromised and there
    are four active sessions in place between these systems and the tester. The `Active
    Sessions` panel indicates the connections and identifies what exploit was used
    to compromise the target. Take a look at the following screenshot that represents
    the different options:'
  prefs: []
  type: TYPE_NORMAL
- en: '![Exploiting multiple targets with Armitage](img/3121OS_04_17.jpg)'
  prefs: []
  type: TYPE_IMG
- en: Tip
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: During a penetration test that was conducted, the **Hail Mary** option identified
    two exploitable vulnerabilities with the target and initiated two active sessions.
    Manual testing with the same target eventually identified eight exploitable vulnerabilities,
    with multiple communications channels between the compromised system and the tester.
    Real-world tests of this type reinforce the advantages and weaknesses of automated
    tools during the penetration testing process.
  prefs: []
  type: TYPE_NORMAL
- en: Team testing with Armitage
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'Armitage is more than a GUI frontend for the Metasploit Framework; it is a
    scriptable penetration testing tool that allows a team to use a single instance
    of the Metasploit Framework so that the GUI displays the following functions:'
  prefs: []
  type: TYPE_NORMAL
- en: It uses the same session, allowing one tester to oversee the process, identify
    findings of interest, and control the direction of testing.
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: It runs scripts to automate testing tasks.
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: It shares downloaded files such as password files. This allows one team member
    to focus on password cracking, while other team members continue the exploitation
    phase.
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: It communicates using a shared event log.
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: 'To take advantage of the team configuration, ensure that Armitage is not already
    running and then invoke the `teamserver` script from a console prompt in the `Armitage`
    directory, usually `/usr/share/armitage`, as follows:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE31]'
  prefs: []
  type: TYPE_PRE
- en: Ensure that the IP address is correct, as it is not verified by Armitage, and
    that all team members can access the host on port `55553`. When you start the
    Armitage team server, it communicates with team members using an SSL certificate;
    team members should verify that the SHA-1 hash of the certificate matches the
    server's SSL certificate.
  prefs: []
  type: TYPE_NORMAL
- en: Do not connect to `127.0.0.1` when the `teamserver` script is running, as Armitage
    uses that IP address to connect and determine whether it should use SSL (`teamserver`
    or a remote address) or non-SSL (`localhost` or `msfrpcd`). To connect Armitage
    to `teamserver` locally, use the external IP address in the **Host** field.
  prefs: []
  type: TYPE_NORMAL
- en: Users can open one or more command shells, browse files, download data, and
    take screenshots. Shell sessions are automatically locked when in use, and then
    unlocked. However, some meterpreter scripts may fail to function over time.
  prefs: []
  type: TYPE_NORMAL
- en: To communicate as a team, the **View** option in the menu opens the shared event
    log. You can make entries onto the log as you would if you were using IRC or some
    other chat room, and the log keeps a permanent record of all comments.
  prefs: []
  type: TYPE_NORMAL
- en: Scripting the Armitage attack
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: Armitage includes the Cortana scripting language, which is based on Sleep, an
    extensible language that resembles Perl. Cortana scripts may define keyboard shortcuts,
    insert menus, and create unique user interfaces.
  prefs: []
  type: TYPE_NORMAL
- en: Scripts may be run as standalone entities (which requires that the Armitage
    team server be active) or directly from Armitage. To load an existing script,
    select **Armitage** in the main menu bar, and then select **Scripts**. A tabbed
    view will open and a button will give you the option to load a script.
  prefs: []
  type: TYPE_NORMAL
- en: 'Armitage also provides a scripting environment which is invoked from the **View
    | Script Console** tab of the menu, as seen in the following screenshot:'
  prefs: []
  type: TYPE_NORMAL
- en: '![Scripting the Armitage attack](img/3121OS_04_18.jpg)'
  prefs: []
  type: TYPE_IMG
- en: 'A sample script to fully scan target systems using the Metasploit Framework
    could be written as `scanner.cna`. Whenever a new host is added (`host_add`),
    the MSF port scanner will scan for a defined list of TCP ports and for available
    UDP ports. Take a look at the following code snippet, which shows the scanner
    script:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE32]'
  prefs: []
  type: TYPE_PRE
- en: Because Cortana has extensive hooks into the Metasploit Framework, scripts can
    be used to automatically launch exploits, conduct post-exploitation activities,
    such as tracking user activity, and facilitate multiuser activities across the
    attacker's kill chain.
  prefs: []
  type: TYPE_NORMAL
- en: Bypassing IDs and antivirus detection
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: The exploitation phase of the kill chain is the most dangerous one for the penetration
    tester or attacker—they are directly interacting with the target network or system
    and there is a great chance for their activity to be logged or their identity
    discovered. Again, stealth must be employed to minimize risks to the tester. Although
    no specific methodology or tool is undetectable, there are some configuration
    changes and specific tools that will make detection more difficult.
  prefs: []
  type: TYPE_NORMAL
- en: When considering remote exploits, most networks and systems employ various types
    of defensive controls to minimize the risk of attack. Network devices include
    routers, firewalls, intrusion detection and prevention systems, and malware detection
    software.
  prefs: []
  type: TYPE_NORMAL
- en: To facilitate exploitation, most frameworks incorporate features to make the
    attack somewhat stealthy. The Metasploit Framework allows you to manually set
    evasion factors on an exploit-by-exploit basis; however, determining which factors
    (such as encryption, port number, filenames, and others) can be difficult and
    change for each particular ID. The Metasploit Framework also allows communication
    between the target and the attacking systems to be encrypted (the `windows/meterpreter/reverse_tcp_rc4`
    payload), making it difficult for the exploit payload to be detected.
  prefs: []
  type: TYPE_NORMAL
- en: 'Metasploit Pro, available as a trial on the Kali distribution, includes the
    following to specifically bypass intrusion detection systems:'
  prefs: []
  type: TYPE_NORMAL
- en: Scan speed can be adjusted in the settings for **Discovery Scan**, reducing
    the interaction speed with the target by setting the speed to **sneaky** or **paranoid**
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Implement transport evasion by sending smaller TCP packets and increasing the
    transmission time between the packets
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Reducing the number of simultaneous exploits launched against a target system
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Application-specific evasion options for exploits that involve DCERPC, HTTP,
    and SMB can be automatically set
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Most antivirus software rely on signature matching to locate viruses and other
    malware. They examine each executable for strings of code known to be present
    in viruses (the signature) and create an alarm when a suspect string is detected.
    Many of Metasploit's attacks rely on files that may possess a signature that,
    over time, has been identified by antivirus vendors.
  prefs: []
  type: TYPE_NORMAL
- en: In response to this, the Metasploit Framework allows standalone executables
    to be encoded to bypass detection. Unfortunately, extensive testing of these executables
    at public sites, such as [virustotal.com](http://virustotal.com), have lessened
    their effectiveness in bypassing the AV software.
  prefs: []
  type: TYPE_NORMAL
- en: A new AV-evasion framework, written by Chris Truncer, called Veil-Evasion ([www.Veil-Evasion.com](http://www.Veil-Evasion.com)),
    is now providing effective protection against the detection of standalone exploits.
    Veil-Evasion aggregates various shellcode injection techniques into a framework
    that simplifies management.
  prefs: []
  type: TYPE_NORMAL
- en: 'As a framework, Veil-Evasion possesses several features, which includes the
    following:'
  prefs: []
  type: TYPE_NORMAL
- en: It incorporates custom shellcode in a variety of programming languages, including
    C, C#, and Python
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: It can use Metasploit-generated shellcode
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: It can integrate third-party tools such as Hyperion (encrypts an EXE file with
    AES-128 bit encryption), PEScrambler, and BackDoor Factory
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: The `Veil-Evasion_evasion.cna` script allows for Veil-Evasion to be integrated
    into Armitage and its commercial version, Cobalt Strike
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Payloads can be generated and seamlessly substituted into all PsExec calls
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Users have the ability to reuse shellcode or implement their own encryption
    methods
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: It's functionality can be scripted to automate deployment
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Veil-Evasion is under constant development and the framework has been extended
    with modules such as Veil-Evasion-Catapult (the payload delivery system)
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: 'Veil-Evasion can generate an exploit payload; the standalone payloads include
    the following options:'
  prefs: []
  type: TYPE_NORMAL
- en: Minimal Python installation to invoke shellcode; it uploads a minimal `Python.zip`
    installation and the 7zip binary. The Python environment is unzipped, invoking
    the shellcode. Since the only files that interact with the victim are trusted
    Python libraries and the interpreter, the victim's AV does not detect or alarm
    on any unusual activity.
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Sethc backdoor, which configures the victim's registry to launch the sticky
    keys RDP backdoor.
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: PowerShell shellcode injector.
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: 'When the payloads have been created, they can be delivered to the target in
    one of the following two ways:'
  prefs: []
  type: TYPE_NORMAL
- en: Upload and execute using Impacket and PTH toolkit
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: UNC invocation
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Veil-Evasion is available from the Kali repositories, such as Veil-Evasion,
    and it is automatically installed by simply entering `apt-get install veil-evasion`
    in a command prompt.
  prefs: []
  type: TYPE_NORMAL
- en: Note
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: If you receive any errors during installation, re-run the `/usr/share/veil-evasion/setup/setup.sh`
    script.
  prefs: []
  type: TYPE_NORMAL
- en: 'Veil-Evasion presents the user with the main menu, which provides the number
    of payload modules that are loaded as well as the available commands. Typing `list`
    will list all available `payloads`, `list langs` will list the available language
    payloads, and `list <language>` will list the payloads for a specific language.
    Veil-Evasion''s initial launch screen is shown in the following screenshot:'
  prefs: []
  type: TYPE_NORMAL
- en: '![Bypassing IDs and antivirus detection](img/3121OS_04_19.jpg)'
  prefs: []
  type: TYPE_IMG
- en: 'Veil-Evasion is undergoing rapid development with significant releases on a
    monthly basis and important upgrades occurring more frequently. Presently, there
    are 24 payloads designed to bypass antivirus by employing encryption or direct
    injection into the memory space. These payloads are shown in the next screenshot:'
  prefs: []
  type: TYPE_NORMAL
- en: '![Bypassing IDs and antivirus detection](img/3121OS_04_20.jpg)'
  prefs: []
  type: TYPE_IMG
- en: 'To obtain information on a specific payload, type `info<payload number / payload
    name>` or `info <tab>` to autocomplete the payloads that are available. You can
    also just enter the number from the list. In the following example, we entered
    `19` to select the `python/shellcode_inject/aes_encrypt` payload:'
  prefs: []
  type: TYPE_NORMAL
- en: '![Bypassing IDs and antivirus detection](img/3121OS_04_21.jpg)'
  prefs: []
  type: TYPE_IMG
- en: The exploit includes an `expire_payload` option. If the module is not executed
    by the target user within a specified timeframe, it is rendered inoperable. This
    function contributes to the stealthiness of the attack.
  prefs: []
  type: TYPE_NORMAL
- en: The required options include the name of the options as well as the default
    values and descriptions. If a required value isn't completed by default, the tester
    will need to input a value before the payload can be generated. To set the value
    for an option, enter `set <option name>` and then type the desired value. To accept
    the default options and create the exploit, type `generate` in the command prompt.
  prefs: []
  type: TYPE_NORMAL
- en: 'If the payload uses shellcode, you will be presented with the shellcode menu,
    where you can select `msfvenom` (the default shellcode) or a custom shellcode.
    If the custom shellcode option is selected, enter the shellcode in the form of
    `\x01\x02`, without quotes and newlines (`\n`). If the default `msfvenom` is selected,
    you will be prompted with the default payload choice of `windows/meterpreter/reverse_tcp`.
    If you wish to use another payload, press *Tab* to complete the available payloads.
    The available payloads are shown in the following screenshot:'
  prefs: []
  type: TYPE_NORMAL
- en: '![Bypassing IDs and antivirus detection](img/3121OS_04_22.jpg)'
  prefs: []
  type: TYPE_IMG
- en: 'In the following example, the `[tab]` command was used to demonstrate some
    of the available payloads; however, the default (`windows/meterpreter/reverse_tcp`)
    was selected, as shown in the following screenshot:'
  prefs: []
  type: TYPE_NORMAL
- en: '![Bypassing IDs and antivirus detection](img/3121OS_04_23.jpg)'
  prefs: []
  type: TYPE_IMG
- en: 'The user will then be presented with the output menu with a prompt to choose
    the base name for the generated payload files. If the payload was Python-based
    and you selected `compile_to_exe` as an option, the user will have the option
    of either using `Pyinstaller` to create the EXE file, or generating Py2Exe files,
    as shown in the following screenshot:'
  prefs: []
  type: TYPE_NORMAL
- en: '![Bypassing IDs and antivirus detection](img/3121OS_04_24.jpg)'
  prefs: []
  type: TYPE_IMG
- en: 'The final screen displays information on the generated payload, as shown in
    the following screenshot:'
  prefs: []
  type: TYPE_NORMAL
- en: '![Bypassing IDs and antivirus detection](img/3121OS_04_25.jpg)'
  prefs: []
  type: TYPE_IMG
- en: 'The exploit could also have been created directly from a command line using
    the following options:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE33]'
  prefs: []
  type: TYPE_PRE
- en: Once an exploit has been created, the tester should verify the payload against
    VirusTotal to ensure that it will not trigger an alert when it is placed on the
    target system. If the payload sample is submitted directly to VirusTotal and it's
    behavior flags it as malicious software, then a signature update against the submission
    can be released by **antivirus** (**AV**) vendors in as little as one hour. This
    is why users are clearly admonished with the message "don't submit samples to
    any online scanner!"
  prefs: []
  type: TYPE_NORMAL
- en: 'Veil-Evasion allows testers to use a safe check against VirusTotal. When any
    payload is created, a SHA1 hash is created and added to `hashes.txt`, located
    in the `~/veil-output` directory. Testers can invoke the `checkvt` script to submit
    the hashes to VirusTotal, which will check the SHA1 hash values against its malware
    database. If a Veil-Evasion payload triggers a match, then the tester knows that
    it may be detected by the target system. If it does not trigger a match, then
    the exploit payload will bypass the antivirus software. A successful lookup (not
    detectable by AV) using the `checkvt` command is shown as follows:'
  prefs: []
  type: TYPE_NORMAL
- en: '![Bypassing IDs and antivirus detection](img/3121OS_04_26.jpg)'
  prefs: []
  type: TYPE_IMG
- en: Testing, thus far supports the finding that if `checkvt` does not find a match
    on VirusTotal, the payload will not be detected by the target's antivirus software.
    To use with the Metasploit Framework, use `exploit/multi/handler` and set `PAYLOAD`
    to be `windows/meterpreter/reverse_tcp` (the same as the Veil-Evasion payload
    option), with the same LHOST and LPORT used with Veil-Evasion as well. When the
    listener is functional, send the exploit to the target system. When the listeners
    launch it, it will establish a reverse shell back to the attacker's system.
  prefs: []
  type: TYPE_NORMAL
- en: Summary
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: In this chapter, we focused on exploits as the tool that converts the findings
    from reconnaissance into a defined action that establishes access between the
    tester and the target.
  prefs: []
  type: TYPE_NORMAL
- en: Kali provides several tools to facilitate the development, selection, and activation
    of exploits, including the internal exploit-db database as well as several frameworks
    that simplify the use and management of the exploits. Among these frameworks,
    the Metasploit Framework and Armitage are particularly important; however, Veil-Evasion
    enhances both with its ability to bypass antivirus detection.
  prefs: []
  type: TYPE_NORMAL
- en: The next two chapters focus on the most important part of the attacker's kill
    chain—the post-exploitation activities. This is the part of the attack where the
    attackers achieve their objective. Typical post-exploitation activities include
    theft and exfiltration of data (proprietary or financial information), horizontal
    escalation by taking advantage of poor access controls, and vertical escalation
    by theft of user credentials.
  prefs: []
  type: TYPE_NORMAL
- en: Chapter 5. Post Exploit – Action on the Objective
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: In the modern world of hacking and system attacks, attackers are not as concerned
    with exploitation as they are with what can be done with that access. This is
    the part of the kill chain where the attacker achieves the full value of the attack.
  prefs: []
  type: TYPE_NORMAL
- en: 'Once a system has been compromised, the attacker generally performs the following
    activities:'
  prefs: []
  type: TYPE_NORMAL
- en: Conducts a rapid assessment to characterize the local environment (infrastructure,
    connectivity, accounts, presence of target files, and applications that can facilitate
    further attacks)
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Locates and copies or modifies target files of interest, such as datafiles (proprietary
    data and financial information)
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Creates additional accounts and modifies the system to support post-exploitation
    activities
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Attempts to vertically escalate the privilege level used for access by capturing
    administrator or system-level credentials
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Attempts to attack other data systems (horizontal escalation) by pivoting the
    attack through the compromised system to the remainder of the network
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Installs persistent backdoors and covert channels to retain control and have
    secure communications with the compromised system (this is covered in [Chapter
    6](ch06.html "Chapter 6. Post Exploit – Persistence"), *Post Exploit – Persistence*)
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Removes indications of the attack from the compromised system
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: To be successful, the post-exploit activities require comprehensive knowledge
    of the target's operating system and file structure to ensure that protective
    controls can be bypassed. The first post-exploitation step is a reconnaissance
    of the compromised system in the context of the local network.
  prefs: []
  type: TYPE_NORMAL
- en: 'In this chapter, you will learn the following:'
  prefs: []
  type: TYPE_NORMAL
- en: How to bypass Windows **User Account Control** (**UAC**)
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: How to conduct a rapid reconnaissance of a compromised system
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: How to obtain sensitive data from a compromised system (pillaging)
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: How to create additional accounts
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: How to use Metasploit Framework to conduct post-exploitation activities
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Vertical and horizontal escalation techniques to improve your access rights
    and increase the number of compromised accounts
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: How to use anti-forensic techniques to cover your tracks and prevent the compromise
    from being discovered
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Bypassing Windows User Account Control
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: 'In Windows Vista and higher versions, Microsoft introduced security controls
    to restrict processes from running at three different integrity levels: high,
    medium, and low. A high integrity process has administrator rights, a medium-level
    process runs with a standard user''s rights, and a low integrity process is restricted,
    enforcing that programs do minimal damage if they are compromised.'
  prefs: []
  type: TYPE_NORMAL
- en: 'To perform any privileged actions, a program must run as an administrator and
    comply with the UAC settings. The four UAC settings are as follows:'
  prefs: []
  type: TYPE_NORMAL
- en: '**Always notify**: This is the most stringent setting, and it will prompt the
    local user whenever any program wants to use higher level privileges.'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Notify me only when programs try to make changes to my computer**: This is
    the default UAC setting. It does not prompt the user when a native Windows program
    requests higher level privileges. However, it will prompt if a third-party program
    wants elevated privileges.'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Notify me only when programs try to make changes to my computer (don''t dim
    my desktop)**: This is the same as the default setting, but it does not dim the
    system''s monitor when prompting the user.'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Never notify**: This option reverts the system to pre-Vista days. If the
    user is an administrator, all programs will run with high integrity.'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: 'Therefore, immediately after exploitation, the tester (and attacker) wants
    to know the following two things:'
  prefs: []
  type: TYPE_NORMAL
- en: Who is the user that the system has identified?
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: What rights do they have on the system?
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: 'This can be determined using the following command:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE34]'
  prefs: []
  type: TYPE_PRE
- en: 'A compromised system is operating in a high-integrity context, as shown by
    the `Mandatory Label\High Mandatory Level Label` in the following screenshot:'
  prefs: []
  type: TYPE_NORMAL
- en: '![Bypassing Windows User Account Control](img/3121OS_05_01.jpg)'
  prefs: []
  type: TYPE_IMG
- en: If the `Label` is `Mandatory Label\Medium Mandatory Level`, the tester will
    need to elevate from standard user privileges to administrator rights for many
    of the post-exploit steps to be successful.
  prefs: []
  type: TYPE_NORMAL
- en: The first option to elevate privileges is to run `exploit/windows/local/ask`,
    from Metasploit, which launches the `RunAs` attack. This will create an executable
    that, when invoked, will run a program to request elevated rights. The executable
    should be created using the `EXE::Custom` option or encrypted using `Veil-Evasion`
    to avoid detection by the local antivirus.
  prefs: []
  type: TYPE_NORMAL
- en: The disadvantage of the `RunAs` attack is that the user will be prompted that
    a program from an unknown publisher wants to make changes to the computer. This
    alert may cause the privilege escalation to be identified as an attack.
  prefs: []
  type: TYPE_NORMAL
- en: If the system's current user is in an administrator's group, and if the UAC
    is set to the default **Notify me only when programs try to make changes to my
    computer** (it will not work if set to **Always Notify**), an attacker will be
    able to use the Metasploit `exploit/windows/local/bypassuac` module to elevate
    their privileges.
  prefs: []
  type: TYPE_NORMAL
- en: The `bypassuac` module creates multiple artifacts on the target system and can
    be recognized by most antivirus software. However, the `exploit/windows/local/bypassuac_inject`
    module places the executable directly into a reflective DLL running in memory,
    and it does not touch the hard disk, minimizing the opportunity for detection
    by the antivirus software.
  prefs: []
  type: TYPE_NORMAL
- en: 'Some caveats when attempting to bypass the UAC controls are as follows:'
  prefs: []
  type: TYPE_NORMAL
- en: Bypass UAC attacks do not work against Windows Vista where the user needs to
    acknowledge every privileged access.
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Windows 8 remains vulnerable to this attack. However, Metasploit Framework attack
    does not presently work with Windows 8.1\. If it is attempted, the user will be
    prompted to click on an OK button before the attack can obtain elevated privileges—which
    is hardly a stealthy attack. Attackers can modify the attack by selecting to use
    `exploit/windows/local/ask`, which will improve the chance of success.
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: When considering system-to-system movement (horizontal/lateral escalation),
    and if the current user is a domain user with local admin privileges on other
    systems, you can use the existing authentication token to gain access and bypass
    UAC. A common attack to achieve this is the Metasploit `exploit/windows/local/current_user_psexec`.
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Conducting a rapid reconnaissance of a compromised system
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: Once a system has been compromised, the attacker needs to gain critical information
    about that system, its network environment, users, and user accounts. Usually,
    they will enter a series of commands or a script invoking these commands from
    the shell prompt.
  prefs: []
  type: TYPE_NORMAL
- en: 'If the compromised system is based on the Unix platform, typical local reconnaissance
    commands will include the following:'
  prefs: []
  type: TYPE_NORMAL
- en: '| Command | Description |'
  prefs: []
  type: TYPE_TB
- en: '| --- | --- |'
  prefs: []
  type: TYPE_TB
- en: '| `/etc/resolv.conf` | Use the `copy` command to access and review the system''s
    current DNS settings. Because it is a global file with read privileges, it will
    not trigger alarms when accessed. |'
  prefs: []
  type: TYPE_TB
- en: '| `/etc/passwd` and `/etc/shadow` | These are system files that contains username
    and password hashes. It can be copied by a person with root-level access, and
    the passwords can be broken using a tool such as John the Ripper. |'
  prefs: []
  type: TYPE_TB
- en: '| `whoami and who -a` | Identify the users on a local system. |'
  prefs: []
  type: TYPE_TB
- en: '| `ifconfig -a`, `iptables -L -n`, and `netstat -r` | Provide networking information.
    `ifconfig -a` provides IP addressing details, `iptables -L -n` lists all of the
    rules held in the local firewall (if present), and `netstat -r` displays the routing
    information maintained by the kernel. |'
  prefs: []
  type: TYPE_TB
- en: '| `uname -a` | Prints the kernel version. |'
  prefs: []
  type: TYPE_TB
- en: '| `ps aux` | Prints currently running services, the process ID, and additional
    information. |'
  prefs: []
  type: TYPE_TB
- en: '| `dpkg -l yum list &#124; grep installed` and `dpkg -l rpm -qa --last &#124;
    head` | Identify the installed software packages. |'
  prefs: []
  type: TYPE_TB
- en: These commands contain a brief synopsis of the available options. Refer to the
    appropriate command's help file for complete information on how it can be used.
  prefs: []
  type: TYPE_NORMAL
- en: 'For a Windows system, the following commands will be entered:'
  prefs: []
  type: TYPE_NORMAL
- en: '| Command | Description |'
  prefs: []
  type: TYPE_TB
- en: '| --- | --- |'
  prefs: []
  type: TYPE_TB
- en: '| `whoami /all` | Lists the current user, SID, user privileges, and groups.
    |'
  prefs: []
  type: TYPE_TB
- en: '| `ipconfig /all` and `ipconfig /displaydns` | Display information regarding
    the network interface, connectivity protocols, and local DNS cache. |'
  prefs: []
  type: TYPE_TB
- en: '| `netstat -bnao` and `netstat -r` | List the ports and connections with corresponding
    processes (`-b`) to no lookups (`-n`), all connections (`-a`), and parent process
    IDs (`-o`). The `-r` option displays the routing table. They require administrator
    rights to run. |'
  prefs: []
  type: TYPE_TB
- en: '| `net view` and `net view /domain` | Queries NBNS/SMB to locate all of the
    hosts in the current workgroup or domain. All of the domains available to the
    host are given by `/domain` . |'
  prefs: []
  type: TYPE_TB
- en: '| `net user /domain` | Lists all of the users in the defined domain. |'
  prefs: []
  type: TYPE_TB
- en: '| `net user %username% /domain` | Obtains information on the current user if
    they are part of the queried domain (if you are local user, then `/domain` is
    not required). It includes the login times, the last time that the password was
    changed, the logon scripts, and the group memberships. |'
  prefs: []
  type: TYPE_TB
- en: '| `net accounts` | Prints the password policy for the local system. To print
    the password policy for the domain, use `net accounts /domain`. |'
  prefs: []
  type: TYPE_TB
- en: '| `net localgroup administrators` | Prints the members of the administrator''s
    local group. Use the `/domain` switch to obtain the administrators for the current
    domain. |'
  prefs: []
  type: TYPE_TB
- en: '| `net group "Domain Controllers" /domain` | Prints the list of domain controllers
    for the current domain. |'
  prefs: []
  type: TYPE_TB
- en: '| `net share` | Displays the current shared folders, which may not provide
    sufficient access controls for the data shared within the folders, and the paths
    that they point to. |'
  prefs: []
  type: TYPE_TB
- en: Using the WMIC scripting language
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'On newer systems, attackers and penetration testers take advantage of built-in
    scripting languages, for example, **Windows Management Instrumentation Command-line**
    (**WMIC**), a command-line and scripting interface that is used to simplify access
    to Windows Instrumentation. If the compromised system supports WMIC, several commands
    can be used to gather information. Refer to the following table:'
  prefs: []
  type: TYPE_NORMAL
- en: '| Command | Description |'
  prefs: []
  type: TYPE_TB
- en: '| --- | --- |'
  prefs: []
  type: TYPE_TB
- en: '| `wmic nicconfig get ipaddress,macaddress` | Obtains the IP address and MAC
    address |'
  prefs: []
  type: TYPE_TB
- en: '| `wmic computersystem get username` | Verifies the account that was compromised
    |'
  prefs: []
  type: TYPE_TB
- en: '| `wmic netlogin get name, lastlogon` | Determines who used this system last
    and when they last logged on |'
  prefs: []
  type: TYPE_TB
- en: '| `wmic desktop get screensaversecure, screensavertimeout` | Determines whether
    the screensavers are password protected and what the timeout is |'
  prefs: []
  type: TYPE_TB
- en: '| `wmic logon get authenticationpackage` | Determines which logon methods are
    supported |'
  prefs: []
  type: TYPE_TB
- en: '| `wmic process get caption, executablepath, commandline` | Identifies system
    processes |'
  prefs: []
  type: TYPE_TB
- en: '| `wmic process where name="process_name" call terminate` | Terminates specific
    processes |'
  prefs: []
  type: TYPE_TB
- en: '| `wmic os get name, servicepackmajorversion` | Determines the system''s operating
    system |'
  prefs: []
  type: TYPE_TB
- en: '| `wmic product get name, version` | Identifies installed software |'
  prefs: []
  type: TYPE_TB
- en: '| `wmic product where name="name'' call uninstall /nointeractive` | Uninstalls
    or removes defined software packages |'
  prefs: []
  type: TYPE_TB
- en: '| `wmic share get /ALL` | Identifies the shares accessible by the user |'
  prefs: []
  type: TYPE_TB
- en: '| `wmic /node:"machinename" path Win32_TerminalServiceSetting where AllowTSConnections="0"
    call SetAllowTSConnections "1"` | Starts RDP remotely |'
  prefs: []
  type: TYPE_TB
- en: '| `wmic nteventlog get path, filename, writeable` | Finds all of the system
    event logs and ensures that they can be modified (used when it is time to cover
    your tracks) |'
  prefs: []
  type: TYPE_TB
- en: PowerShell is a scripting language built on the .NET Framework that runs from
    a console, giving the user access to the Windows filesystem and objects such as
    the registry. It is installed by default on the Windows 7 operating system and
    higher versions. PowerShell extends the scripting support and automation offered
    by WMIC by permitting the use of shell integration and interoperability on both
    local and remote targets.
  prefs: []
  type: TYPE_NORMAL
- en: PowerShell gives testers access to a shell and scripting language on a compromised
    system. Since it is native to the Windows operating system, its use of the commands
    does not trigger the antivirus software. When scripts are run on a remote system,
    PowerShell does not write to the disk, bypassing the antivirus and whitelisting
    the controls (assuming that the user has permitted the use of PowerShell).
  prefs: []
  type: TYPE_NORMAL
- en: 'PowerShell supports a number of built-in functions that are referred to as
    cmdlets. One of the advantages of PowerShell is that cmdlets are aliased to common
    Unix commands, so entering the `ls` command will return a typical directory listing,
    as shown in the following screenshot:'
  prefs: []
  type: TYPE_NORMAL
- en: '![Using the WMIC scripting language](img/3121OS_05_02.jpg)'
  prefs: []
  type: TYPE_IMG
- en: 'PowerShell is a rich language capable of supporting very complex operations;
    it is recommended that the user spend the time to become familiar with its use.
    Some of the simpler commands that can be used immediately following a compromise
    are described in the following table:'
  prefs: []
  type: TYPE_NORMAL
- en: '| Command | Description |'
  prefs: []
  type: TYPE_TB
- en: '| --- | --- |'
  prefs: []
  type: TYPE_TB
- en: '| `Get-Host &#124; Select Version` | Identifies the version of PowerShell used
    by the victim''s system. Some cmdlets are added or invoked in different versions.
    |'
  prefs: []
  type: TYPE_TB
- en: '| `Get-Hotfix` | Identifies the installed security patches and system hotfixes.
    |'
  prefs: []
  type: TYPE_TB
- en: '| `Get-Acl` | Identifies the group names and usernames. |'
  prefs: []
  type: TYPE_TB
- en: '| `Get-Process, Get-Service` | Lists the current processes and services. |'
  prefs: []
  type: TYPE_TB
- en: '| `gwmi win32_useraccount` | Invokes WMI to list the user accounts. |'
  prefs: []
  type: TYPE_TB
- en: '| `Gwmi_win32_group` | Invokes WMI to list the SIDs, names, and domain groups.
    |'
  prefs: []
  type: TYPE_TB
- en: Penetration testers can use Windows native commands, DLLs, .NET functions, WMI
    calls, and PowerShell cmdlets together to create PowerShell scripts with the extension
    `.ps1`.
  prefs: []
  type: TYPE_NORMAL
- en: Tip
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: During a recent penetration test, we were prohibited from installing any executable
    software on the client's systems. We used a PowerShell keylogger on a compromised
    system to grab administrator-level credentials and then compromised most of the
    systems on the network. The most effective exploit and post-exploit scripts, including
    the keylogger, are part of Nikhil Mittal's `Nishang` package ([https://code.google.com/p/nishang/downloads/detail?name=nishang_0.3.0.zip](https://code.google.com/p/nishang/downloads/detail?name=nishang_0.3.0.zip)).
  prefs: []
  type: TYPE_NORMAL
- en: 'Reconnaissance should also extend to the local network. Since you are working
    "blind," you will need to create a map of live systems and subnets that the compromised
    host can communicate with. Start by entering `IFCONFIG` (Unix-based systems) or
    `IPCONFIG /ALL` (Windows systems) in the shell prompt. This will allow an attacker
    to determine the following:'
  prefs: []
  type: TYPE_NORMAL
- en: Whether DHCP addressing is enabled.
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: The local IP address, which will also identify at least one active subnet.
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: The gateway IP address and DNS server address. System administrators usually
    follow a numbering convention across the network, and if an attacker knows one
    address, such as a gateway server `172.16.21.5`, they will ping addresses such
    as `172.16.20.5`, `172.16.22.5`, and so on to find additional subnets.
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: The domain name used to leverage **Active Directory** accounts.
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: If the attacking system and the target system are using Windows, the `net view`
    command can be used to enumerate other Windows systems on the network. Attackers
    use the `netstat -rn` command to review the routing table, which may contain static
    routes to networks or systems of interest.
  prefs: []
  type: TYPE_NORMAL
- en: The local network can be scanned using `nmap` to sniff for ARP broadcasts. In
    addition, Kali has several tools that can be used for an SNMP endpoint analysis,
    including `nmap`, `onesixtyone`, and `snmpcheck`.
  prefs: []
  type: TYPE_NORMAL
- en: 'Deploying a packet sniffer to map traffic will help you identify hostnames,
    active subnets, and domain names. If DHCP addressing is not enabled, it will also
    allow attackers to identify any unused, static IP addresses. Kali is preconfigured
    with Wireshark (a GUI-based packet sniffer) but you can also use `tshark` in a
    post-exploitation script or from the command line, as shown in the following screenshot:'
  prefs: []
  type: TYPE_NORMAL
- en: '![Using the WMIC scripting language](img/3121OS_05_03.jpg)'
  prefs: []
  type: TYPE_IMG
- en: Finding and taking sensitive data – pillaging the target
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: The term **pillaging** (sometimes known as **pilfering**) is a holdover from
    the days when hackers who had successfully compromised a system saw themselves
    as pirates racing to their target to steal or damage as much data as possible.
    The terms have survived as a reference to the much more careful practice of stealing
    or modifying proprietary or financial data when the objective of the exploit has
    been achieved.
  prefs: []
  type: TYPE_NORMAL
- en: 'The attacker can then focus on the secondary target—system files that will
    provide information to support additional attacks. The choice of the secondary
    files will depend on the operating system of the target. For example, if the compromised
    system is Unix, then the attacker will also target the following:'
  prefs: []
  type: TYPE_NORMAL
- en: The system and configuration files (usually in the `/etc` directory, but depending
    on the implementation, they may be in `/usr/local/etc` or other locations)
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: The password files (`/etc/password` and `/etc/shadow`)
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: The configuration files and public/private keys in the `.ssh` directory
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: The public and private key rings that may be contained in the `.gnupg` directory
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: The e-mail and data files
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: 'In a Windows system, the attacker will target the following:'
  prefs: []
  type: TYPE_NORMAL
- en: The system memory, which can be used to extract passwords, encryption keys,
    and so on
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: The system registry files
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: The **Security Accounts Manager** (**SAM**) database that contains hashed versions
    of the password, or alternative versions of the SAM database which may be found
    in `%SYSTEMROOT%\repair\SAM` and `%SYSTEMROOT%\System32\config\RegBack\SAM`
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Any other password or seed files used for encryption
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: The e-mail and data files
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Tip
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: Don't forget to review folders that contain temporary items, such as attachments.
    For example, `UserProfile\AppData\Local\Microsoft\Windows\Temporary Internet Files\`
    may contain files, images, and cookies that may be of interest.
  prefs: []
  type: TYPE_NORMAL
- en: 'As stated, the system memory contains a significant amount of information for
    any attacker. Therefore, it is usually a priority file that you need to obtain.
    The system memory can be downloaded as a single image file from several sources
    as follows:'
  prefs: []
  type: TYPE_NORMAL
- en: By uploading a tool to the compromised system and then directly copying the
    memory (the tools include **Belkasoft RAM capturer**, **MandiantMemoryze**, and
    **MonsolsDumpIt**).
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: By copying Windows hibernation file, `hiberfil.sys` and then using Volatility
    to decrypt and analyze the file. Volatility, found on Kali in the `Forensics`
    menu, is a framework that was written to analyze memory dumps from the system
    RAM and other files containing system memory. It relies on plugins written in
    Python to analyze the memory and extract data, such as encryption keys, passwords,
    registry information, processes, and connectivity information.
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: By copying a virtual machine and converting the VMEM file to a memory file.
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Tip
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: If you upload a program designed to capture memory onto a compromised system,
    it is possible that this particular application will be identified as malicious
    software by an antivirus software. Most antivirus software applications recognize
    the hash signature and behavior of memory acquisition software, and act to protect
    the sensitive contents of the physical memory by raising an alarm if it is at
    risk of disclosure. The acquisition software will be quarantined, and the target
    will receive a warning alerting them of the attack.
  prefs: []
  type: TYPE_NORMAL
- en: 'To avoid this, use Metasploit Framework to run the executable completely in
    the target''s memory using the following command:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE35]'
  prefs: []
  type: TYPE_PRE
- en: The previous command executes `calc.exe` as a dummy executable but uploads the
    memory acquisition executable to run in its process space instead.
  prefs: []
  type: TYPE_NORMAL
- en: The executable doesn't show up in process lists, such as Task Manager, and detection
    using data forensic techniques is much harder because it's not written to disk.
    Furthermore, it will avoid the system's antivirus software, which generally does
    not scan the memory space in search of malware.
  prefs: []
  type: TYPE_NORMAL
- en: 'Once the physical memory has been downloaded, it can be analyzed using Volatility
    Framework, a collection of Python scripts designed to forensically analyze memory.
    If the operating system is supported, Volatility will scan the memory file and
    extract the following:'
  prefs: []
  type: TYPE_NORMAL
- en: The image information and system data sufficient to *tie* the image to its source
    system.
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: The running processes, loaded DLLs, threads, sockets, connections, and modules.
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: The open network sockets and connections, and recently opened network connections.
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: The memory address, including physical and virtual memory mapping.
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: 'The LM/NTLM hashes and LSA secrets. **LanMan** (**LM**) password hashes are
    Microsoft''s original attempt at protecting passwords. Over the years, it has
    become simple to break them and convert the hashes back into an actual password.
    **NT LanMan** (**NTLM**) hashes are more recent and resilient to attack. However,
    they are usually stored with the NTLM versions for the purpose of backward compatibility.
    **Local Security Authority** (**LSA**) stores "secrets" that are local passwords:
    remote access (wired or wireless), VPN, autologon passwords, and so on. Any passwords
    stored on the system are vulnerable, especially if the user reuses passwords.'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Specific regular expressions or strings stored in memory.
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Using the sample image for a system infected with Zeus malware ([https://code.google.com/p/volatility/wiki/SampleMemoryImages](https://code.google.com/p/volatility/wiki/SampleMemoryImages)),
    we'll use Volatility Framework to extract the encrypted LanMan password hashes.
  prefs: []
  type: TYPE_NORMAL
- en: 'The first step is to determine the type of image and the operating system using
    the following command:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE36]'
  prefs: []
  type: TYPE_PRE
- en: 'The execution of the previous command is shown in the following screenshot:'
  prefs: []
  type: TYPE_NORMAL
- en: '![Finding and taking sensitive data – pillaging the target](img/3121OS_05_04.jpg)'
  prefs: []
  type: TYPE_IMG
- en: 'The **hivelist** plugin will print out the initial virtual memory location
    for the various registry hives when it is called using the following command:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE37]'
  prefs: []
  type: TYPE_PRE
- en: 'The execution of the previous command is shown in the following screenshot:'
  prefs: []
  type: TYPE_NORMAL
- en: '![Finding and taking sensitive data – pillaging the target](img/3121OS_05_05.jpg)'
  prefs: []
  type: TYPE_IMG
- en: 'In order to dump the hashes, the initial virtual memory locations of both the
    SAM and SYSTEM hives are required. Using the following command the results are
    piped to a comma-delimited file to be directly imported by a password-cracking
    application:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE38]'
  prefs: []
  type: TYPE_PRE
- en: 'The execution of the previous command is shown in the following screenshot:'
  prefs: []
  type: TYPE_NORMAL
- en: '![Finding and taking sensitive data – pillaging the target](img/3121OS_05_06.jpg)'
  prefs: []
  type: TYPE_IMG
- en: The isolated LM hashes can be cracked using Hashcat, John the Ripper, Ophcrack,
    and Rainbow Tables.
  prefs: []
  type: TYPE_NORMAL
- en: Creating additional accounts
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: 'The following commands are highly invasive and are usually detected by the
    system owner during the incident response process. However, they are frequently
    planted by an attacker to draw attention away from more persistent access mechanisms.
    Refer to the following table:'
  prefs: []
  type: TYPE_NORMAL
- en: '| Command | Description |'
  prefs: []
  type: TYPE_TB
- en: '| --- | --- |'
  prefs: []
  type: TYPE_TB
- en: '| `net user attacker password /add` | Creates a new local account with a user
    called `attacker` with the password as `password`. |'
  prefs: []
  type: TYPE_TB
- en: '| `net localgroup administrators attacker /add` | Adds the new user `attacker`
    to the local administrator''s group. In some cases, the command will be `net localgroup
    administrators /add attacker`. |'
  prefs: []
  type: TYPE_TB
- en: '| `net user username /active:yes /domain` | Changes an inactive or disabled
    account to active. In a small organization, this will attract attention. Large
    enterprises with poor password management can have 30 percent of their passwords
    flagged as "inactive," so it may be an effective way to gain an account. |'
  prefs: []
  type: TYPE_TB
- en: '| `net share name$=C:\ /grant:attacker,FULL /unlimited` | Shares `C:` (or another
    specified drive) as a Windows share, and grants the user (attacker) full rights
    to access or modify all of the content on that drive. |'
  prefs: []
  type: TYPE_TB
- en: 'If you create a new user account, it will be noticed when anyone logs onto
    the welcome screen of the compromised system. To make the account invisible, you
    need to modify the registry from the command line using the following `REG` command:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE39]'
  prefs: []
  type: TYPE_PRE
- en: This will modify the designated registry key to hide the account of the user
    (`/V`). Again, there may be special syntax requirements based on the specific
    version of the target's operating system, so determine the Windows version first
    and then validate it in a controlled test environment before implementing it against
    the target.
  prefs: []
  type: TYPE_NORMAL
- en: Using Metasploit for post-exploit activities
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: Metasploit was developed to support both exploit and post-exploit activities.
    The present version contains approximately 200 modules that simplify post-exploit
    activities. We will review some of the most important modules.
  prefs: []
  type: TYPE_NORMAL
- en: In the following screenshots, we have successfully exploited a Windows XP system
    (a "classic" attack that is frequently used to validate more complex aspects of
    `meterpreter`). The initial step is to conduct an immediate reconnaissance of
    the network and the compromised system.
  prefs: []
  type: TYPE_NORMAL
- en: The initial `meterpreter` shell is fragile and vulnerable to failure over an
    extended period of time. Therefore, once a system is exploited, we will migrate
    the shell and bind it with a more stable process. This also makes detecting the
    exploit more difficult.
  prefs: []
  type: TYPE_NORMAL
- en: 'At the `meterpreter` prompt, enter `ps` to obtain a list of running processes,
    as shown in the following screenshot:'
  prefs: []
  type: TYPE_NORMAL
- en: '![Using Metasploit for post-exploit activities](img/3121OS_05_07.jpg)'
  prefs: []
  type: TYPE_IMG
- en: The `ps` command also returns the full pathname for each process. This was omitted
    from the previous screenshot. The `ps` list identifies that `c:\windows\Explorer.EXE`
    is running. In this particular case, it is identified with the process ID of `1460`,
    as shown in the following screenshot. As this is a generally stable application,
    we will migrate the shell to that process.
  prefs: []
  type: TYPE_NORMAL
- en: '![Using Metasploit for post-exploit activities](img/3121OS_05_08.jpg)'
  prefs: []
  type: TYPE_IMG
- en: Now that we have a stable shell connection to the remote system, we will use
    the `meterpreter` scripts that support post-exploitation activities.
  prefs: []
  type: TYPE_NORMAL
- en: 'One of the first parameters to identify is: are we on a virtual machine? With
    the `meterpreter` session open between the compromised system and the attacker,
    the command `run checkvm` is issued, as shown in the following screenshot. The
    returned data indicates that `This is a VMware Virtual Machine`.'
  prefs: []
  type: TYPE_NORMAL
- en: '![Using Metasploit for post-exploit activities](img/3121OS_05_09.jpg)'
  prefs: []
  type: TYPE_IMG
- en: 'Some of the most important post-exploit modules available through `meterpreter`
    are described in the following table:'
  prefs: []
  type: TYPE_NORMAL
- en: '| Command | Description |'
  prefs: []
  type: TYPE_TB
- en: '| --- | --- |'
  prefs: []
  type: TYPE_TB
- en: '| `run checkvm` | Determines if a virtual machine is present. |'
  prefs: []
  type: TYPE_TB
- en: '| `run getcountermeasure` | Checks the security configuration on the exploited
    system (antivirus, firewalls, and so on). |'
  prefs: []
  type: TYPE_TB
- en: '| `run killav` | Disables most of the antivirus services running on the compromised
    system. This script is frequently out of date, and success should be manually
    verified. |'
  prefs: []
  type: TYPE_TB
- en: '| `run hostsedit` | Allows the attacker to add entries to the Windows `HOSTS`
    file. This can divert traffic to a different site (a fake site), which will download
    additional tools or ensure that the antivirus software cannot connect to the Internet
    or a local server to obtain signature updates. |'
  prefs: []
  type: TYPE_TB
- en: '| `run winenum` | Performs a command-line and WMIC characterization of the
    exploited system. It dumps the important keys from the registry and LM hashes.
    |'
  prefs: []
  type: TYPE_TB
- en: '| `run scraper` | Gathers comprehensive information that has not been gathered
    by other scripts, such as the entire Window registry. |'
  prefs: []
  type: TYPE_TB
- en: '| `run upload` and `run download` | Allows the attacker to upload and download
    files on the target system. |'
  prefs: []
  type: TYPE_TB
- en: '| `run keyscan_start`, `run keyscan_stop`, and `run keyscan_dump` | Starts
    and stops a local keylogger on the exploited system. When the data collection
    is complete, the collected text data is dumped on the attacker''s system. |'
  prefs: []
  type: TYPE_TB
- en: '| `run getprivs` | Attempts to enable all of the privileges available to the
    current process. It''s very useful for privilege escalation. |'
  prefs: []
  type: TYPE_TB
- en: '| `run getsystem` | Attempts to elevate privileges to the Windows `SYSTEM`
    level; grants the fullest possible escalation of a user''s privileges. |'
  prefs: []
  type: TYPE_TB
- en: '| `Run hashdump` | Dumps the contents of the SAM database on the attacker''s
    system. |'
  prefs: []
  type: TYPE_TB
- en: '| `run getgui` | Allows the user to enable RDP (`getgui -e`) and set the username
    and password (`getgui -u`). The `gettelnet` script can be run in the same manner.
    |'
  prefs: []
  type: TYPE_TB
- en: '| `run vnc` | Gives the attacker a remote GUI (VNC) to the compromised system.
    |'
  prefs: []
  type: TYPE_TB
- en: 'One of the most effective `meterpreter` scripts is the **Windows enumerator**
    (**winenum**). As seen in the following screenshot, it uses both command-line
    and WMIC calls to fully characterize the target system:'
  prefs: []
  type: TYPE_NORMAL
- en: '![Using Metasploit for post-exploit activities](img/3121OS_05_10.jpg)'
  prefs: []
  type: TYPE_IMG
- en: 'In addition to the enumeration, the `winenum` script also dumps the registry
    and collects the system hashes for decryption as shown in the following screenshot:'
  prefs: []
  type: TYPE_NORMAL
- en: '![Using Metasploit for post-exploit activities](img/3121OS_05_11.jpg)'
  prefs: []
  type: TYPE_IMG
- en: 'The `meterpreter` comes with several useful libraries that support complex
    functions. For example, the `espia` library supports screenshots of the compromised
    system via the following commands:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE40]'
  prefs: []
  type: TYPE_PRE
- en: The `stdapi` library allows a remote attacker to manipulate a webcam by collecting
    audio and video from the compromised system and relaying that data back to the
    attacker.
  prefs: []
  type: TYPE_NORMAL
- en: Escalating user privileges on a compromised host
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: It is usually possible to get `Guest` or `User` access to a system. Frequently,
    the attacker's ability to access important information will be limited by such
    reduced privilege levels. Therefore, a common post-exploit activity is to escalate
    access privileges from `Guest` to `User` to `Administrator` and, finally, to `SYSTEM`.
    This upward progression of gaining access privileges is usually referred to as
    **vertical escalation**.
  prefs: []
  type: TYPE_NORMAL
- en: 'The user can implement several methods to gain advanced access credentials,
    including the following:'
  prefs: []
  type: TYPE_NORMAL
- en: Employ a network sniffer and/or keylogger to capture transmitted user credentials
    (`dsniff` is designed to extract passwords from live transmissions or a `pcap`
    file saved from a Wireshark or tshark session).
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Perform a search for locally stored passwords. Some users collect passwords
    in an e-mail folder (frequently called `passwords`). Since password reuse and
    simple password construction systems are common, the passwords that are found
    can be employed during the escalation process.
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: NirSoft ([www.nirsoft.net](http://www.nirsoft.net)) produces several free tools
    that can be uploaded to the compromised system using `meterpreter` to extract
    passwords from the operating system and applications that cache passwords (mail,
    remote access software, FTP, and web browsers).
  prefs: []
  type: TYPE_NORMAL
- en: Dump the `SAM` and `SYSKEY` files using `meterpreter` or applications such as
    **hobocopy**, **fgdump**, and **pwdump** (these can be uploaded on the target
    using `meterpreter`).
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Inject malicious code directly into a service running at the `SYSTEM` level
    using a tool such as process injector ([www.tarasco.org/security/Process_Injector/](http://www.tarasco.org/security/Process_Injector/)).
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: When some applications load, they read **dynamic link library** (**DLL**) files
    in a particular order. It is possible to create a fake DLL with the same name
    as a legitimate DLL, place it in a specific directory location, and have the application
    load and execute it, resulting in elevated privileges for the attacker. Several
    applications are known to be vulnerable to such DLL hijacking ([www.exploit-db.com/dll-hijacking-vulnerable-applications/](http://www.exploit-db.com/dll-hijacking-vulnerable-applications/)).
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Apply an exploit that uses a buffer overflow or other means to escalate privileges.
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Execute the `getsystem` script, which will automatically escalate administrator
    privileges to the `SYSTEM` level, from the `meterpreter` prompt.
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Tip
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: Windows 7 and 2008 don't allow remote access to administrative shares, such
    as `ADMIN$`, `C$`, and so on, from untrusted systems. These shares may be required
    for `meterpreter` scripts, such as incognito, or to support attacks over SMB.
    To address this issue, add `HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System`
    to the registry, and add a new DWORD (32-bit) key named `LocalAccountTokenFilterPolicy`
    and set the value to `1`.
  prefs: []
  type: TYPE_NORMAL
- en: Replaying authentication tokens using incognito
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: One particularly interesting `meterpreter` library is `incognito`, which allows
    you to impersonate and replay user tokens. Tokens are temporary keys that allow
    you to access network and system resources without needing to provide your password
    or other credentials with each particular access. These tokens persist on a system
    until it is rebooted.
  prefs: []
  type: TYPE_NORMAL
- en: Once you have compromised a system, you can use tokens to impersonate a previous
    user who created tokens, without the need to crack the user's password. This token
    impersonation may allow an attacker to escalate their privileges.
  prefs: []
  type: TYPE_NORMAL
- en: 'At the prompt, type the following:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE41]'
  prefs: []
  type: TYPE_PRE
- en: 'The execution of the previous command is shown in the following screenshot:'
  prefs: []
  type: TYPE_NORMAL
- en: '![Replaying authentication tokens using incognito](img/3121OS_05_12.jpg)'
  prefs: []
  type: TYPE_IMG
- en: The first step is to identify all of the valid tokens that are present on the
    compromised system. The number of tokens that you can see will depend on the level
    of access that was initially used to compromise the target system.
  prefs: []
  type: TYPE_NORMAL
- en: You will also see that there are two types of tokens, as shown in the following
    screenshot. Delegation tokens support interactive logons (for example, logging
    onto a system locally or via a remote desktop). Impersonate tokens are for noninteractive
    sessions, such as for when a system connects to a network drive.
  prefs: []
  type: TYPE_NORMAL
- en: '![Replaying authentication tokens using incognito](img/3121OS_05_13.jpg)'
  prefs: []
  type: TYPE_IMG
- en: As you can see, a delegation token has been identified as an `Administrator`.
    If we can impersonate this token, we can assume its privileges.
  prefs: []
  type: TYPE_NORMAL
- en: 'When invoking the `impersonate_token` command in `incognito` (as shown in the
    following screenshot), note that two backslashes are required in the command:'
  prefs: []
  type: TYPE_NORMAL
- en: '![Replaying authentication tokens using incognito](img/3121OS_05_14.jpg)'
  prefs: []
  type: TYPE_IMG
- en: Now, if we run the shell command from the `meterpreter` prompt and enter `whoami`,
    it will identify us as the administrator whose token we impersonated.
  prefs: []
  type: TYPE_NORMAL
- en: Manipulating access credentials with Windows Credential Editor
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'The **Windows Credential Editor** (**WCE**)—[http://www.ampliasecurity.com/research/wcefaq.html](http://www.ampliasecurity.com/research/wcefaq.html)—is
    a refined version of the incognito script. It is available in 32-bit and 64-bit
    versions as well as a "universal" version that is claimed to be workable on all
    Windows platforms. WCE allows users to do the following:'
  prefs: []
  type: TYPE_NORMAL
- en: Perform pass-the-hash attacks on Windows systems
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Collect NTLM credentials from the system memory (with or without code injection)
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Collect Kerberos tickets from Windows systems
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Use the collected Kerberos tickets on other Windows or Unix systems to gain
    access
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Dump cleartext passwords stored by Windows systems (see the following section)
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: 'To use WCE, upload the executable to the compromised system from the `meterpreter`
    prompt. Then, initiate an interactive shell and execute WCE. As you can see in
    the following screenshot, the `-w` option readily extracted the cleartext `Administrator`
    password:'
  prefs: []
  type: TYPE_NORMAL
- en: '![Manipulating access credentials with Windows Credential Editor](img/3121OS_05_15.jpg)'
  prefs: []
  type: TYPE_IMG
- en: Escalating from Administrator to SYSTEM
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: Administrator privileges allow an attacker to create and manage accounts and
    access most data available on a system. However, some complex functionality mandates
    that the requester have `SYSTEM` level access privileges. There are several ways
    to continue this escalation to the `SYSTEM` level. The most common is to use the
    `at` command, which is used by Windows to schedule tasks for a particular time.
    The `at` command always runs with privileges at the `SYSTEM` level.
  prefs: []
  type: TYPE_NORMAL
- en: 'Using an interactive shell (enter `shell` at the `meterpreter` prompt), open
    a command prompt and determine the compromised system''s local time. If the time
    is 12:50 P.M. (the `at` function uses a 24-hour notation), schedule an interactive
    command shell for a later time, as shown in the following screenshot:'
  prefs: []
  type: TYPE_NORMAL
- en: '![Escalating from Administrator to SYSTEM](img/3121OS_05_16.jpg)'
  prefs: []
  type: TYPE_IMG
- en: 'After the `at` task was scheduled to run, reconfirm your access privileges
    at the `meterpreter` prompt, as shown in the following screenshot:'
  prefs: []
  type: TYPE_NORMAL
- en: '![Escalating from Administrator to SYSTEM](img/3121OS_05_17.jpg)'
  prefs: []
  type: TYPE_IMG
- en: As you can see, the privileges have been escalated to the `SYSTEM` level.
  prefs: []
  type: TYPE_NORMAL
- en: Accessing new accounts with horizontal escalation
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: In horizontal escalation, the attacker retains their existing credentials but
    uses them to act on a different user's account. For example, a user on compromised
    system A attacks a user on system B in an attempt to compromise them.
  prefs: []
  type: TYPE_NORMAL
- en: We will use horizontal escalation attacks when we review some attack vectors,
    such as remote access attacks.
  prefs: []
  type: TYPE_NORMAL
- en: Covering your tracks
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: Once a system has been exploited, the attacker must cover their tracks to avoid
    detection, or at least make the reconstruction of the event more difficult for
    the defender.
  prefs: []
  type: TYPE_NORMAL
- en: 'An attacker may completely delete the Windows event logs (if they are being
    actively retained on the compromised server). This can be done via a command shell
    to the system and using the following command:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE42]'
  prefs: []
  type: TYPE_PRE
- en: The command directs for all of the logs to be deleted (`/a`), including the
    files from all of the subfolders (`/s`). The `/q` option disables all of the queries,
    asking for a *yes* or *no* response, and the `/f` option forcibly removes the
    files, making recovery more difficult.
  prefs: []
  type: TYPE_NORMAL
- en: This can also be done from the `meterpreter` prompt by issuing the command `clearev`.
    This will clear the application, system, and security logs from the target (there
    are no options or arguments for this command).
  prefs: []
  type: TYPE_NORMAL
- en: Ordinarily, deleting a system log does not trigger any alerts to the user. In
    fact, most organizations configure logging so haphazardly that missing system
    logs are treated as a possible occurrence, and their loss is not deeply investigated.
  prefs: []
  type: TYPE_NORMAL
- en: 'Metasploit has an additional trick up its sleeve—the `timestomp` option allows
    an attacker to make changes to the MACE parameters of a file (the last modified,
    Accessed, Created, and MFT Entry modified times of a file). Once a system has
    been compromised and a `meterpreter` shell established, `timestomp` can be invoked,
    as shown in the following screenshot:'
  prefs: []
  type: TYPE_NORMAL
- en: '![Covering your tracks](img/3121OS_05_18.jpg)'
  prefs: []
  type: TYPE_IMG
- en: 'For example, `C:` of the compromised system contains a file named `README.txt`.
    The MACE values for this file indicate that it was created recently, as shown
    in the following screenshot:'
  prefs: []
  type: TYPE_NORMAL
- en: '![Covering your tracks](img/3121OS_05_19.jpg)'
  prefs: []
  type: TYPE_IMG
- en: 'If we want to hide this file, we may move it to a cluttered directory, such
    as `windows\system32`. However, the file would be obvious to anyone who sorted
    the contents of that directory on the basis of the creation dates or another MAC-based
    variable. Therefore, to copy the MAC information from the `cmd.exe` file to the
    `README.txt` file, use the following command:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE43]'
  prefs: []
  type: TYPE_PRE
- en: We can also choose to blank out the MAC data using the `-b` switch. As you can
    see in the following screenshot, we have chosen to change the MAC data to a time
    in the future (the year `2106`).
  prefs: []
  type: TYPE_NORMAL
- en: '![Covering your tracks](img/3121OS_05_20.jpg)'
  prefs: []
  type: TYPE_IMG
- en: 'Such a change will attract the attention of an investigator, but they will
    not be able to use the data for a forensic analysis. What do the attributes look
    like from the original Windows platform? If the system administrator calls the
    system properties of a file, the creation and modification dates have been changed
    back to the year 1601 (the date used by Microsoft as the initial system start
    time). In contrast, the last accessed time for the file remains accurate. You
    can see this in the following screenshot:'
  prefs: []
  type: TYPE_NORMAL
- en: '![Covering your tracks](img/3121OS_05_21.jpg)'
  prefs: []
  type: TYPE_IMG
- en: 'Although this is expected behavior, it still provides clues to an investigator.
    In order to completely foul up an investigation, an attacker may recursively change
    all of the set times in a directory or on a particular drive using the following
    command:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE44]'
  prefs: []
  type: TYPE_PRE
- en: The solution is not perfect. It is very obvious that an attack has occurred.
    Furthermore, it is possible for timestamps to be retained in other locations on
    a hard drive and be accessible for investigation. If the target system is actively
    monitoring changes to system integrity using an intrusion detection system, such
    as Tripwire, alerts of the `timestomp` activity will be generated. Therefore,
    destroying timestamps is of limited value when a stealthy approach is truly required.
  prefs: []
  type: TYPE_NORMAL
- en: Summary
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: In this chapter, we focused on the immediate actions that follow exploitation
    of a target system. We reviewed the initial rapid assessment conducted to characterize
    the server and the local environment. We also learned how to identify and locate
    target files of interest, create user accounts, perform vertical escalation to
    improve access privileges, and remove signs of an intrusion.
  prefs: []
  type: TYPE_NORMAL
- en: In the next chapter, we will learn how to implement a persistent backdoor to
    retain access, and we will learn techniques to support covert communications with
    the compromised system.
  prefs: []
  type: TYPE_NORMAL
- en: Chapter 6. Post Exploit – Persistence
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: The final stage of the attacker's kill chain is the "command, control, and communicate"
    phase, where the attacker relies on a persistent connection with the compromised
    system to ensure that they can continue to maintain their control.
  prefs: []
  type: TYPE_NORMAL
- en: 'To be effective, the attacker must be able to maintain **interactive persistence**—they
    must have a two-way communication channel with the exploited system (interactive)
    that remains on the compromised system for a long period of time without being
    discovered (persistence). This type of connectivity is a requirement because of
    the following reasons:'
  prefs: []
  type: TYPE_NORMAL
- en: Network intrusions may be detected, and the compromised systems may be identified
    and patched
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Some exploits only work once because the vulnerability is intermittent, exploitation
    causes the system to fail, or because exploit forces the system to change, rendering
    the vulnerability unusable
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Attackers may need to return multiple times to the same target for various reasons
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: The target's usefulness is not always immediately known at the time it is compromised
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: The tool used to maintain interactive persistence is usually referred to by
    classical terms such as **backdoor** or **rootkit**. However, the trend towards
    long-term persistence by both automated malware and human attacks has blurred
    the meaning of traditional labels; so instead, we will refer to malicious software
    that is intended to stay on the compromised system for a long period of time as
    **persistent agents**.
  prefs: []
  type: TYPE_NORMAL
- en: 'These persistent agents perform many functions for attackers and penetration
    testers, including the following:'
  prefs: []
  type: TYPE_NORMAL
- en: Allow additional tools to be uploaded to support new attacks, especially against
    systems located on the same network.
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Facilitate the exfiltration of data from compromised systems and networks.
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Allow attackers to reconnect to a compromised system, usually via an encrypted
    channel to avoid detection. Persistent agents have been known to remain on systems
    for more than a year.
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Employ antiforensic techniques to avoid being detected, including hiding in
    the target's filesystem or system memory, using strong authentication, and using
    encryption.
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: 'In this chapter you will learn about the following:'
  prefs: []
  type: TYPE_NORMAL
- en: Compromising existing system and application files for remote access
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Creating persistent agents
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Maintaining persistence with the Metasploit Framework
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Redirecting ports to bypass network controls
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Compromising the existing system and application files for remote access
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: The best persistent agent is one that does not need to be hidden because it
    is part of the existing file structure of the compromised system; the attacker
    only has to add certain functionality to convert regular system files and applications
    into persistent agents. This approach can almost never be detected by security
    controls such as intrusion detection systems.
  prefs: []
  type: TYPE_NORMAL
- en: Remotely enabling the Telnet service
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: One technique used to maintain remote access is to use the Metasploit Framework
    to enable the Telnet service on a Windows platform and use it to provide persistence.
  prefs: []
  type: TYPE_NORMAL
- en: The first step is to compromise the target system to obtain a meterpreter session
    (migrate the session to ensure a stable shell) and then elevate access privileges.
  prefs: []
  type: TYPE_NORMAL
- en: 'Next, obtain a local command shell to access the target system using the following
    command:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE45]'
  prefs: []
  type: TYPE_PRE
- en: When executed, this command creates an interactive command shell (`-i`) that
    acts as a hidden process (`-H`).
  prefs: []
  type: TYPE_NORMAL
- en: 'Using the command prompt of the shell, create a new user account. When creating
    user accounts to ensure persistence, many attackers use the following two-part
    strategy:'
  prefs: []
  type: TYPE_NORMAL
- en: Create an account with a name that will attract attention if the compromise
    is investigated (for example, Leet7737)
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: 'Create an account that appears to be part of normal system functions, such
    as `Service_Account`, using the following commands:'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '[PRE46]'
  prefs: []
  type: TYPE_PRE
- en: When the new user accounts have been created, exit the Windows command shell.
  prefs: []
  type: TYPE_NORMAL
- en: 'To enable Telnet, run the following command from the `meterpreter` prompt:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE47]'
  prefs: []
  type: TYPE_PRE
- en: 'The execution of the previous command is shown in the following screenshot:'
  prefs: []
  type: TYPE_NORMAL
- en: '![Remotely enabling the Telnet service](img/3121OS_06_01.jpg)'
  prefs: []
  type: TYPE_IMG
- en: 'The script shown in the previous screenshot creates a persistent Telnet service
    on the compromised system. To access it, connect to the system''s IP address using
    the Telnet protocol and provide the username and password that were used to create
    the account, as shown in the following screenshot:'
  prefs: []
  type: TYPE_NORMAL
- en: '![Remotely enabling the Telnet service](img/3121OS_06_02.jpg)'
  prefs: []
  type: TYPE_IMG
- en: 'The Telnet service will persist until it is removed. Unfortunately, there are
    some limitations to using Telnet: it is readily detectable (especially because
    credentials are transmitted in the clear) and it functions only in the command-line
    mode.'
  prefs: []
  type: TYPE_NORMAL
- en: However, what if you need to have a GUI to access certain applications on the
    compromised system?
  prefs: []
  type: TYPE_NORMAL
- en: Remotely enabling Windows Terminal Services
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: One of the most reliable techniques to ensure remote access is to persistently
    enable Windows Terminal Services, also known as the **Remote Desktop Protocol**
    (**RDP**). To do so, you must have administrator privileges and know the version
    of the target's operating system.
  prefs: []
  type: TYPE_NORMAL
- en: 'For example, if the target is Windows 7, use `meterpreter` to obtain an interactive
    command shell on the target, and then enter the following commands to change the
    registry:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE48]'
  prefs: []
  type: TYPE_PRE
- en: 'To ensure that RDP will pass through the client-side firewall, add a rule using
    the following command:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE49]'
  prefs: []
  type: TYPE_PRE
- en: 'Now we can start the RDP service using the following command:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE50]'
  prefs: []
  type: TYPE_PRE
- en: 'The change launch RDP is not yet persistent; use the following command to start
    RDP each time the computer is started:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE51]'
  prefs: []
  type: TYPE_PRE
- en: The process of enabling RDP is not too complex, but it is one that should be
    scripted to reduce the possibility of errors, especially when working with the
    system registry. Fortunately, the `meterpreter` framework uses the `GETGUI` script
    to automatically enable RDP services.
  prefs: []
  type: TYPE_NORMAL
- en: When run from the `meterpreter` prompt, the command line shown in the following
    screenshot creates the account's username and password, hides the account from
    the log-in screen, and makes the necessary changes to the registry to remain persistent.
    The following screenshot shows the command used to create a username that appears
    to be a legitimate account (Service Account) with a simple password.
  prefs: []
  type: TYPE_NORMAL
- en: '![Remotely enabling Windows Terminal Services](img/3121OS_06_03.jpg)'
  prefs: []
  type: TYPE_IMG
- en: To connect to the compromised remote desktop, use Kali's **rdesktop** program.
  prefs: []
  type: TYPE_NORMAL
- en: Remotely enabling Virtual Network Computing
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'If the system contains applications that are known to be compromised (especially
    remote-access programs), it may be possible to take advantage of the existing
    vulnerabilities to exploit the system. For example:'
  prefs: []
  type: TYPE_NORMAL
- en: It may be possible to extract remote-access passwords for some programs from
    the registry. VNC stores passwords in the registry, and these can be obtained
    by manually extracting the registry key or by uploading and executing an application
    such as NirSoft's VNCPassView.
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Different versions of VNC contain different vulnerabilities that can be exploited
    to compromise the application and gain remote access to the system. If the user
    has a current version installed, it may be possible to uninstall that version
    and install an older version in its place. Due to the similarity of functionality
    among the versions, the user may not notice the substitution, but an attacker
    can use the the authentication bypass exploits found in older VNC versions to
    maintain access in the post-compromise phase.
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Metasploit comes with the ability to introduce VNC directly to an exploited
    system using the VNCINJECT module.
  prefs: []
  type: TYPE_NORMAL
- en: 'In the following screenshot, VNC was selected as the payload instead of the
    regular `reverse_TCP` shell:'
  prefs: []
  type: TYPE_NORMAL
- en: '![Remotely enabling Virtual Network Computing](img/3121OS_06_04.jpg)'
  prefs: []
  type: TYPE_IMG
- en: This attack does not require any authentication. If you're testing a client
    site, ensure that all vulnerable applications are removed from the compromised
    system once the vulnerability has been proved—otherwise, you've created an access
    point that can be found and used by any other attacker!
  prefs: []
  type: TYPE_NORMAL
- en: Using persistent agents
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: Traditionally, attackers would place a backdoor on a compromised system—if the
    **front door** provided authorized access to legitimate users, the backdoor applications
    allowed attackers to return to an exploited system and access to services and
    data.
  prefs: []
  type: TYPE_NORMAL
- en: Unfortunately, the classical backdoors provided limited interactivity and were
    not designed to be persistent on the compromised systems for very long time frames.
    This was viewed as a significant shortcoming by the attacker community, because
    once the backdoor was discovered and removed, there was additional work required
    to repeat the compromise steps and exploit the system, which was made more difficult
    by the forewarned system administrators defending the network and its resources.
  prefs: []
  type: TYPE_NORMAL
- en: Kali now focuses on persistent agents that if properly employed, are more difficult
    to detect. The first tool we will review is the venerable Netcat.
  prefs: []
  type: TYPE_NORMAL
- en: Employing Netcat as a persistent agent
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: Netcat is an application that supports reading from and writing to network connections
    using "raw" TCP and UDP packets. Unlike packets that are organized by services
    such as Telnet or FTP, Netcat's packets are not accompanied by headers or other
    channel information specific to the service. This simplifies communications and
    allows for an almost-universal communication channel.
  prefs: []
  type: TYPE_NORMAL
- en: 'The last stable version of Netcat was released by Hobbit in 1996, and it has
    remained as useful as ever; in fact, it is frequently referred to as the **TCP/IP
    Swiss army knife**. Netcat can perform many functions, including the following:'
  prefs: []
  type: TYPE_NORMAL
- en: Port scanning
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Banner grabbing to identify services
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Port redirection and proxying
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: File transfer and chatting, including support for data forensics and remote
    backups
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Use as a backdoor or an interactive persistent agent, on a compromised system
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: At this point, we will focus on using Netcat to create a persistent shell on
    a compromised system. Although the following example uses Windows as the target
    platform, it functions the same when used on a Unix-based platform.
  prefs: []
  type: TYPE_NORMAL
- en: In the example shown in the following screenshot, we will retain the executable's
    name—`nc.exe`; however, it is common to rename it prior to use in order to minimize
    detection. Even if it is renamed, it will usually be identified by antivirus software;
    many attackers will alter or remove elements of Netcat's source code that are
    not required and recompile it prior to use; such changes can alter the specific
    signature that antivirus programs use to identify the application as Netcat, making
    it invisible to antivirus programs.
  prefs: []
  type: TYPE_NORMAL
- en: 'Netcat is stored on Kali in the `/usr/share/windows-binaries` repository. To
    upload it to a compromised system, enter the following command from within `meterpreter`:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE52]'
  prefs: []
  type: TYPE_PRE
- en: 'The execution of the previous command is shown in the following screenshot:'
  prefs: []
  type: TYPE_NORMAL
- en: '![Employing Netcat as a persistent agent](img/3121OS_06_05.jpg)'
  prefs: []
  type: TYPE_IMG
- en: You do not have to place it in the `system32` folder specifically; however,
    due to the number and diversity of filetypes in this folder, this is the best
    location to hide a file in a compromised system.
  prefs: []
  type: TYPE_NORMAL
- en: Tip
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: While conducting a penetration test on one client, we identified six separate
    instances of Netcat on one server. Netcat had been installed twice by two separate
    system administrators to support network management; the other four instances
    were installed by external attackers and were not identified until the penetration
    test. Therefore, always look to see whether or not a Netcat is already installed
    on your target!
  prefs: []
  type: TYPE_NORMAL
- en: If you do not have a `meterpreter` connection, you can use **Trivial File Transfer
    Protocol** (**TFTP**) to transfer the file.
  prefs: []
  type: TYPE_NORMAL
- en: 'Next, configure the registry to launch Netcat when the system starts up and
    ensure that it is listening on port 444 (or any other port that you have selected,
    as long as it is not in use) using the following command:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE53]'
  prefs: []
  type: TYPE_PRE
- en: 'Confirm that the change in the registry was successfully implemented using
    the following `queryval` command:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE54]'
  prefs: []
  type: TYPE_PRE
- en: Using the `netsh` command, open a port on the local firewall to ensure that
    the compromised system will accept remote connections to Netcat. It is important
    to know the target's operating system. The `netsh advfirewall firewall` command-line
    context is used for Windows Vista, and Windows Server 2008 and later versions;
    the `netsh firewall` command is used for earlier operating systems.
  prefs: []
  type: TYPE_NORMAL
- en: 'To add a port to the local Windows firewall, enter the `shell` command at the
    `meterpreter` prompt and then enter `rule` using the appropriate command. When
    naming the `rule`, use a name such as `svchostpassthrough` that suggests that
    `rule` is important for the proper functioning of the system. A sample command
    is shown as follows:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE55]'
  prefs: []
  type: TYPE_PRE
- en: 'Confirm that the change was successfully implemented using the following command:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE56]'
  prefs: []
  type: TYPE_PRE
- en: 'The execution of the previously mentioned commands is shown in the following
    screenshot:'
  prefs: []
  type: TYPE_NORMAL
- en: '![Employing Netcat as a persistent agent](img/3121OS_06_06.jpg)'
  prefs: []
  type: TYPE_IMG
- en: When the port rule is confirmed, ensure that the reboot option works.
  prefs: []
  type: TYPE_NORMAL
- en: 'Enter the following command from the `meterpreter` prompt:'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '[PRE57]'
  prefs: []
  type: TYPE_PRE
- en: 'Enter the following command from an interactive Windows shell:'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '[PRE58]'
  prefs: []
  type: TYPE_PRE
- en: 'To remotely access the compromised system, type `nc` at a command prompt, indicate
    the verbosity of the connection (`-v` reports basic information and `-vv` reports
    much more information), and then enter the IP address of the target and the port
    number, as shown in the following screenshot:'
  prefs: []
  type: TYPE_NORMAL
- en: '![Employing Netcat as a persistent agent](img/3121OS_06_07.jpg)'
  prefs: []
  type: TYPE_IMG
- en: Unfortunately, there are some limitations to using Netcat—there is no authentication
    or encryption of transmitted data, and it is detected by nearly all antivirus
    software.
  prefs: []
  type: TYPE_NORMAL
- en: The lack of encryption can be resolved using **cryptcat**, a Netcat variant
    that uses the Twofish encryption to secure data during transmission between the
    exploited host and the attacker. Twofish encryption, developed by Bruce Schneier,
    is an advanced symmetric block cipher that provides reasonably strong protection
    for encrypted data.
  prefs: []
  type: TYPE_NORMAL
- en: 'To use `cryptcat`, ensure that there is a listener ready and configured with
    a strong password, using the following command:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE59]'
  prefs: []
  type: TYPE_PRE
- en: 'Next, upload `cryptcat` to the compromised system and configure it to connect
    with the listener''s IP address using the following command:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE60]'
  prefs: []
  type: TYPE_PRE
- en: Unfortunately, Netcat and its variants remain detectable by most antivirus applications.
    It is possible to render Netcat undetectable using a hex editor to alter the source
    code of Netcat; this will help avoid triggering the signature matching action
    of the antivirus, but this can be a long trial-and-error process. A more efficient
    approach is to take advantage of the Metasploit Framework's persistence mechanisms.
  prefs: []
  type: TYPE_NORMAL
- en: Maintaining persistence with the Metasploit Framework
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: 'Metasploit''s `meterpreter` contains several scripts that support persistence
    on a compromised system. We will examine two script options for placing a backdoor
    on a compromised system: `metsvc` and `persistence`.'
  prefs: []
  type: TYPE_NORMAL
- en: Using the metsvc script
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: The `metsvc` script is a network service wrapper for `meterpreter` that allows
    it to either be used as a Windows service or run as a command-line application.
    It is typically used as a backdoor to maintain communications with a compromised
    system.
  prefs: []
  type: TYPE_NORMAL
- en: To use `metsvc`, first compromise the system and then migrate `meterpreter`
    to the `explorer.exe` process to obtain a more stable shell.
  prefs: []
  type: TYPE_NORMAL
- en: Execute the `metsvc` agent by invoking the `run` command, as shown in the following
    screenshot. As you can see, it creates a temporary installation directory, uploads
    three files (`metsrv.dll`, `metsvc-server.exe`, and `metsvc.exe`), and then starts
    `metsvc`.
  prefs: []
  type: TYPE_NORMAL
- en: '![Using the metsvc script](img/3121OS_06_08.jpg)'
  prefs: []
  type: TYPE_IMG
- en: To interact with the persistent `metsvc` agent, the attacker opens the Metasploit
    Framework and selects `use exploit/multi/handler` with the payload `windows/metsvc_bind_tcp`,
    as shown in the following screenshot. The other parameters (IP address and port)
    are also set.
  prefs: []
  type: TYPE_NORMAL
- en: '![Using the metsvc script](img/3121OS_06_09.jpg)'
  prefs: []
  type: TYPE_IMG
- en: 'When the `exploit` command is executed, a session is opened directly between
    the two systems, allowing for the escalation of privileges and other functions
    to occur from the `meterpreter` command line. The execution of the `exploit` command
    is shown in the following screenshot:'
  prefs: []
  type: TYPE_NORMAL
- en: '![Using the metsvc script](img/3121OS_06_10.jpg)'
  prefs: []
  type: TYPE_IMG
- en: The `metsvc` script requires no authentication; once the agent is in place,
    it can be used by anyone to gain access to the compromised system. Most attackers
    would not use this without altering the source code such that it requires authentication
    or ensuring that there is some method in place to filter out remote connections.
  prefs: []
  type: TYPE_NORMAL
- en: 'More importantly, it is not a stealthy attack. Any attempt to list running
    processes, such as entering the `ps` command from the `meterpreter` prompt, will
    identify the `metsvc` service and the fact that the executable is running from
    a `Temp` directory—which is very suspicious! In the following screenshot, the
    directory with the random name (CvjrsZWOMK) located in the Temp folder is an obvious
    flag that a system has been compromised:'
  prefs: []
  type: TYPE_NORMAL
- en: '![Using the metsvc script](img/3121OS_06_11.jpg)'
  prefs: []
  type: TYPE_IMG
- en: A simple inspection of the `Temp` folder will identify the three hostile files,
    as shown in the following screenshot; however, these will usually be flagged by
    an antivirus before they are found by manual inspection.
  prefs: []
  type: TYPE_NORMAL
- en: '![Using the metsvc script](img/3121OS_06_12.jpg)'
  prefs: []
  type: TYPE_IMG
- en: Using the persistence script
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: A more effective approach for gaining persistence is to use the `meterpreter`
    prompt's `persistence` script.
  prefs: []
  type: TYPE_NORMAL
- en: After a system has been exploited and the migrate command has moved the initial
    shell to a more secure service, an attacker can invoke the `persistence` script
    from the `meterpreter` prompt.
  prefs: []
  type: TYPE_NORMAL
- en: 'Using `-h` in the command will identify the available options for creating
    a persistent backdoor, as shown in the following screenshot:'
  prefs: []
  type: TYPE_NORMAL
- en: '![Using the persistence script](img/3121OS_06_13.jpg)'
  prefs: []
  type: TYPE_IMG
- en: In the example shown in the following screenshot, we have configured `persistence`
    to run automatically when the system boots and to attempt to connect to our listener
    every 10 seconds. The listener is identified as the remote system (`-r`) with
    a specific IP address and port. Additionally, we could elect to use the `-U` option,
    which will start persistence when a user logs onto the system.
  prefs: []
  type: TYPE_NORMAL
- en: '![Using the persistence script](img/3121OS_06_14.jpg)'
  prefs: []
  type: TYPE_IMG
- en: Note
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: Note that we have arbitrarily selected port 444 for use by persistence; an attacker
    must verify the local firewall settings to ensure that this port is open, or use
    the `reg` command to open the port. Like most Metasploit modules, any port can
    be selected as long as it is not already in use.
  prefs: []
  type: TYPE_NORMAL
- en: The `persistence` script places a VBS file in a temporary directory; however,
    you can use the `-L` option to specify a different location. The script also adds
    that file to the local autorun sections of the registry.
  prefs: []
  type: TYPE_NORMAL
- en: 'Because the `persistence` script is not authenticated and anyone can use it
    to access the compromised system, it should be removed from the system as soon
    as possible after the discovery or completion of penetration testing. To remove
    the script, confirm the location of the resource file for cleanup, and then execute
    the following `resource` command:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE61]'
  prefs: []
  type: TYPE_PRE
- en: Creating a standalone persistent agent with Metasploit
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: The Metasploit Framework can be used to create a stand-alone executable that
    can persist on a compromised system and allow interactive communications. The
    advantage of a stand-alone package is that it can be prepared and tested in advance
    to ensure connectivity and encoded to bypass local antivirus software.
  prefs: []
  type: TYPE_NORMAL
- en: To make a simple stand-alone agent, launch `msfconsole` on a command prompt
    in Kali.
  prefs: []
  type: TYPE_NORMAL
- en: Use `msfpayload` to craft the persistence agent. In the example shown in the
    following screenshot, the agent is configured to use a `reverse_tcp` shell that
    will connect to the local host at `192.168.43.130` on port `4444`. The agent,
    named `attack1.exe`, will use a win32 executable template.
  prefs: []
  type: TYPE_NORMAL
- en: '![Creating a standalone persistent agent with Metasploit](img/3121OS_06_15.jpg)'
  prefs: []
  type: TYPE_IMG
- en: The stand-alone agent will only work on compromised systems with no antivirus
    installed, or if the antivirus has first been disabled using the appropriate `meterpreter`
    command. To bypass the antivirus, the backdoor must be encoded.
  prefs: []
  type: TYPE_NORMAL
- en: 'There are several different options for encoding the payload, as shown in the
    following screenshot:'
  prefs: []
  type: TYPE_NORMAL
- en: '![Creating a standalone persistent agent with Metasploit](img/3121OS_06_16.jpg)'
  prefs: []
  type: TYPE_IMG
- en: To see the available options, use the `show encoders` command.
  prefs: []
  type: TYPE_NORMAL
- en: Metasploit uses approximately 30 different encoders; by default, it will select
    the most appropriate encoder if one is not specified.
  prefs: []
  type: TYPE_NORMAL
- en: A good general encoder to use is `shikata_ga_nai`. This encoder implements polymorphic
    XOR additive feedback encoding against a 4-byte key, and it is the only encoder
    ranked as "excellent" by Metasploit.
  prefs: []
  type: TYPE_NORMAL
- en: 'To encode the previously prepared `attack.exe` agent, we use the following
    command:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE62]'
  prefs: []
  type: TYPE_PRE
- en: This encodes the `attack.exe` agent five times using the `shikata_ga_nai` protocol.
    Each time it is re-encoded, it becomes more difficult to detect. However, the
    executable also increases in size.
  prefs: []
  type: TYPE_NORMAL
- en: 'The full payload can be created directly from the command line in Kali. Not
    only can it be encoded, but we can configure the encoding pattern to avoid certain
    characters. For example, the following characters should be avoided when encoding
    a persistent agent because they may result in discovery and failure of the attack:'
  prefs: []
  type: TYPE_NORMAL
- en: '`\x00` represents a 0-byte address'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '`\xa0` represents a line feed'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '`\xad` represents a carriage return'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: 'To create a multiencoded payload, use the following command:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE63]'
  prefs: []
  type: TYPE_PRE
- en: 'You can also encode `msfpayload` to an existing executable, and both the modified
    executable and the persistent agent will function. To bind the persistent agent
    to an executable such as a calculator (`calc.exe`), first copy the appropriate
    `calc.exe` file into Metasploit''s template folder located at `/usr/share/metasploit-framework/data/templates`.
    When the template is in place, use the following command:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE64]'
  prefs: []
  type: TYPE_PRE
- en: The agent can be placed on the target system, renamed `calc.exe` to replace
    the original calculator, and then executed.
  prefs: []
  type: TYPE_NORMAL
- en: Unfortunately, nearly all Metasploit-encoded executables can be detected by
    client antivirus software. This has been attributed to penetration testers who
    have submitted encrypted payloads to sites such as VirusTotal ([www.virustotal.com](http://www.virustotal.com)).
    However, you can create an executable and then encrypt it using Veil-Evasion,
    as described in [Chapter 4](ch04.html "Chapter 4. Exploit"), *Exploit*.
  prefs: []
  type: TYPE_NORMAL
- en: Redirecting ports to bypass network controls
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: Thus far, we've examined remote control access to the exploited system as if
    we have a direct connection between the victim and the attacker's machines; however,
    such connectivity is frequently controlled or blocked by network devices such
    as a firewall.
  prefs: []
  type: TYPE_NORMAL
- en: Attackers can circumvent these controls using port redirection, which is a designated
    system that listens on defined ports and forwards the raw packets to a specific
    secondary location.
  prefs: []
  type: TYPE_NORMAL
- en: Kali provides several tools that support port redirection, including `nc`, `cryptcat`,
    `socat`, `ssh`, `fpipe`, and Metasploit's `meterpreter`; we'll look at some examples
    in the following sections.
  prefs: []
  type: TYPE_NORMAL
- en: Example 1 – simple port redirection
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: Simple port redirection may be used, for example, if you have compromised a
    system on the exterior of the network in the **Demilitarized Zone** (**DMZ**)
    and need to be able to communicate with an internal system from a remote location.
  prefs: []
  type: TYPE_NORMAL
- en: 'On the compromised system in the DMZ, configure an instance of Netcat to listen
    to incoming commands and forward them to the target using the following command:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE65]'
  prefs: []
  type: TYPE_PRE
- en: This command will invoke Netcat (`nc`) to listen (`-l`) to incoming traffic,
    and execute (`-e`) the transfer of this incoming traffic to the target on port
    `444`. Ports are not fixed and they do not have to be the same on both the listening/forwarding
    host and the final target.
  prefs: []
  type: TYPE_NORMAL
- en: 'If you lack complete information regarding the target''s internal network,
    you may try the following command:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE66]'
  prefs: []
  type: TYPE_PRE
- en: This command sets the local (attacker) instance of Netcat to listen (`-l`) on
    a designated port, and then instructs Netcat to create a new process with each
    new connection (`-c`).
  prefs: []
  type: TYPE_NORMAL
- en: This simple example allows the outsider to connect to the direct network; however,
    it does not permit a bidirectional data connection, which is required for some
    tools.
  prefs: []
  type: TYPE_NORMAL
- en: Example 2 – bidirectional port redirection
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'Consider three separate Windows data systems:'
  prefs: []
  type: TYPE_NORMAL
- en: '[Attacker] | [Forwarder ] | [Target]'
  prefs: []
  type: TYPE_NORMAL
- en: In order to enable a bidirectional communications channel using Netcat, we will
    have to use named pipes. A named pipe, also referred to as FIFO, is a means of
    creating defined interprocess communication; this allows us to handle it as an
    object, making it easier to manage when issuing commands. In the following sample
    attack, we create a named pipe called `reverse` to handle bidirectional communications.
  prefs: []
  type: TYPE_NORMAL
- en: 'The Attacker has an instance of Netcat on his local system set to listen on
    port `6661` using the following command:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE67]'
  prefs: []
  type: TYPE_PRE
- en: 'The Forwarder, a compromised box with an instance of Netcat installed, will
    listen for incoming packets and forward them to the target; it is configured to
    listen on port `6666` using the following command:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE68]'
  prefs: []
  type: TYPE_PRE
- en: 'On the target system, enter the following command to create the named pipe:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE69]'
  prefs: []
  type: TYPE_PRE
- en: 'Then, configure a local instance of Netcat to use that named pipe to establish
    two-way communications across the forwarding system to the Attacker using the
    following command:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE70]'
  prefs: []
  type: TYPE_PRE
- en: 'The same bidirectional data flow can be achieved using `socat`, which is designed
    to implement connections of this type. The command for this example would be executed
    from the target system and use:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE71]'
  prefs: []
  type: TYPE_PRE
- en: Summary
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: In this chapter, we focused on the final stage of the attacker's kill chain—the
    command, control, and communications stage—where the attacker uses a persistent
    agent to communicate with a compromised system.
  prefs: []
  type: TYPE_NORMAL
- en: That concludes the first part of this book where we examined the attacker's
    kill chain in detail to see how it could be applied towards compromising a network
    or an isolated system.
  prefs: []
  type: TYPE_NORMAL
- en: In [Part 2](pt02.html "Part 2. The Delivery Phase"), *The Delivery Phase*, we
    will examine specific applications of the kill chain using various exploit paths.
    In [Chapter 7](ch07.html "Chapter 7. Physical Attacks and Social Engineering"),
    *Physical Attacks and Social Engineering*, we will focus on physical security
    and social engineering attacks. Topics will include an overview of the attack
    methodology, crafting hostile USB devices and rogue microcomputers, the Social
    Engineering Toolkit, and testing the resilience of a system to phishing attacks.
  prefs: []
  type: TYPE_NORMAL
